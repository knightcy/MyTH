!function(){General={};var t=require("./f"),_=t.Framework.Utilities,g=_.loadSingleInstance("sequelizeModel"),d=_.loadSingleInstance("EventBus"),u=t.Framework.Consts,n=u.EventType,T=u.ErrorCode,b=u.ActionStatus,i=require("util"),M=require("fs"),D=require("path"),o=require("sequelize"),a=_.loadSingleInstance("sequelizeModel"),r=t.Framework.Crypto,f=t.Framework.SynServer,s=t.Framework.RTData,l=t.Framework.DataContainer,c=t.Framework.Module,h=(t.Framework.AutoSaveDBModule,t.Framework.EventModule),m=t.Framework.RTDataModule,p=t.Framework.BaseServer,v=require("cron").CronJob;General.Log={};var y={logid:{type:o.STRING,allowNull:!0,defaultValue:""},type:{type:o.STRING,allowNull:!0},content:{type:o.BLOB,allowNull:!0},category:{type:o.STRING,allowNull:!1,defaultValue:"O"},operator:{type:o.STRING,allowNull:!0},createtime:{type:o.DATE,allowNull:!0},operatorip:{type:o.STRING,allowNull:!0},result:{type:o.STRING,allowNull:!0}},w={crontime:{type:o.STRING,allowNull:!1},uuid:{type:o.STRING,unique:!0},prop:{type:o.STRING},status:{type:o.INTEGER,defaultValue:1},func:{type:o.STRING}};a&&(a.registerModel("OperateLog","operatelog",y),a.registerModel("cronTask","crontask",w)),General.Log.Model=a;M=require("fs");var S=require("../visualization/config"),A=require("child_process").exec,I=function(){_.callSuper(I,this,arguments),this._name="log",this.focusedEventArray=[{event:"log_addLogging",onEvent:"on_addLogging"}]};_.extend(I,c,{getExports:function(){return["reqGetLogList","reqGetLogFileList","downloadFileZipManager","getCronTaskDetailManager","updateCronTaskByUuidManager"]},runningOnPlatform:function(e){_.invokeSuper(I,"runningOnPlatform",this,arguments),this.initLogModule(),this._cronTaskFromDB()},getCronTaskDetailManager:function(e,o,t){var a={type:"getCronTaskDetailManager"},n=e.body.uuid;this._getCronTaskFromDB(n,function(e,t){e?(a.error=e,a.status=b.F):(a.status=b.S,a.result={data:t}),o.json(a)})},updateCronTaskByUuidManager:function(e,t,o){var a={type:"updateCronTaskByUuidManager"},n=this,i=e.body,r=i.uuid,s=i.cronTime;r&&s&&(s=s.replace(/\?/g,"*"),g.update("cronTask",{crontime:s},{uuid:r},function(e){a.status=b.S,t.json(a),n._getCronTaskFromDB(r,function(e,t){e?console.log("updateCronTaskByUuidManager"+e):n._cronTaskFromDB([t])})},function(e){a.error=e,a.status=b.F,t.json(a)}))},_getCronTaskFromDB:function(e,o){var t={};e&&(t.uuid=e),g.query("cronTask",{where:t},function(e){var t={};0<e.length&&(t=e[0].dataValues);o(null,t)},function(e){o(e)})},_autoBackupLogFiles:function(){var e=this;f.deleteCronJob("AUTO_BACKUP_FILES_MONTH",function(){f.startSyn({global:e,uuid:"log",prop:"AUTO_BACKUP_FILES_MONTH",time:" 0 0 1 * *",func:e._backupLogFiles})})},_cronTaskFromDB:function(e){var n=this;if(e&&0<e.length)for(var t=0;t<e.length;t++)n._runCronTask(e[t]);else g.query("cronTask",{},function(e){var t=e.length;if(0<t)for(var o=0;o<t;o++){var a=e[o].dataValues;n._runCronTask(a)}},function(e){console.log("_cronTaskFromDB:"+e)})},_runCronTask:function(e){var t=this,o=e.prop+"_"+e.uuid;f.deleteCronJob(o,function(){f.startSyn({global:t,uuid:e.uuid,prop:e.prop,time:e.crontime,func:t[e.func]})})},_backupLogFiles:function(){var e=this._platform._settings.weserviceSettings.log4jsConfig.logpath,t="log-"+_.formatDate(new Date,"yyyy-MM")+"*",o=" cd "+e+" "+(" zip -r ./backup/log/"+("log-backup-"+_.formatDate(new Date,"yyyyMMddhhmmss")+".zip")+" ./"+t);M.existsSync(e+"backup/log/")||M.mkdirSync(e+"backup/log/"),A(o,function(e,t,o){e?console.log(e):console.log("日志备份成功！")})},_backupDB:function(){var e=this._platform._settings.weserviceSettings.log4jsConfig.logpath,t=this._platform._systemConfig.dbConfig.master;M.existsSync(e+"backup/mysql/")||M.mkdirSync(e+"backup/mysql/");var o=" mysqldump -u"+t.user+" -p"+t.password+" "+t.database+" > "+e+"backup/mysql/"+_.formatDate(new Date,"yyyyMMddhhmmss")+"_"+t.database+".sql";A(o,function(e,t,o){e?console.log(e):console.log("数据库备份成功！")})},initLogModule:function(){if(this.focusedEventArray)for(var t=this,e=0;e<this.focusedEventArray.length;e++){!function(e){d.subscribe(e.event,function(){t[e.onEvent].apply(t,arguments)})}(this.focusedEventArray[e])}},on_addLogging:function(e){var t={logid:_.getGUID(20),type:e.type,content:e.content,operator:e.operator,category:e.category,createtime:new Date,operatorip:e.operatorip,result:e.result};return g.seq.transaction(function(e){return g.insertWithTrans("OperateLog",t,e)}).then(function(e){}).catch(function(e){console.error("log error: "+JSON.stringify(e.message))}),!0},reqGetLogList:function(e,a,t){var n={action:"reqGetLogList"},o=e.body,i=(e.session.user,(o=_._handleDatatableSettings(o,["category","startTime","endTime","operator"])).start),r=o.length,s=o.category,l=o.startTime,u=o.endTime,c=o.operator,d=" select * from operatelogs where 1 = 1 ",f="select count(*) as count from operatelogs where 1 = 1 ",h={},m={};s&&(d+=" and category = :category ",h.category=s,f+=" and category = :category ",m.category=s),l&&(d+=" and createtime >=:START_TIME ",h.START_TIME=l,f+=" and createtime >=:START_TIME ",m.START_TIME=l),u&&(d+=" and createtime <=:END_TIME ",h.END_TIME=u,f+=" and createtime >=:END_TIME ",m.END_TIME=u),c&&(d+=" and operator =:OPERATOR ",h.OPERATOR=c,f+=" and operator >=:OPERATOR ",m.OPERATOR=c),d+=" order by createtime desc ",_.isNull(i)||_.isNull(r)||(d+=" limit :Start , :Length",h.Start=i,h.Length=r),g.queryFromSql(f,m,function(o){g.queryFromSql(d,h,function(e){for(var t=0;t<e.length;t++)e[t].createtime=_.formatDate(e[t].createtime,"yyyy-MM-dd hh:mm:ss"),e[t].content=e[t].content.toString("utf-8");n.status=b.S,n.result={data:e,length:o[0].count},a.json(n)},function(e){n.status=b.F,n.error=e,a.json(n)})},function(e){n.status=b.F,n.error=e,a.json(n)})},reqGetLogFileList:function(e,i,t){var r={type:"reqGetLogFileList"},o=this._platform._settings.weserviceSettings.log4jsConfig.logpath;o?M.readdir(o,function(e,t){if(e)r.error=e,r.status=b.F,i.json(r);else if(t.length<=0)r.result={data:[]},r.status=b.S,i.json(r);else{for(var o=[],a=0;a<t.length;a++){var n=t[a];0<n.indexOf(".txt")&&o.push(n)}r.result={data:o},r.status=b.S,i.json(r)}}):(r.error="Empty log Files",r.status=b.F,i.json(r))},downloadFileZipManager:function(e,a,t){var n={type:"downloadFileZipManager"},i=this,o=e.body;o=_._handleDatatableSettings(o,["fileNameList"]);var r=this._platform._settings.weserviceSettings.log4jsConfig.logpath,s=o.fileNameList;if(s&&0<s.length){var l=" cd "+r,u=_.formatDate(new Date,"yyyyMMddhhmmss")+".zip ",c=S.url,d=" zip -r ../../public/downloads/"+u;s.forEach(function(e){d=d+" ./"+e}),A(l+" && "+d,function(e,t,o){e?(n.error=e,n.status=b.F):(n.result={downloadURL:i._platform._settings.weserviceSettings.httpOption.type+"://"+c+"/downloads/"+u},n.status=b.S),a.json(n)})}}}),General.Log.Module=I,General.Alarm={};var k=function(){this.timeoutID=void 0,this._name="alarm",this.alarmCache={},_.callSuper(k,this,arguments)};_.extend(k,c,{getExports:function(){return["checkAlarms","addAlarms"]},checkAlarms:function(){var t=this.alarmCache;for(var o in t){var a=t[o],e=a.concat(),n=a.length;e&&0<e.length&&(_.log("AlarmServerModule prepare to store events:"+JSON.stringify(cachedEvents)),g.batchInsert(o,e,function(e){t[o]=a.slice(n)},function(e){console.log(e.message)}))}var i=this;this.timeoutID=setTimeout(function(){i.checkAlarms()},5e3)},addAlarms:function(e,t,o,a){i.isArray(events)||(events=[events]);var n=this.alarmCache[e];n||(n=[]),this.alarmCache[e]=n.concat(t.concat()),o&&o(t)},runningOnPlatform:function(e){_.invokeSuper(k,"runningOnPlatform",this,arguments);var o=this;this.timeoutID=setTimeout(function(){o.checkAlarms()},5e3),d.subscribe("AlarmsOccur",function(e,t){o.addEvents(e,t)});var t={logid:_.getGUID(20),type:"runningOnPlatform",content:JSON.stringify({module:"alarm"}),category:"1",operator:null,createtime:new Date,operatorip:"172.0.0.1",result:"SUCCESS"};d.fireEvent("log_addLogging",t),console.log(JSON.stringify(t))}}),General.Alarm.Module=k,General.SMS={};var N=require("ali-sms"),E={accessKeyID:"i681uNjHVWSz20Fg",accessKeySecret:"gKMxIRxl1falXVSsfIvvTu0VL10HIR"};General.SMS.AliyunSendSMS=function(e,o){var t=_.copySimpleObject(E,{}),a=[];e.param||a.push("param required!"),Array.isArray(e.phones)||a.push("phones array required!"),e.sign||a.push("SMS sign required!"),e.templateCode||a.push("SMS templateCode required!"),0<a.length?o&&o(null,a):(t.paramString=e.param,t.recNum=e.phones,t.signName=e.sign,t.templateCode=e.templateCode,N(t,function(e,t){e?o&&o(null,e):o&&o("success")}))};var R=require("crypto"),G={hash:function(e,t,o){var a=R.createHash(e),n=Buffer.isBuffer(t);return n||"object"!=typeof t||(t=JSON.stringify(sortObject(t))),a.update(t,n?"binary":"utf8"),a.digest(o||"hex")},md5:function(e,t){return G.hash("md5",e,t)},YYYYMMDDHHmmss:function(e,t){(e=e||new Date)instanceof Date||(e=new Date(e));var o="-",a=":";t&&(t.dateSep&&(o=t.dateSep),t.timeSep&&(a=t.timeSep));var n=e.getDate();n<10&&(n="0"+n);var i=e.getMonth()+1;i<10&&(i="0"+i);var r=e.getHours();r<10&&(r="0"+r);var s=e.getMinutes();s<10&&(s="0"+s);var l=e.getSeconds();return l<10&&(l="0"+l),e.getFullYear()+o+i+o+n+" "+r+a+s+a+l},checkRequired:function(e,t){Array.isArray(t)||(t=[t]);for(var o=0,a=t.length;o<a;o++){var n=t[o];if(!e.hasOwnProperty(n)){var i=new Error("`"+n+"` required");return i.name="ParameterMissingError",i}}},getApiResponseName:function(e){return e.match("^taobao")&&(e=e.substr(7)),e.replace(/\./g,"_")+"_response"}};General.SMS.Crypto=G;var F=require("urllib"),q=General.SMS.Crypto;function C(e){if(!(this instanceof C))return new C(e);if(!(e=e||{}).appkey||!e.appsecret)throw new Error("appkey or appsecret need!");this.REST_URL=e.REST_URL||"http://gw.api.taobao.com/router/rest",this.appkey=e.appkey,this.appsecret=e.appsecret}C.prototype.invoke=function(e,t,n,i,o,r){t.method=e,this.request(t,o,function(e,t){if(e)return r(e);var o=t;if(n&&0<n.length)for(var a=0;a<n.length;a++){if(void 0===(o=o[n[a]]))break}void 0===o&&(o=i),r(null,o)})},C.prototype._wrapJSON=function(e){var t=e.match(/\"id\"\:\s?\d{16,}/g);if(t)for(var o=0;o<t.length;o++){var a=t[o];e=e.replace(a,'"id":"'+a.split(":")[1].trim()+'"')}return e};var O={"isv.user-not-exist:invalid-nick":1};C.prototype.request=function(e,t,i){"function"==typeof t&&(i=t,t=null);var o=q.checkRequired(e,"method");if(o)return i(o);var a={timestamp:this.timestamp(),format:"json",app_key:this.appkey,v:"2.0",sign_method:"md5"};for(var n in e)"object"==typeof e[n]?a[n]=JSON.stringify(e[n]):a[n]=e[n];a.sign=this.sign(a);var r={type:t=t||"GET",data:a,agent:this.agent},s=this;F.request(s.REST_URL,r,function(t,o){var a;if(o){o=s._wrapJSON(o.toString());try{a=JSON.parse(o)}catch(e){(t=e).data=o.toString(),a=null}}var e=a&&a.error_response;if(e&&(!e.sub_msg||!O[e.sub_code])){var n=e.msg+", code "+e.code;e.sub_msg&&(n+="; "+e.sub_code+": "+e.sub_msg),(t=new Error(n)).name="TOPClientError",t.code=e.code,t.sub_code=e.sub_code,t.data=o.toString(),a=null}i(t,a)})},C.prototype.timestamp=function(){return q.YYYYMMDDHHmmss()},C.prototype.sign=function(e){for(var t=Object.keys(e).sort(),o=this.appsecret,a=0,n=t.length;a<n;a++){var i=t[a];o+=i+e[i]}return o+=this.appsecret,q.md5(o).toUpperCase()},C.prototype.execute=function(e,t,o){this.invoke(e,t,[q.getApiResponseName(e)],null,"POST",o)},C.prototype.sendSMSText=function(e,t){var o={extend:"",sms_type:"normal",sms_free_sign_name:e.sign,sms_param:e.contents,rec_num:e.phone,sms_template_code:e.template};this.execute("alibaba.aliqin.fc.sms.num.send",o,t)},General.SMS.TopClient=C;var C=General.SMS.TopClient,x={appkey:"23467660",appsecret:"408b63c9ba3636d3211b0e145151c51a",REST_URL:"http://gw.api.taobao.com/router/rest"},W=function(){_.callSuper(W,this,arguments),this._name="sms"};_.extend(W,c,{getExports:function(){return["getAuthCode"]},init:function(){this.option=x},loadModuleSettings:function(e){e&&e.option&&(this.option=e.option)},sendSMS:function(e,t){var o=new C(this.option);e.sign=e.sign?e:this.option.sign,o.sendSMSText(e,t)},getAuthCode:function(o,a,e){var t=o.body,n={type:"getAuthCode"},i=Math.floor(999999*Math.random());5==(i=i.toString()).length&&(i+="0");var r={code:i};this.sendSMS({contents:{code:r.code,phone:t.phone},phone:t.phone,template:"SMS_39930090"},function(e,t){e?n.status=Status.F:(o.session.code=i,n.status=Status.S),a.json(n)})}}),General.SMS.Module=W,General.Auth={};var j={roleid:{type:o.STRING,allowNull:!1,unique:!0},name:{type:o.STRING,allowNull:!1,unique:!0},desc:o.STRING,value:{type:o.STRING,allowNull:!1}},P={rolegroupid:{type:o.STRING,allowNull:!1,unique:!0},name:{type:o.STRING,allowNull:!1,unique:!0},desc:o.STRING,value:{type:o.STRING,allowNull:!1}},L={roletouserid:{type:o.STRING,allowNull:!1,unique:!0},rolegroupid:{type:o.STRING,allowNull:!1},userid:{type:o.STRING,allowNull:!1}},B={roletomenuid:{type:o.STRING,allowNull:!1,unique:!0},roleid:{type:o.STRING,allowNull:!1},menuinfo:{type:o.STRING(2e3),allowNull:!1}},U={apiid:{type:o.STRING,allowNull:!1,unique:!0},api:{type:o.STRING,allowNull:!1},module:{type:o.STRING,allowNull:!1},value:{type:o.STRING,allowNull:!1},api_name:{type:o.STRING,allowNull:!0},api_desc:{type:o.STRING,allowNull:!0},status:{type:o.ENUM,allowNull:!1,values:["0","1"]}},J={companyid:o.STRING,aid:{type:o.STRING,allowNull:!1,unique:!0},name:o.STRING,email:o.STRING,cellphone:{type:o.STRING},pwd:{type:o.STRING,allowNull:!1},verification:{type:o.BOOLEAN,allowNull:!1},rolename:o.STRING,createtime:o.DATE,position:{type:o.STRING}},z={appkey:{type:o.STRING,allowNull:!1,unique:!0},aid:{type:o.STRING,allowNull:!1}},V={employeeid:{type:o.STRING,allowNull:!1,unique:!0},name:o.STRING,cellphone:{type:o.STRING},chiefid:o.STRING,account:{type:o.STRING,allowNull:!0,default:""},email:{type:o.STRING},companyid:{type:o.STRING},picture:{type:o.BLOB("medium")}},Q={key:{type:o.STRING,allowNull:!1,primaryKey:!0},time:{type:o.DATE},user:{type:o.STRING,allowNull:!1},ip:{type:o.STRING},rolevalue:{type:o.STRING},refreshtime:{type:o.BIGINT},activetime:{type:o.BIGINT}},H={ip:{type:o.STRING,allowNull:!1,unique:!0},comments:{type:o.STRING}};a&&(a.registerModel("Role","role",j),a.registerModel("RoleGroup","rolegroup",P),a.registerModel("RoleGroupToAccount","rolegrouptoaccount",L),a.registerModel("RoleToMenu","roletomenu",B),a.registerModel("Authorization","authorization",U),a.registerModel("Account","account",J),a.registerModel("AppKey","appkey",z),a.registerModel("Employee","employee",V),a.registerModel("Token","token",Q),a.registerModel("AvaliableIp","avalia_ip",H)),General.Auth.Model=a;var K=function(e){this.lockUserInfo={},this.lockUserNum=5,this.unlockTime=3e5,this._config={}};_.extend(K,Object,{storeConfig:function(e){var t="Account";e&&e.accountModel&&(t=e.accountModel),this._config.accountModel=t},isValidated:function(t,o,a){var n=this._config.accountModel,i=this;if(n){var r=t.aid?t.aid:t.user,e=i.lockUserInfo[r];if(e&&e.lockTime){if(!((new Date).getTime()-new Date(e.lockTime).getTime()>=i.unlockTime))return void a({errorcode:"100006"});i.lockUserInfo[r]=null,delete i.lockUserInfo[r]}t.openid?g.query(n,{where:{aid:t.user}},function(e){1==e.length?(o(e),i.lockUserInfo[r]=null,delete i.lockUserInfo[r]):a({errorcode:"100001"})},function(e){a({errorcode:"100002"})}):g.query(n,{where:t},function(e){1==e.length?(o(e),i.lockUserInfo[r]=null,delete i.lockUserInfo[r]):(a({errorcode:"100001"}),g.query(n,{where:{aid:t.aid}},function(e){1==e.length&&(i.lockUserInfo[t.aid]?(i.lockUserInfo[t.aid].num++,i.lockUserInfo[t.aid].num==i.lockUserNum&&(i.lockUserInfo[t.aid].lockTime=new Date)):i.lockUserInfo[t.aid]={num:1})},function(e){}))},function(e){a({errorcode:"100002"})})}},addUser:function(t,o,a,n){var i=this._config.accountModel;g.query(i,{where:{name:t.name}},function(e){1==e.length?o({errorcode:"200001"}):g.insert(i,t,function(e){e?a():n()},function(e){n()})})},loadUser:function(t,e){var o=this._config.accountModel;g.query(o,{},function(e){t(e)},function(){e()})},removeUser:function(){},updateUserRole:function(){},approveUser:function(t,o,a,n){var i=this._config.accountModel;g.query(i,{where:{cellphone:t.phone}},function(e){1==e.length&&g.update(i,{verification:t.verification},o,function(){a()},function(){n()})},function(){n()})}}),General.Auth.Authentication=K;U=function(e){this._roles={admin:{name:"admin",value:1,roleid:"admin",desc:"Admin"},common:{name:"common",value:2,roleid:"common",desc:"Common user"}},this._roleGroups={administrator:{name:"administrator",value:3,rolegroupid:"administrator",desc:"Administrator"}},this.rolesCount=1,this._apiWeight={},this._platform=e};_.extend(U,Object,{initAuthorizations:function(e){(this._platform=e)._settings.moduleSettings.auth.roles&&(this._roles=e._settings.moduleSettings.auth.roles,this.rolesCount=Object.getOwnPropertyNames(this._roles).length-1);var t=e.getCapabilities(),o=[];for(var a in t)for(var n=t[a],i=0;i<n.length;i++){var r={module:a};r.api=n[i],r.api_name=n[i],r.api_desc=n[i],o.push(r)}var s=this;s.loadRoleDefine(function(){_.log("loadRoleDefine init success"),s.loadRoleGroupDefine(function(){d.fireEvent("initRoleGroupDefine"),_.log("loadRoleGroupDefine init success"),s.loadAuthorizationDefine(o,function(){_.log("loadAuthorizationDefine init success")},function(e){_.log("loadAuthorizationDefine init failed:"+e.message)})},function(e){_.log("loadRoleGroupDefine init failed:"+e.message)})},function(e){_.log("loadRoleDefine init failed:"+e.message)})},storeConfig:function(e){this.config.accountTable=e.accountTable,this.config.accountModel=e.accountModel},insertRoles:function(e,s,l){for(var t=[],u=this._platform._settings.moduleSettings.auth.roleMenu,o=0;o<e.length;o++){var a={};_.copySimpleObject(e[o],a),a.value=a.value+"",t.push(a)}g.batchInsert("Role",t,function(t){if(s){for(var e=[],o=0;o<t.length;o++){var a=t[o].roleid,n=u?u[a]:null;if(n)for(var i=0;i<n.length;i++){var r={roletomenuid:_.getGUID(12,62),roleid:t[o].roleid,menuinfo:JSON.stringify(n[i])};e.push(r)}else e.push({roletomenuid:_.getGUID(12,62),roleid:t[o].roleid,menuinfo:""})}g.batchInsert("RoleToMenu",e,function(e){s&&s(t)},function(e){_.wrapDBErrorAction({type:"insertRoles - insertRoleToMenu"},e),l&&l(e)})}},function(e){_.wrapDBErrorAction({type:"insertRoles"},e),l&&l(e)})},updateRole:function(e,t,o,a){var n={};_.copySimpleObject(e,n),n.value=n.value+"",g.update("Role",e,t,function(e){o&&o(e)},function(e){_.wrapDBErrorAction({type:"updateRole"},e),a&&a(e)})},deleteRole:function(t,o,a){g.delete("Role",t,function(e){g.delete("RoleToMenu",t,function(e){o&&o(e)},function(e){_.wrapDBErrorAction({type:"deleteRole - deleteRoleToMenu"},e),a&&a(e)})},function(e){_.wrapDBErrorAction({type:"deleteRole"},e),a&&a(e)})},insertRoleGroups:function(e,t,o){for(var a=[],n=0;n<e.length;n++){var i={};_.copySimpleObject(e[n],i),i.value=i.value+"",a.push(i)}g.batchInsert("RoleGroup",a,function(e){t&&t(e)},function(e){_.wrapDBErrorAction({type:"insertRoleGroups"},e),o&&o(e)})},updateRoleGroup:function(e,t,o,a){var n={};_.copySimpleObject(e,n),n.value=n.value+"",g.update("RoleGroup",e,t,function(e){o&&o(e)},function(e){_.wrapDBErrorAction({type:"updateRoleGroup"},e),a&&a(e)})},deleteRoleGroup:function(e,t,o){g.delete("RoleGroup",e,function(e){t&&t(e)},function(e){_.wrapDBErrorAction({type:"deleteRoleGroup"},e),o&&o(e)})},insertAuthorizations:function(e,t,o){for(var a=[],n=0;n<e.length;n++){var i={};_.copySimpleObject(e[n],i),i.value=i.value+"",a.push(i)}g.batchInsert("Authorization",a,function(e){t&&t(e)},function(e){_.wrapDBErrorAction({type:"insertAuthorizations"},e),o&&o(e)})},loadRoleDefine:function(n,i){var r=this;g.query("Role",{},function(e){var t=e.length;if(0<t){r._roles={},r.rolesCount=t-1;for(var o=0;o<t;o++)e[o]=e[o].dataValues,e[o].value=parseInt(e[o].value),r._roles[e[o].roleid]=e[o];n&&n()}else{for(var a in r._roles)e.push(r._roles[a]);r.insertRoles(e,function(){n&&n()},function(e){i&&i(e)})}},function(e){i&&i(e),_.wrapDBErrorAction({type:"loadRoleDefine"},e)})},loadRoleGroupDefine:function(n,i){var r=this;g.query("RoleGroup",{},function(e){var t=e.length;if(0<t){r._roleGroups={};for(var o=0;o<t;o++)e[o]=e[o].dataValues,e[o].value=parseInt(e[o].value),r._roleGroups[e[o].rolegroupid]=e[o];n&&n()}else{for(var a in r._roleGroups)e.push(r._roleGroups[a]);r.insertRoleGroups(e,function(){n&&n()},function(e){i&&i(e)})}},function(e){i&&i(e),_.wrapDBErrorAction({type:"loadRoleGroupDefine"},e)})},loadAuthorizationDefine:function(s,l,u){var c=this;g.query("Authorization",{},function(e){var t=e.length,o=s.length,a=[];if(0<t){for(var n=0;n<o;n++){for(var i=0;i<t&&(e[i].api!=s[n].api||e[i].module!=s[n].module);i++);if(i==t){var r={api:s[n].api,value:1,apiid:_.getTimeGUID(new Date,12),module:s[n].module,api_name:s[n].api_name,api_desc:s[n].api_desc};c._apiWeight[r.apiid]=r,a.push(r)}}for(n=0;n<t;n++){r={api:e[n].api,value:parseInt(e[n].value),apiid:e[n].apiid,module:e[n].module,api_name:e[n].api_name,api_desc:e[n].api_desc};c._apiWeight[r.apiid]=r}0<a.length?c.insertAuthorizations(a,function(){l&&l()},function(e){u&&u(e)}):l&&l()}else{for(n=0;n<o;n++){r={api:s[n].api,value:1,apiid:_.getTimeGUID(new Date,12),module:s[n].module,api_name:s[n].api_name,api_desc:s[n].api_desc};c._apiWeight[r.apiid]=r,a.push(r)}c.insertAuthorizations(a,function(){l&&l()},function(e){u&&u(e)})}},function(e){u&&u(e),_.wrapDBErrorAction({type:"loadRoleDefine"},e)})},unloadAuthorizationByModule:function(t,o,a){var n=this;g.delete("Authorization",{module:t},function(){for(var e in n._apiWeight)n._apiWeight[e].module==t&&(n._apiWeight[e]=null,delete n._apiWeight[e]);o&&o()},function(e){a&&a(e)})},_getRoleGroupInfoFromRoleName:function(e,t){var o;for(var a in this._roleGroups){var n=this._roleGroups[a];n.name==e&&(o=n)}t(o)},addRole:function(e,t){var o={};for(var a in this._roles)o[this._roles[a].name]=this._roles[a];if(_.isNull(o[e])){this.rolesCount++;var n={name:e,value:Math.pow(2,this.rolesCount),roleid:_.getTimeGUID(new Date,12),desc:e},i=this;this.insertRoles([n],function(){i._roles[n.roleid]=n,t&&t({status:!0})},function(e){t&&t({status:!1,error:e.message})})}else t({status:!1,error:"Role name has been register!"})},addRoleNameAndDesc:function(e,t,o){var a={};for(var n in this._roles)a[this._roles[n].name]=this._roles[n];var i=_.getTimeGUID(new Date,12);if(_.isNull(a[e])){this.rolesCount++;var r={name:e,value:Math.pow(2,this.rolesCount),roleid:i,desc:t},s=this;this.insertRoles([r],function(){s._roles[r.roleid]=r,o&&o({status:!0,error:null,roleId:i,value:r.value})},function(e){o&&o({status:!1,error:e,roleId:null})})}else o({status:!1,error:"Role name has been register!"})},updateRoleInfo:function(e,t,o){if(_.isNull(this._roles[e]))o({status:!1,error:"A Data Error has been occured in this Role data!"});else{var a={};for(var e in this._roles)a[this._roles[e].name]=this._roles[e];if(_.isNull(a[t])){var n=this._roles[e],i=this;this.updateRole({name:t},{roleid:e},function(){n.name=t,i._roles[n.roleid]=n,o&&o({status:!0})},function(e){o&&o({status:!1,error:e.message})})}else o({status:!1,error:"Role name has been register!"})}},updateRoleInfoWithDesc:function(e,t,o,a){if(_.isNull(this._roles[e]))a({status:!1,error:"A Data Error has been occured in this Role data!"});else{var n={};for(var e in this._roles)n[this._roles[e].name]=this._roles[e];var i=this._roles[e],r=this;this.updateRole({desc:o},{roleid:e},function(){i.name=t,i.desc=o,r._roles[i.roleid]=i,a&&a({status:!0,value:i.value})},function(e){a&&a({status:!1,error:e})})}},deleteRoleInfo:function(e,t){if(_.isNull(this._roles[e]))t({status:!1,error:"role data error!"});else{var o=this._roles[e],a=this;this.deleteRole({roleid:e},function(){a.removeAllMethodFromRole(e),a._roles[o.roleid]=null,delete a._roles[o.roleid],a.rolesCount--,t&&t({status:!0})},function(e){t&&t({status:!1,error:e.message})})}},addRoleGroup:function(e,t){var o={};for(var a in this._roleGroups)o[this._roleGroups[a].name]=this._roleGroups[a];if(_.isNull(o[e])){var n={name:e,value:0,rolegroupid:_.getTimeGUID(new Date,12),desc:e},i=this;this.insertRoleGroups([n],function(){i._roleGroups[n.rolegroupid]=n,t&&t({status:!0})},function(e){t&&t({status:!1,error:e.message})})}else t({status:!1,error:"RoleGroup name has been register!"})},updateRoleGroupInfo:function(e,t,o){if(_.isNull(this._roleGroups[e]))o({status:!1,error:"A Data Error has been occured in this RoleGroup data!"});else{var a={};for(var n in this._roleGroups)a[this._roleGroups[n].name]=this._roleGroups[n];if(_.isNull(a[t])){var i=this._roleGroups[e],r=this;this.updateRoleGroup({name:t},{rolegroupid:e},function(){i.name=t,r._roleGroups[i.rolegroupid]=i,o&&o({status:!0})},function(e){o&&o({status:!1,error:e.message})})}else o({status:!1,error:"RoleGroup name has been register!"})}},deleteRoleGroupInfo:function(e,t){if(_.isNull(this._roleGroups[e]))t({status:!1,error:"rolegroup data error!"});else{var o=this._roleGroups[e],a=this;this.deleteRoleGroup({rolegroupid:e},function(){a._roleGroups[o.rolegroupid]=null,delete a._roleGroups[o.rolegroupid],t&&t({status:!0})},function(e){t&&t({status:!1,error:e.message})})}},addRole2RoleGroup:function(e,t,o){var a=this._roleGroups[t],n=this,i=parseInt(a.value)|parseInt(e);this.updateRoleGroup({value:i+""},{rolegroupid:t},function(){a.value=i+"",n._roleGroups[a.rolegroupid]=a,o&&o({status:!0})},function(e){o&&o({status:!1,error:e.message})})},removeRole2RoleGroup:function(e,t,o){var a=this._roleGroups[t],n=this,i=parseInt(a.value)-parseInt(e);this.updateRoleGroup({value:i+""},{rolegroupid:t},function(){a.value=i+"",n._roleGroups[a.rolegroupid]=a,o&&o({status:!0})},function(e){o&&o({status:!1,error:e.message})})},getRolesFormRoleGroup:function(e){var n=[],i=[],r=[],s=[],l=[],u=this;return e&&(Array.isArray(e)||(e=[e]),e.forEach(function(e){var t=e.rolegroupid?e.rolegroupid:e,o=u._roleGroups[t];for(var a in s.push(t),l.push(o.name),u._roles)0!=(u._roles[a].value&o.value)&&-1==i.indexOf(a)&&(n.push(u._roles[a]),i.push(a),r.push(u._roles[a].name))})),{roles:n,roleIds:i,roleNames:r,roleGroupIds:s,roleGroupNames:l}},getAuthorizationMessage:function(e,t){var o=this._apiWeight,a=[],n=this._roles[e],i=this._roles[t];for(var r in o)e&&n?0!=(n.value&o[r].value)&&a.push(o[r]):t&&i?0==(i.value&o[r].value)&&a.push(o[r]):a.push(o[r]);return a},addMethod2Role:function(e,t,o,a){var n=this._roles[e];return this.updateApiValue(t,n.value,"add",o,a)},addMethod2RoleFromRoleId:function(e,t,o,a){var n=this._roles[t],i=this._roles[e];for(var r in this._apiWeight)0!=(this._apiWeight[r].value&n.value)&&this.updateApiValue(r,i.value,"add")},removeMethodFromRole:function(e,t){var o=this._roles[e];0!=(this._apiWeight[t].value&o.value)&&this.updateApiValue(t,o.value,"remove")},removeAllMethodFromRole:function(e,t,o){var a=this._roles[e],n=this._apiWeight;for(var i in n){var r=n[i];0!=(r.value&a.value)&&(r.value=r.value-a.value,g.update("Authorization",r,{apiid:r.apiid},function(e){t&&t(r)},function(e){_.wrapDBErrorAction({type:"removeMethodFromRole"},e),o&&o(e)}))}},updateApiValue:function(e,t,o,a,n){if(_.isPowerOf2(t)){var i=this._apiWeight[e];_.isNull(i.value)&&(i.value=1),"add"==o?i.value=i.value|t:0!=(i.value&t)&&(i.value=i.value-t),g.update("Authorization",i,{apiid:i.apiid},function(e){a&&a(i)},function(e){_.wrapDBErrorAction({type:"updateApiValue"},e),n&&n(e)})}else n&&n("value is not in PowerOf2")},isAuthorized:function(e,t,o){var a,n=this._apiWeight;for(var i in n){var r=n[i];if(r.api==e&&r.module==t){a=r.value;break}}return!_.isNull(a)&&0!=(o&a)},getRoleMessage:function(e,t,o){var a=this._roles,n=[];for(var i in a){if("admin"==i){if(!o)continue;if(0==(o&a[i].value))continue}e?-1<a[i].name.indexOf(e)&&(t&&i==t||n.push(a[i])):t&&i==t||n.push(a[i])}return n},getRoleKeyFromRoleid:function(e){if(e){Array.isArray(e)||(e=[e]);for(var t=this._roles,o=0,a=0;a<e.length;a++)for(var n in t)t[n].roleid==e[a]&&(o|=t[n].value);return o}return null},getRoleGroupsInfo:function(e,t,o){var a=this._roleGroups,n=[],i=0!=(o&this._roles.admin.value);if(t&&(Array.isArray(t)||(t=[t])),i)for(var r in a){var s=a[r];if(e){if(-1<s.name.indexOf(e)){if(t&&-1<t.indexOf(r))continue;n.push(s)}}else{if(t&&-1<t.indexOf(r))continue;n.push(s)}}else for(var r in a){if(((s=a[r]).value&o)==s.value)if(e){if(-1<s.name.indexOf(e)){if(t&&-1<t.indexOf(r))continue;n.push(s)}}else{if(t&&-1<t.indexOf(r))continue;n.push(s)}}return n},getRoleMenueByRoleId:function(l,u){var c=this,d=[],e=c.judgeAdminAndCommon(l);"admin"==e&&((d=c._platform._settings.moduleSettings.auth.roleMenu[e])||(d=[])),g.queryFromSql("select menuinfo from roletomenus where roleid in (:allroleids)",{allroleids:l},function(e){for(var t=0;t<e.length;t++)if(e[t].menuinfo){var o=JSON.parse(e[t].menuinfo);d=d.concat(o)}if(d.length&&e.length){e=[d[0]];d.splice(0,1);var a=c.unionRoleMenue(e,d),n=c.sortFatherRoleMenue(a,"path");for(t=0;t<n.length;t++)if(n[t].children){var i=n[t].children;n[t].children=c.sortFatherRoleMenue(i,"path")}a=c.sortChildrenForMenus(a),u&&u(null,a)}else{var r=c.judgeAdminAndCommon(l),s=c._platform._settings.moduleSettings.auth.roleMenu[r];u(null,r&&s?s:[])}},function(e){u(e)})},unionRoleMenue:function(e,t){for(var o=0;o<t.length;o++){for(var a=t[o],n=!0,i=0;i<e.length;i++)if(e[i].path==a.path){if(n=!1,e[i].children){var r=e[i].children,s=a.children,l=this.unionRoleMenue(r,s);e[i].children=l}break}n&&e.push(t[o])}return e},sortFatherRoleMenue:function(e,t){for(var o=[],a=0;a<e.length;a++)o.push(e[a][t]);for(var n=[],i=0;i<o.length;){for(a=0;a<e.length;a++){var r=o[i];e[a].path&&-1<e[a].path.indexOf(r)&&n.push(e[a])}i++}return n},compare:function(e,t){var o=e.order,a=t.order;return o<a?-1:a<o?1:0},sortChildrenForMenus:function(e){e.sort(this.compare);for(var t=0;t<e.length;t++){var o=e[t].children;o&&(e[t].children=this.sortChildrenForMenus(o))}return e},judgeAdminAndCommon:function(e){for(var t=0;t<e.length;t++)if("admin"==e[t])return"admin";return 1==e.length&&"common"==e[0]&&"common"},getMenuPage:function(e,t,s){var o={RoleId:e},a=this._apiWeight,l=[],n=this._roles[e],i=this._roles[t];for(var r in a)e&&n?0!=(n.value&a[r].value)&&l.push(a[r]):t&&i?0==(i.value&a[r].value)&&l.push(a[r]):l.push(a[r]);g.queryFromSql("select * from roletomenupages where roleid =:RoleId ",o,function(e){if(0<e.length){for(var t=JSON.parse(e[0].menuinfo),o=[],a=0;a<t.length;a++)for(var n=t[a].listItems,i=0;i<n.length;i++){var r=n[i].itemsName;o.push(r)}s({page:o,authorizationMessages:l})}s({authorizationMessages:l})})},addRoleToMenuPage:function(e){var t=[];for(var o in e){var a={roleid:o,menuinfo:JSON.stringify(e[o])};t.push(a)}g.seq.transaction(function(e){return g.deleteWithTrans("RoleToMenuPage",{},e).then(function(){return g.batchInsertWithTrans("RoleToMenuPage",t,e)})})},deleteRoleToMenuPage:function(t){g.seq.transaction(function(e){return g.deleteWithTrans("RoleToMenuPage",{roleid:t},e)})},getSettings:function(e,a){g.queryFromSql("select * from settings",{},function(e){if(0<e.length){var t=e[0].value.toString("utf-8"),o=JSON.parse(t).auth;a(o)}else a(null)},function(e){a(e)})}}),General.Auth.Authorization=U;var Y=function(e){this._tcs={},this._epms=e,this.autoCheckToken()};_.extend(Y,Object,{generateTokenKey:function(e,t,o){e||(e=_.formatDate(new Date,"yyyyMMddhhmmss"));var a=e+"-"+t+"-"+o;return r.encrypteWithPWD({plainText:a})},isValidatedToken:function(e,a,n){"function"==typeof a&&(n=a);this.getTokenFromDB(e,function(e,t){if(e)n(e);else if(t){var o=t.ip;n(null,a===o)}else n(null,!1)})},isValidatedTokenUser:function(e,a,n){"function"==typeof a&&(n=a);this.getTokenFromDB(e,function(e,t){if(e)n(e);else{var o=t.ip;n(null,{result:o===a,tokenValue:t})}})},cacheToken:function(e,o){this.cacheTokenToDB(e,function(e,t){e?o(e):o(null,t)})},upadteTokenByKey:function(e){return this.updateToken(this._tcs[e])},updateToken:function(e){if(!e)return null;var t,o=e.key,a=new Date,n=a.getTime(),i=e.refreshTime;if(i){if(0<=a-i){var r=new Date;e.refreshTime=r.DateAdd("m",30).getTime(),t=this.generateTokenKey(n,e.ip,e.user),e.key=t,cache[t]=e,delete cache[o],o=t}}else e.refreshTime=a.DateAdd("m",30).getTime();return e.activeTime=n,o},_acts:function(){var e=this._epms,t=this._tcs,o=_.clone(t),a=(new Date).getTime();for(var n in t){a-t[n].activeTime>e&&o&&o[n]&&delete o[n]}this._tcs=o,o=null},_actsDbToken:function(){var r=this._epms,s=(new Date).getTime();g.query("Token",{},function(e){var t=e.length,o=[];if(0<t){for(var a=0;a<t;a++){var n=e[a].dataValues,i=n.key;s-n.activetime>r&&o.push(i)}g.delete("Token",{key:o},function(e){},function(e){console.log("_actsDbToken:"+e)})}},function(e){console.log("_actsDbToken:"+deleteError)})},autoCheckToken:function(){this.stopAutoChecking();var e=this;this.autocheckID=setInterval(function(){e._actsDbToken()},6e4)},stopAutoChecking:function(){var e=this.autocheckID;e&&clearInterval(e)},getToken:function(e,o){this.getTokenFromDB(e,function(e,t){e?o(e):o(null,t)})},cacheTokenToDB:function(a,n){var i=this,r=this.generateTokenKey(a.mss,a.ip,a.user);i.getTokenFromDB(r,function(e,t){if(e)n(e);else if(t)n(null,r);else{var o={key:r,time:(new Date).getTime(),user:a.user,ip:a.ip,rolevalue:a.roleValue};g.insert("Token",o,function(e){var t=e.dataValues;t&&i.updateTokenFromDB(t,function(e,t){e?n(e):n(null,t)})},function(e){n(e)})}})},getTokenFromDB:function(e,o){g.query("Token",{where:{key:e}},function(e){var t=e.length;o(null,0<t?e[0].dataValues:null)},function(e){o(e)})},updateTokenFromDB:function(e,t){if(!e)return null;var o,a=e.key,n=new Date,i=n.getTime(),r=e.refreshTime;if(r){if(0<=n-r){var s=new Date;e.activeTime=i,e.refreshTime=s.DateAdd("m",30).getTime(),o=this.generateTokenKey(i,e.ip,e.user),e.key=o,g.insert("Token",e,function(e){g.delete("Token",{key:a},function(e){t(null,a=o)},function(e){t(e)})},function(e){t(e)})}}else e.refreshTime=n.DateAdd("m",30).getTime(),g.update("Token",{refreshtime:n.DateAdd("m",30).getTime(),activetime:i},{key:a},function(e){t(null,a)},function(e){t(e)})}}),General.Auth.TokenManager=Y;Y=General.Auth.TokenManager,K=General.Auth.Authentication,U=General.Auth.Authorization;var X=General.SMS.Crypto,$=function(){_.callSuper($,this,arguments),this._name="auth",this.authentication=new K,this.authentication.storeConfig({accountModel:"Account"}),this.authorization=new U};_.extend($,c,{getExports:function(){return["getRoleMessage","getRoleGroupsInfo","getAuthorizationMessage","addRoleNameAndDesc","addRole","updateRole","deleteRole","addRoleGroup","updateRoleGroup","deleteRoleGroup","addMethod2Role","getAuthorizationMessage2Ebptable","addUser2RoleGroup","removeUser2RoleGroup","getUser2RoleGroupData","getUser2RoleGroupAddData","addAuthorizationFromRole","deleteAuthorizationForRole","updateMenu2Role","updateRoleWithDesc","updateMethod2Role","getMenu2RoleData","getAuthCode","onLogin","getRole2RoleGroupData","getRole2RoleGroupAddData","addRole2RoleGroup","removeRole2RoleGroup","getAuthorizationAndPages","deleteRoleAndUpdateSetting","isValidateTokenManager","addAvaliableIpManager","deleteAvaliableIpManager","getAvaliableIpListManager"]},runningOnPlatform:function(e){_.invokeSuper($,"runningOnPlatform",this,[e]),this.initAuthorizations(),this.initAccounts(e.operator);var t={logid:_.getGUID(20),type:"runningOnPlatform",content:JSON.stringify({module:"auth"}),category:"1",operator:null,createtime:new Date,operatorip:"172.0.0.1",result:"SUCCESS"};d.fireEvent("log_addLogging",t),console.log(JSON.stringify(t))},initAuthorizations:function(){this.authorization.initAuthorizations(this._platform)},initAccounts:function(e){if(e){var t=[];if(Array.isArray(e))for(var o=0;o<e.length;o++){i={aid:(n=e[o]).aid?n.aid:_.getGUID(12),email:n.email?n.email:"",name:n.name?n.name:"",cellphone:n.cellphone?n.cellphone:"",pwd:n.pwd?X.md5(n.pwd):X.md5("123"),createtime:new Date,rolename:n.rolegroupid?n.rolegroupid:null,companyid:n.companyid?n.companyid:"",verification:!0};t.push(i)}else for(var a in e){var n,i={aid:a,email:(n=e[a]).email,name:n.name,cellphone:n.cellphone,pwd:X.md5(n.pwd),createtime:new Date,rolename:n.rolegroupid?n.rolegroupid:null,companyid:n.companyid,verification:!0};t.push(i)}}g.query("Account",{},function(e){0<e.length||g.batchInsert("Account",t,function(e){_.log("初始用户创建完毕(Accounts is ready!)")},function(e){_.log("初始用户创建失败："+e.message)})})},loadAuthorizationDefine:function(e,t,o){var a=[];for(var n in e)for(var i=e[n],r=0;r<i.length;r++){var s={module:n};s.api=i[r],a.push(s)}this.authorization.loadAuthorizationDefine("Authorization",a,t,o)},unloadAuthorizationByModule:function(e,t,o){this.authorization.unloadAuthorizationByModule(e,t,o)},isValidate:function(e,t,o){var a=this._platform._settings.moduleSettings.auth.publicApi[t];if(a){if("*"==a)return!0;for(var n=0;n<a.length;n++)if(a[n]==e)return!0}return this.authorization.isAuthorized(e,t,o)},getRoleMessage:function(e,t,o){var a={action:"getRoleMessage"},n=e.body,i=n.roleid,r=e.session.user.rolekey;"Array"==typeof n&&(i=_._handleDatatableSettings(n,["roleid"]).roleid);var s=this._getRoleMessage(n.sSearch,i,r);a.result={data:s,length:s.length},a.status=b.S,t.json(a)},_getRoleMessage:function(e,t,o){return this.authorization.getRoleMessage(e,t,o)},getRoleGroupsInfo:function(e,t,o){var a={action:"getRoleGroupsInfo"},n=e.body,i=n.rolegroupids,r=e.session.user.rolekey;if("Array"==typeof n){var s=_._handleDatatableSettings(n,["rolegroupid"]);rolegroupid=s.rolegroupid}var l=this._getRoleGroupsInfo(n.sSearch,i,r);a.result={data:l,length:l.length},a.status=b.S,t.json(a)},_getRoleGroupsInfo:function(e,t,o){return this.authorization.getRoleGroupsInfo(e,t,o)},getAuthorizationMessage:function(e,t,o){var a,n={action:"getAuthorizationMessage"},i=e.body;a="Array"==typeof i?_._handleDatatableSettings(i,["roleid","notIncludeRoleid"]):i;var r=this.getAuthorizationMessageUnit(a.roleid,a.notIncludeRoleid);n.result={data:r,length:r.length},n.status=b.S,t.json(n)},getAuthorizationMessageUnit:function(e,t){return this.authorization.getAuthorizationMessage(e,t)},getAuthorizationAndPages:function(e,t,o){var a,n={action:"getAuthorizationAndPages"},i=e.body;a="Array"==typeof i?_._handleDatatableSettings(i,["roleid","notIncludeRoleid"]):i;this.authorization.getMenuPage(a.roleid,a.notIncludeRoleid,function(e){n.result={data:e.authorizationMessages,menuPage:e.page},n.status=b.S,t.json(n)})},getAuthorizationMessage2Ebptable:function(e,t,o){var a,n={action:"getAuthorizationMessage"},i=e.body;a=_._handleDatatableSettings(i,["roleid","notIncludeRoleid"]);var r=this.authorization.getAuthorizationMessage(a.roleid,a.notIncludeRoleid);n.result={data:r,length:r.length},n.status=b.S,t.json(n)},_getRoleInfoFromRoleName:function(e,t){this.authorization._getRoleGroupInfoFromRoleName(e,function(e){t(e=e||null)})},addRole:function(e,t,o){var a={action:"addRole"},n=e.body.rolename;this._addRoleUnit(n,function(e){e.status?(a.result={},a.status=b.S):(a.error={desc:JSON.stringify(e.error)},a.status=b.F),t.json(a)})},_addRoleUnit:function(e,t){this.authorization.addRole(e,t)},addRoleNameAndDesc:function(e,a,t){var n=this,i={action:"addRoleNameAndDesc"},r=e.body,s=r.rolename,l=r.roledesc;this._addRoleUnitSjs(s,l,function(e){if(e.status){n._addPermissionToRole(r.authorizationData,e.roleId);var t={name:s,desc:l,roleid:e.roleId,value:e.value};if(r.roleToMenuArray){var o=n._getSettingsValue(t,r.roleToMenuArray,r.pageData,r.authsettings);n._updateSettings("auth",JSON.stringify(o)),n._addRoleToMenuPage(o.roleMenu)}i.result={},i.status=b.S,i.roleId=e.roleId,i.value=e.value}else i.error={desc:JSON.stringify(e)},i.status=b.F;a.json(i)})},_getSettingsValue:function(e,t,o,a){a.roles[e.roleid]={desc:e.desc,name:e.name,roleid:e.roleid,value:e.value};for(var n=0,i=t.length;n<i;n++)for(var r=0,s=o.length;r<s;r++){var l=o[r];if(l.itemsName==t[n]){var u=a.roleMenu[e.roleid];if(u){for(var c=0;c<u.length;c++){var d=!1;if(u[c].name==l.groupName){var f={name:l.itemsName,path:l.path,icon:l.icon};u[c].children.push(f),d=!0;break}}if(!d){f={name:l.itemsName,path:l.path,icon:l.icon};var h={name:l.groupName,children:[f],icon:l.icon,path:l.path};a.roleMenu[e.roleid].push(h);break}}else{a.roleMenu[e.roleid]=[];f={name:l.itemsName,path:l.path,icon:l.icon},h={name:l.groupName,icon:l.icon,path:l.path,children:[f]};a.roleMenu[e.roleid].push(h)}break}}return a},_updateSettings:function(t,e){var o=this,a=o._platform._settings.moduleSettings[t];if(t&&e){var n=JSON.parse(e);for(var i in a)n[i]||(n[i]=a[i]);o._platform._settings.moduleSettings[t]=n;var r={value:JSON.stringify(o._platform._settings.moduleSettings)};g.update("Setting",r,{settingid:"modulesSetting"},function(e){o._platform.runModule(t,"loadModuleSettings",[n])},function(e){o._platform._settings.moduleSettings[t]=a,_.responsDBErrorAction(res,action,e)})}},_addRoleToMenuPage:function(e){this.authorization.addRoleToMenuPage(e)},_deleteRoleToMenuPage:function(e){this.authorization.deleteRoleToMenuPage(e)},_addPermissionToRole:function(e,t){if(e&&Array.isArray(e))for(var o=0;o<e.length;o++)this.authorization.addMethod2Role(t,e[o])},_addRoleUnitSjs:function(e,t,o){this.authorization.addRoleNameAndDesc(e,t,o)},addRoleGroup:function(e,t,o){var a={action:"addRoleGroup"},n=e.body.roleGroupName;this._addRoleGroupUnit(n,function(e){e.status?(a.result={},a.status=b.S):(a.error={desc:JSON.stringify(e.error)},a.status=b.F),t.json(a)})},_addRoleGroupUnit:function(e,t){this.authorization.addRoleGroup(e,t)},updateRole:function(e,t,o){var a={action:"updateRole"},n=e.body,i=n.name,r=n.roleid;this._updateRoleUnit(r,i,function(e){e.status?(a.result={},a.status=b.S):(a.error={desc:JSON.stringify(e.error)},a.status=b.F),t.json(a)})},_updateRoleUnit:function(e,t,o){this.authorization.updateRoleInfo(e,t,o)},updateRoleWithDesc:function(e,a,t){var n=this,i={action:"updateRoleWithDesc"},r=e.body,s=r.name,l=r.roleid,u=r.roledesc;this.authorization.updateRoleInfoWithDesc(l,s,u,function(e){if(e.status){var t={name:s,desc:u,roleid:l,value:e.value};if(r.roleToMenuArray){delete r.authsettings.roleMenu[l],delete r.authsettings.roles[l];var o=n._getSettingsValue(t,r.roleToMenuArray,r.pageData,r.authsettings);n._updateSettings("auth",JSON.stringify(o)),n._addRoleToMenuPage(o.roleMenu)}i.result={},i.status=b.S}else i.error={desc:JSON.stringify(e.error)},i.status=b.F;a.json(i)})},updateRoleGroup:function(e,t,o){var a={action:"updateRoleGroup"},n=e.body,i=n.roleGroupName,r=n.roleGroupId;this._updateRoleGroupUnit(r,i,function(e){e.status?(a.result={},a.status=b.S):(a.error={desc:JSON.stringify(e.error)},a.status=b.F),t.json(a)})},_updateRoleGroupUnit:function(e,t,o){this.authorization.updateRoleGroupInfo(e,t,o)},deleteRole:function(e,t,o){var a={action:"deleteRole"},n=e.body.roleid;"admin"==n||"common"==n?(a.error={desc:"系统角色不可删除！"},a.status=b.F,t.json(a)):this._deleteRoleUnit(n,function(e){e.status?(a.result={},a.status=b.S):(a.error={desc:JSON.stringify(e.error)},a.status=b.F),t.json(a)})},_deleteRoleUnit:function(e,t){this.authorization.deleteRoleInfo(e,t)},deleteRoleGroup:function(e,t,o){var a={action:"deleteRoleGroup"},n=e.body.roleGroupId;this._deleteRoleGroupUnit(n,function(e){e.status?(a.result={},a.status=b.S):(a.error={desc:JSON.stringify(e.error)},a.status=b.F),t.json(a)})},_deleteRoleGroupUnit:function(e,t){this.authorization.deleteRoleGroupInfo(e,t)},deleteRoleAndUpdateSetting:function(e,t,o){var a=this,n={action:"deleteRoleAndUpdateSetting"},i=e.body,r=i.roleid,s=i.authsettings;"admin"==r?(n.error={desc:"系统角色不可删除！"},n.status=b.F,t.json(n)):this.authorization.deleteRoleInfo(r,function(e){e.status?(delete s.roleMenu[r],delete s.roles[r],a._updateSettings("auth",JSON.stringify(s)),a._deleteRoleToMenuPage(r),n.result={},n.status=b.S):(n.error={desc:JSON.stringify(e.error)},n.status=b.F),t.json(n)})},addUser2RoleGroup:function(e,t,o){var a={action:"addUser2RoleGroup"},n=e.body,i=n.roleGroupId,r=n.userIds;if(i&&r&&Array.isArray(r)){for(var s=[],l=0;l<r.length;l++)s.push({roletouserid:_.getTimeGUID(new Date,12),rolegroupid:i,userid:r[l]});g.batchInsert("RoleGroupToAccount",s,function(e){a.result={},a.status=b.S,t.json(a)},function(e){a.status=b.F,a.error={cause:u.ErrorCode[300001],desc:"向RoleGroupToAccount表中插入数据失败："+e.message,code:"300001"},t.json(a)})}else a.status=b.F,a.error={cause:"Wrong Params",desc:"调用方法出错：错误的参数"},t.json(a)},removeUser2RoleGroup:function(e,t,o){var a={action:"removeUser2RoleGroup"},n=e.body,i=n.roleGroupId,r=n.userIds;if(i&&r&&Array.isArray(r)){for(var s=[],l=0;l<r.length;l++)s.push({userid:r[l],rolegroupid:i});g.delete("RoleGroupToAccount",{$or:s},function(e){a.result={},a.status=b.S,t.json(a)},function(e){a.status=b.F,a.error={cause:u.ErrorCode[300001],desc:"移除RoleGroupToAccount表数据失败："+e.message,code:"300001"},t.json(a)})}else a.status=b.F,a.error={cause:"Wrong Params",desc:"调用方法出错：错误的参数"},t.json(a)},getUser2RoleGroupData:function(e,s,t){var l={action:"getUser2RoleGroupData"},o=e.body,a=o.roleGroupId,u=o.repeatData,c=this;a?g.queryFromSql("select * from rolegrouptoaccounts rta  where rta.rolegroupid=:rolegroupid",{rolegroupid:a},function(e){for(var t=c._platform.runModule("eflowData","getAllContainerData",["employeeDataContaier"]),o=[],a=0;a<t.length;a++)for(var n=0;n<e.length;n++)if(t[a].employee_code==e[n].userid)if(u&&Array.isArray(u)){for(var i=!1,r=0;r<u.length;r++)t[a].employee_code==u[r].employee_code&&(i=!0);i||o.push(t[a])}else o.push(t[a]);l.result=o,l.status=b.S,s.json(l)},function(e){l.status=b.F,l.error={cause:"Query error!",desc:"获取RoleGroupToAccount表数据失败："+e.message},s.json(l)}):(l.status=b.F,l.error={cause:"Wrong Params",desc:"调用方法出错：错误的参数"},s.json(l))},getUser2RoleGroupAddData:function(e,t,o){for(var a={action:"getUser2RoleGroupAddData"},n=e.body.repeatData,i=this._platform.runModule("eflowData","getAllContainerData",["employeeDataContaier"]),r=[],s=0;s<i.length;s++)if(n&&Array.isArray(n)){for(var l=!1,u=0;u<n.length;u++)i[s].employee_code==n[u].employee_code&&(l=!0);l||r.push(i[s])}else r.push(i[s]);a.result=r,a.status=b.S,t.json(a)},getRole2RoleGroupData:function(e,t,o){var a={action:"getRole2RoleGroupData"},n=e.body.roleGroupId;if(n){var i=this._getRolesFormRoleGroup(n);a.result=i.roles,a.status=b.S,t.json(a)}else a.status=b.F,a.error={cause:"Wrong Params",desc:"调用方法出错：错误的参数"},t.json(a)},_getRolesFormRoleGroup:function(e){return this.authorization.getRolesFormRoleGroup(e)},getRole2RoleGroupAddData:function(e,t,o){for(var a={action:"getRole2RoleGroupAddData"},n=e.body.repeatData,i=e.session.user.rolekey,r=this.authorization.getRoleMessage(null,null,i),s=[],l=0;l<r.length;l++)if(n&&Array.isArray(n)){for(var u=!1,c=0;c<n.length;c++)r[l].roleid==n[c].roleid&&(u=!0);u||s.push(r[l])}else s.push(r[l]);a.result=s,a.status=b.S,t.json(a)},addRole2RoleGroup:function(e,t,o){var a={action:"addRole2RoleGroup"},n=e.body,i=n.roleValues,r=n.roleGroupId;if(r&&Array.isArray(i)){for(var s=i.length,l=0,u=0;u<s;u++)l|=parseInt(i[u]);this._addRole2RoleGroupUnit(l,r,function(e){e.status?(a.result={data:[],length:0},a.status=b.S):(returnFlag=!0,a.error=e.error,a.status=b.F),t.json(a)})}else a.error=new Error("addRole2RoleGroup params error!"),a.status=b.F,t.json(a)},_addRole2RoleGroupUnit:function(e,t,o){e&&t?this.authorization.addRole2RoleGroup(e,t,o):o({status:!1,error:new Error("addValue or rolegroupid is not defined")})},removeRole2RoleGroup:function(e,t,o){var a={action:"removeRole2RoleGroup"},n=e.body,i=n.roleValues,r=n.roleGroupId;if(r&&Array.isArray(i)){for(var s=i.length,l=0,u=0;u<s;u++)l|=parseInt(i[u]);this._removeRole2RoleGroupUnit(l,r,function(e){e.status?(a.result={data:[],length:0},a.status=b.S):(a.error=e.error,a.status=b.F),t.json(a)})}else a.error=new Error("removeRole2RoleGroup params error!"),a.status=b.F,t.json(a)},_removeRole2RoleGroupUnit:function(e,t,o){e&&t?this.authorization.removeRole2RoleGroup(e,t,o):o({status:!1,error:new Error("removeValue or rolegroupid is not defined")})},addMethod2Role:function(e,t,o){var a={action:"addMethod2Role"},n=e.body,i=n.roleid,r=n.authorizationData;if(r&&Array.isArray(r))for(var s=0;s<r.length;s++)this._addMethod2RoleUnit(i,r[s]);a.result={data:[],length:0},a.status=b.S,t.json(a)},_addMethod2RoleUnit:function(e,t){this.authorization.addMethod2Role(e,t)},addAuthorizationFromRole:function(e,t,o){for(var a={action:"addAuthorizationFromRole"},n=e.body,i=n.roleid,r=n.roleData,s=0;s<r.length;s++)this.authorization.addMethod2RoleFromRoleId(i,r[s]);a.result={data:[],length:0},a.status=b.S,t.json(a)},deleteAuthorizationForRole:function(e,t,o){var a={action:"deleteAuthorizationForRole"},n=e.body,i=n.roleid,r=n.authorizationData;if("admin"==i)a.error={desc:"admin的角色权限不可删除！"},a.status=b.F,t.json(a);else{if(r&&Array.isArray(r))for(var s=0;s<r.length;s++)this.authorization.removeMethodFromRole(i,r[s]);a.result={data:[],length:0},a.status=b.S,t.json(a)}},updateMethod2Role:function(e,t,o){var a={action:"addMethod2Role"},n=e.body,i=n.roleid,r=n.authorizationData,s=this.authorization.getAuthorizationMessage(i,n.notIncludeRoleid);if(r&&Array.isArray(r))for(var l=0;l<r.length;l++)this.authorization.addMethod2Role(i,r[l]);var u=[];for(l=0;l<s.length;l++){for(var c=!1,d=0;d<r.length;d++)if(s[l].apiid==r[d]){c=!0;break}c||u.push(s[l].apiid)}if(0<u.length)for(l=0;l<u.length;l++)this.authorization.removeMethodFromRole(i,u[l]);a.result={data:[],length:0},a.status=b.S,t.json(a)},updateMenu2Role:function(e,t,o){var a={action:"updateMenu2Role"},n=e.body,i=n.roleid,r=n.menuinfo;i&&r?g.update("RoleToMenu",{menuinfo:r},{roleid:i},function(){a.result={},a.status=b.S,t.json(a)},function(e){a.status=b.F,a.error={cause:u.ErrorCode[300001],desc:"更新RoleToMenu表数据失败："+e.message,code:"300001"},t.json(a)}):(a.status=b.F,a.error={cause:"Wrong Params",desc:"调用方法出错：错误的参数"},t.json(a))},getMenu2RoleData:function(e,o,t){var a={action:"getMenu2RoleData"},n=e.body.roleid,i=this;n?g.query("RoleToMenu",{where:{roleid:n}},function(e){for(var t=0;t<e.length;t++)e[t]=e[t].dataValues;a.result={menuinfo:e[0]&&e[0].menuinfo?JSON.parse(e[0].menuinfo):[],basemenu:i._platform._settings.moduleSettings.auth.roleMenu.admin},a.status=b.S,o.json(a)},function(e){a.status=b.F,a.error={cause:"Query error!",desc:"获取RoleToMenu表数据失败："+e.message},o.json(a)}):(a.status=b.F,a.error={cause:"Wrong Params",desc:"调用方法出错：错误的参数"},o.json(a))},_getUserMenu:function(e,o){this.authorization.getRoleMenueByRoleId(e,function(e,t){e?o(null,e):o(t)})},getAuthCode:function(e,o,t){var a=e.body,n={type:"getAuthCode"},i=Math.floor(999999*Math.random());5==(i=i.toString()).length&&(i+="0");var r={code:i};e.session.code=i;this._platform.run("sendSMS",[{contents:{code:r.code,phone:a.phone},phone:a.phone,template:"SMS_39930090"},function(e,t){n.status=e?b.F:b.S,o.json(n)}])},systemExit:function(e,t,o){var a={type:"systemExit"};e.session.islogin=!1;var n=e.session.user,i=_.getNodeClientIp(e);this._platform.releaseSession(e.session),e.session.destroy(function(){a.status=b.S,t.json(a);var e={logid:_.getGUID(20),type:"Logout",content:JSON.stringify({module:"auth"}),category:"0",operator:n?n.aid:"",createtime:new Date,operatorip:i||"",result:"SUCCESS"};d.fireEvent("log_addLogging",e),console.log(JSON.stringify(e))})},addUser:function(e,t,o){var a=e.body,n={action:"addUser"};a.verification=!1,a.aid=a.aid||_.getGUID(12),this.authentication.addUser(a,function(e){n.status=b.F,n.error={cause:T[e.errorcode]},t.json(n)},function(e){n.status=b.S,n.result=e,t.json(n)},function(){n.status=b.F,t.json(n)})},loadModuleSettings:function(e){var t=(this.settings=e).tokenExpiredTime||72e5,o=this.tokenManager,a=new Y(t);o&&(o.stopAutoChecking(),a._tcs=o._tcs,o=null),this.tokenManager=a},updateValidateSuccess:function(o,e,a,n,i){a.loginTime=new Date,a.pwd=null,a.rolekey=this.authorization.getRoleKeyFromRoleid(a.role);var r=this;o.session.regenerate(function(){o.session.islogin=!0;r.tokenManager;var e={user:a.aid,roleValue:a.rolekey,ip:_.getNodeClientIp(o)};r.cacheToken(e,function(e,t){e?console.log(e):(t&&(n.token=t,a.token=n.token),o.session.user=a,n.result={isValidated:!0},n.status=b.S,r.authorization.getRoleMenueByRoleId(a.role,function(e,t){e?i(null,e):(n.result.user=a,n.result.menusettings=t,n.user=a,i(n))}))})})},getUserMenu:function(e,o){this.authorization.getRoleMenueByRoleId(e,function(e,t){e?o(null,e):o(t)})},_remoteSignin:function(n,o,a,i,r){var s=this;n.callback=function(e,t){t?(r.status=b.F,r.result={isValidated:!1},r.error=t,a.json(r)):(e.role=[e.rolename],s.updateValidateSuccess(o,a,e,r,function(e,t){t?(r.status=b.F,r.error={cause:t.message},a.json(r)):a.json(e)}))};var l=n.aid,u=n.pwd,c=n.callback;this.tokenManager;delete n.callback,this.authentication.isValidated(n,function(e){var t=e[0].dataValues;if(t.verification)s._updateValidateSuccess(t,function(e){c&&c(e)});else if(n.code&&n.cellphone)if(n.code==i.code){var o={aid:t.aid},a=(n.cellphone,!0);g.update("Account",{verification:a},o,function(){s._updateValidateSuccess(t,function(e){c(e)})},function(){c(null,{errorcode:"500003",message:T[500003],cause:"Can not update accounts"})})}else c(null,{errorcode:"500002",message:T[500002],cause:"Validate code is wrong"});else c(null,{errorcode:"500003",cause:T[500003]})},function(e){var t=s._platform.operator;t&&t.admin&&"admin"==l&&u==t.admin.pwd?s._updateValidateSuccess({aid:"admin",name:"admin",rolename:"admin"},function(e){c&&c(e)}):c(null,{errorcode:e.errorcode,message:T[e.errorcode],cause:T[e.errorcode]})})},_signin:function(n){var o=n.aid,a=n.pwd,i=this,r=n.callback;this.tokenManager;delete n.callback,this.authentication.isValidated(n,function(e){var t=e[0].dataValues;if(t.verification)i._updateValidateSuccess(t,function(e){r&&r(e)});else if(n.code&&n.cellphone)if(n.code==session.code){var o={aid:t.aid},a=(n.cellphone,!0);g.update("Account",{verification:a},o,function(){i._updateValidateSuccess(t,function(e){r(e)})},function(){r(null,{errorcode:"500003",message:T[500003],cause:"Can not update accounts"})})}else r(null,{errorcode:"500002",message:T[500002],cause:"Validate code is wrong"});else r(null,{errorcode:"500003",cause:T[500003]})},function(e){var t=i._platform.operator;t&&t.admin&&"admin"==o&&a==t.admin.pwd?i._updateValidateSuccess({aid:"admin",name:"admin",rolename:"admin"},function(e){r&&r(e)}):r(null,{errorcode:e.errorcode,message:T[e.errorcode],cause:T[e.errorcode]})})},onLogin:function(a,n,e){var i=a.body,r={type:"login"},s=this;a.session;i.pwd=X.md5(i.pwd);var l=_.getNodeClientIp(a);i.callback=function(e,t){if(t){r.status=b.F,r.result={isValidated:!1},r.error=t,n.json(r);var o={logid:_.getGUID(20),type:"Login",content:JSON.stringify({module:"auth"}),category:"0",operator:i.aid?i.aid:"",createtime:new Date,operatorip:l||"",result:"FAIL"};d.fireEvent("log_addLogging",o),console.log(JSON.stringify(o))}else e.role=[e.rolename],s.updateValidateSuccess(a,n,e,r,function(e,t){if(t){r.status=b.F,r.error={cause:t.message},n.json(r);var o={logid:_.getGUID(20),type:"Login",content:JSON.stringify({module:"auth"}),category:"0",operator:i.aid?i.aid:"",createtime:new Date,operatorip:l||"",result:"FAIL"};d.fireEvent("log_addLogging",o),console.log(JSON.stringify(o))}else n.json(e),o={logid:_.getGUID(20),type:"Login",content:JSON.stringify({module:"auth"}),category:"0",operator:i.aid?i.aid:"",createtime:new Date,operatorip:l||"",result:"SUCCESS"},d.fireEvent("log_addLogging",o),console.log(JSON.stringify(o))})},this._signin(i)},appendUserInfo:function(e,t){e.islogin=!0,e.user=t},appendToken:function(e,o){var t=this.tokenManager;o.rolekey=this.authorization.getRoleKeyFromRoleid(o.rolename);var a={user:o.aid,roleValue:o.rolekey,ip:_.getNodeClientIp(e)};t.cacheToken(a,function(e,t){e?console.log(e):t&&(o.token=t)})},isValidateTokenManager:function(e,o,t){var a={type:"isValidateTokenManager"},n=this.tokenManager,i=e.body.token,r=_.getNodeClientIp(e);i&&n.isValidatedTokenUser(i,r,function(e,t){e?(a.error=e,a.status=b.F):(a.result={data:t},a.token=t.tokenValue.key,a.status=b.S),o.json(a)})},isValidateTokenAtAuth:function(e,t,o){var a=this.tokenManager;if(a)return a.isValidatedToken(e,t,o)},cacheToken:function(e,o){this.tokenManager.cacheToken(e,function(e,t){e?o(e):t&&o(null,t)})},getTokenByKey:function(e,t){this.tokenManager.getToken(e,t)},getUserByAppKey:function(e,o,a){g.queryFromSql("select app.appkey, acc.*, role.value as rolevalue from appkeys app, accounts acc left join roles role on acc.rolename = role.roleid where app.appkey = :AppKey and app.aid=acc.aid ",{AppKey:e},function(e){if(e&&0<e.length){var t=e[0];"admin"===t.aid&&(t.rolevalue="1",t.rolename="admin"),o(t.aid,t),a(t.rolevalue)}},function(e){a()})},_updateValidateSuccess:function(e,t){e.loginTime=new Date,e.pwd=null;var o=this.settings.roleMenu[e.roleid?e.roleid:e.rolename];o&&(e.menusettings=o);this.tokenManager;e.rolekey=this.authorization.getRoleKeyFromRoleid(e.roleid?e.roleid:e.rolename);var a={};a.account=e,a.callback=t,d.fireEvent(u.EventType.InnerSignin,a)},addAvaliableIpManager:function(e,t,o){var a={type:"addAvaliableIpManager"},n=e.body;if(n.ip){var i={ip:n.ip,comments:n.comments?n.comments:""};g.insert("AvaliableIp",i,function(e){a.result={data:e.dataValues},a.status=b.S,t.json(a)},function(e){a.status=b.F,a.error=e,t.json(a)})}},deleteAvaliableIpManager:function(e,t,o){var a={type:"deleteAvaliableIpManager"},n=e.body.ip;n&&g.delete("AvaliableIp",{ip:n},function(e){a.status=b.S,t.json(a)},function(e){a.error=e,a.status=b.F,t.json(a)})},getAvaliableIpListManager:function(e,o,t){var a={type:"getAvaliableIpListManager"},n=e.body.ip;this.getAvaliableIpList(n,function(e,t){e?(a.status=b.F,a.error=e):(a.result={data:t},a.status=b.S),o.json(a)})},getAvaliableIpList:function(e,t){var o=" select * from avalia_ips where 1=1 ",a={};e&&(o+=" and ip like :IP ",a.IP="%"+e+"%"),g.queryFromSql(o,a,function(e){t(null,e)},function(e){t(e)})},isAvaliableIp:function(e,o){var t=" select count(1) as num from avalia_ips where 1=1 ",a={};"127.0.0.1"===e||"localhost"===e?o(null,!0):(t+=" and ip = :IP ",a.IP=e,g.queryFromSql(t,a,function(e){var t=e[0];t&&(0<t.num?o(null,!0):o(null,!1))},function(e){o(e)}))}}),General.Auth.Module=$,General.Email={};var Z={maid:{type:o.STRING,primaryKey:!0},user:{type:o.STRING,allowNull:!1},pwd:{type:o.STRING},host:{type:o.STRING,allowNull:!1},port:o.INTEGER,secure:{type:o.BOOLEAN,defaultValue:!1},auth2:{type:o.BOOLEAN,defaultValue:!1},clientId:o.STRING,clientSecret:o.STRING,refreshToken:o.STRING,accessToken:o.STRING,expires:o.INTEGER},ee={tid:{type:o.STRING,primaryKey:!0},subject:o.STRING,text:o.STRING,html:o.BLOB,params:o.BLOB},te={accountid:{type:o.STRING,allowNull:!1,defaultValue:"admin"},maid:{type:o.STRING,allowNull:!1}},oe={accountid:{type:o.STRING,allowNull:!1,defaultValue:"admin"},tid:{type:o.STRING,allowNull:!1}};a&&(a.registerModel("EMailAccount","emailaccount",Z),a.registerModel("EMailTemplate","emailtemplate",ee),a.registerModel("AccountEMailResource","accountemailresource",te),a.registerModel("AccountEMailTemplate","accountemailtemplate",oe)),General.Email.Model=a;var ae=require("nodemailer"),ne={host:"smtp.mxhichina.com",port:25,auth:{user:"support@benbangtu.com",pass:""},address:"Support team of Benbangtu <supports@benbangtu.com>"},ie=function(e){this.init(e)};_.extend(ie,Object,{init:function(e){e=e||ne;var t={};(this._s=e).auth&&(t=e.auth instanceof Object?e.auth:JSON.parse(e.auth),e.auth=t),this.transport=ae.createTransport(e)},sendHTMLEMail:function(e){this.sendEMail(e,!0)},sendPlainEMail:function(e){this.sendEMail(e)},sendEMail:function(e,t){var o=this._s,a={from:e.from||o.address||"supports@benbangtu.com",to:e.to,subject:e.subject||"My subject"};t?(a.generateTextFromHTML=!0,a.html=e.contents):a.text=e.contents,this.transport.sendMail(a,function(e,t){e?console.log(e):console.log("EMail sent: "+t.response)})},sendEMailWithTemplate:function(e){var t,o,a={},n={},i={},r=[],s=e.callback,l=this.transport;e.mailtemplate?a=e.mailtemplate:e.subject&&(a.subject=e.subject,a.text=e.text),n.to=e.to,n.replyTo=e.replyto,e.cc&&(n.cc=e.cc),e.attachments&&(r=e.attachments),o=(t=e.settings?e.settings:ne).auth?t.auth.user:t.user,e.params&&(i=e.params),l.templateSender(a,{from:o,attachments:r})(n,i,function(e,t){if(e){var o={errorcode:"100300"};o.cause=T[o.errorcode]+e,s&&s(o,t)}else s&&s(e,t)})},dispose:function(){this.transport.close()}}),General.Email.EMailSender=ie;var re=General.Email.EMailSender,se=function(){_.callSuper(se,this,arguments),this._name="email",this.room={},this.data={},this._SendEmailData=[],this._SendEmailTimedFlag=!1};_.extend(se,c,{loadModuleSettings:function(e,t){this.SEND_EMAIL_TIME=e.SEND_EMAIL_TIME},getEmailSender:function(e,t){var o=this.room,a=o[e];return a||(a=new re(t),o[e]=a),a},getEMailTemplate:function(e,o){g.queryFromSql("select * from emailtemplates where tid=:tid",{tid:e},function(e){var t=e[0];o&&o(null,t)},function(e){o&&o(e)})},sendEmailTimed:function(e){var a=this;if(this._SendEmailData.length){var n=this._SendEmailData[0],i=n.maid,t=n.tid,o=n.settings,r=n.mailtemplate,s=n.callback,l=function(e,t){t?a.getEmailSender(t,e).sendEMailWithTemplate(n):new re(e).sendEMailWithTemplate(n),a._SendEmailData.shift()};if(o)if(t)a.getEMailTemplate(t,function(e,t){n.mailtemplate=t,l(o)});else if(r)l(o);else{s({cause:"Please input correct mail template or template ID!"})}else if(i)a.getMailAccountSetting(i,function(e,o){e?s&&s(e):(n.settings=o,t?a.getEMailTemplate(t,function(e,t){n.mailtemplate=t,l(o,i)}):r?l(o,i):n.subject&&(n.text=n.params,l(o,i)))});else s({cause:"Please input correct mail server ID!"})}else f.deleteCronJob("email_SendEmail"),this._SendEmailTimedFlag=!1},sendEmail:function(e){var t=this;this._SendEmailData=this._SendEmailData.concat(e),t._SendEmailTimedFlag||f.deleteCronJob("email_SendEmail",function(){f.startSyn({global:t,uuid:"email",prop:"SendEmail",time:t.SEND_EMAIL_TIME,func:t.sendEmailTimed}),t._SendEmailTimedFlag=!0})},getMailAccountSetting:function(e,a){g.queryFromSql("select * from emailaccounts where maid=:maid",{maid:e},function(e){var t=e[0],o={};o.user=t.user,o.pass=t.pass,t.auth=o,delete t.user,delete t.pass,a&&a(null,t)},function(e){a&&a(e)})},dealwithEmailData:function(e,t,o,a){var n=_.getNodeClientIp(e);a.ip=n;var i={},r=[];for(var s in a)i[s]=a[s];if(a.Dir&&a.avatarName&&a.Dir.length&&a.avatarName.length){for(var l=0;l<a.Dir.length;l++){var u=a.Dir[l],c=a.avatarName[l],d=D.resolve(u);if(t.isAttachments){var f={};f.filename=c,f.path=d,r.push(f)}var h,m=[];m.push(c),h=h?h+","+d:d}i.formURL=m,a.formURL=h,delete i.form}var g={};return g.subject=t.subject,g.html=t.html,g.text=t.text,t.subject&&(g.subject=t.subject),t.html&&(g.html=t.html),t.text&&(g.text=t.text),g.to=t.to,g.replyTo=t.replyto,t.cc&&(g.cc=t.cc),g.attachments=r,g.params=i,g.settings=o,g.emailInfo=t,g}}),General.Email.Module=se,General.Event={};var le={eventid:{type:o.STRING,allowNull:!1,unique:!0},module_type:{type:o.STRING,allowNull:!1},event:{type:o.STRING,allowNull:!1},operator:{type:o.STRING,allowNull:!1},target:{type:o.STRING},time:{type:o.DATE,allowNull:!1},desc:{type:o.STRING}};a&&a.registerModel("Event","event",le),General.Event.Model=a;var ue=function(){_.callSuper(ue,this,arguments),this._name="event",this.modelName="Event",this.timeoutID="",this.autoCheckEventsTime=5e3,this.rtEvents=[],this.focusedEventArray=[{event:n.EventsOccur,onEvent:"onEventsOccur"}]};_.extend(ue,h,{onEventsOccur:function(e){_.log("EventServerModule 监听接收到未定义异常事件 : "+JSON.stringify(e))},init:function(){this.checkEvents},runningOnPlatform:function(e){_.invokeSuper(ue,"runningOnPlatform",this,arguments),this.init()},disposeModule:function(){_.invokeSuper(ue,"disposeModule",this,arguments),clearTimeout(this.timeoutID)},createEvent:function(e){var t=[];i.isArray(e)||(e=[e]);for(var o=0;o<e.length;o++){var a={eventid:_.getGUID(20),event:e[o].eventType,operatorid:e[o].operator,time:new Date};e[o].description&&(a.description=e[o].description),e[o].target&&(a.target=e[o].target),t.push(a)}return t},checkEvents:function(){var e=this.rtEvents.concat(),t=(this.rtEvents.length,this),o=function(){t.checkEvents()};e&&0<e.length?(_.log("EventServer prepare to store events:"+JSON.stringify(e)),_.invokeSuper(ue,"addRecordsForModels",this,[this.modelName,e,function(){t.timeoutID=setTimeout(o,t.autoCheckEventsTime)},function(){t.timeoutID=setTimeout(o,t.autoCheckEventsTime)}])):t.timeoutID=setTimeout(o,t.autoCheckEventsTime)},addEvents:function(e,t,o){if(i.isArray(e)||(e=[e]),this.rtEvents=this.rtEvents.concat(e.concat()),e)for(var a=0;a<e.length;a++)e[a].event?d.fireEvent(e[a].event):d.fireEvent(n.EventsOccur);t&&t(e)}}),General.Event.Module=ue,General.Heartbeat={};var ce=function(){_.callSuper(ce,this,arguments),this._name="heartbeat"};_.extend(ce,c,{getExports:function(){return["heartbeat"]},loadModuleSettings:function(e){this._s=e},replyHeartbeat:function(e){var t=this._s;if(t&&t.freq)return{heartbeatFreq:t.freq}},heartbeat:function(e,t,o){var a={type:"heartbeat",status:b.S},n=this._platform.collectHBReply(e.session);0<n.length&&(a.results=n),t.json(a)}}),General.Heartbeat.Module=ce,General.Mail={};var de={mailid:{type:o.STRING,allowNull:!1,unique:!0},type:{type:o.STRING,allowNull:!1},priority:{type:o.INTEGER,allowNull:!1,defaultValue:0},heading:{type:o.STRING,allowNull:!1},i18n:{type:o.BOOLEAN,allowNull:!1,defaultValue:!1},toDetail:{type:o.STRING(1e3)},contents:o.TEXT,senderid:{type:o.STRING,allowNull:!1},receiverNames:{type:o.STRING},draft:{type:o.BOOLEAN,allowNull:!1,defaultValue:!1},time:{type:o.DATE},createTime:{type:o.DATE,allowNull:!1},createid:{type:o.STRING,allowNull:!1}},fe={mtaid:{type:o.STRING,allowNull:!1,unique:!0},mailid:{type:o.STRING,allowNull:!1},receiverid:{type:o.STRING,allowNull:!1},status:{type:o.ENUM,values:["normal","draft","trash","spam"],defaultValue:"normal"},checked:{type:o.BOOLEAN,allowNull:!1,defaultValue:!1}};a&&(a.registerModel("Mail","mail",de),a.registerModel("MailToAccount","mailtoaccount",fe)),General.Mail.Model=a;var he=function(){_.callSuper(he,this,arguments),this._name="mail",this.focusedEventArray=[{event:n.MailCreated,onEvent:"addRecordsForModels"}],this.usMap={},this.heartbeatCache={}};_.extend(he,h,{getExports:function(){return["reqMails","initMessagesNum","updateMessagesStatus","reqUnreadMailsNum","createMail","getMailsInfo"]},addRecordsForModels:function(e){for(var t=0;t<e.length;t++){if("MailToAccount"==e[t].modelName)for(var o=_.clone(e[t].records),a=(this.usMap,this.heartbeatCache,0);a<o.length;a++)"draft"!=o[a].status&&this.cacheMail(o[a].receiverid,o[a]);_.invokeSuper(he,"addRecordsForModels",this,[e[t].modelName,e[t].records])}},reqMails:function(e,t,o){var a={type:"reqMails"},n=e.body,i=(e.session.user.aid,_._handleDatatableSettings(n,["checked","status","priority","senderid","receiverid","timeS","timeE","createTimeS","createTimeE"])),r="select m.*,(select name from accounts a where m.receiverid = a.aid) as receiverName,(select name from accounts a where m.senderid = a.aid) as senderName  from (select ms.*,ma.receiverid,ma.status,ma.checked,ma.mtaid from mails ms,mailtoaccounts ma where ms.mailid=ma.mailid) m where 1=1 ";for(var s in i)switch(s){case"checked":"true"==i.checked||1==i.checked?i.checked=!0:i.checked=!1,r+=" and m.checked=:checked ";break;case"status":r+=" and m.status=:status ";break;case"priority":i.priority=parseInt(i.priority),r+=" and m.priority=:priority ";break;case"receiverid":r+=" and m.receiverid=:receiverid ";break;case"timeS":i.timeS=new Date(i.timeS),r+=" and m.time>=:timeS ";break;case"timeE":i.timeE=new Date(i.timeE),r+=" and m.time<=:timeE ";break;case"createTimeS":i.createTimeS=new Date(i.createTimeS),r+=" and m.createTime>=:createTimeS ";break;case"createTimeE":i.createTimeE=new Date(i.createTimeE),r+=" and m.createTime<=:createTimeE "}i.senderid&&(r="select m.*,(select a.name from accounts a where a.aid=m.senderid) as senderName,m.receiverNames as receiverName,(select GROUP_CONCAT(a.name SEPARATOR ';') from mailtoaccounts ma,accounts a where ma.mailid=m.mailid and ma.receiverid=a.aid) as receiverNames,true as checked,'","draft"==i.status?r+="draft":r+="sent",r+="' as status from mails m where m.senderid=:senderid ","draft"==i.status?r+=" and m.draft=true ":r+=" and m.draft=false "),r+=" order by m.createTime desc;",g.queryFromSql(r,i,function(e){a.status=b.S,a.result={data:e,length:e.length},t.json(a)},function(e){_.responsDBErrorAction(t,a,e)})},getMailsInfo:function(e,o,t){var a={type:"getMailsInfo"},n=e.body,i=(e.session.user.aid,{}),r={},s="select * from mail_messge_tables where 1=1",l="select count(1) as num from mail_messge_tables where 1=1";if(n.checked&&(r.CHECKED="%"+n.checked+"%",s+=" and checked like :CHECKED ",i.CHECKED="%"+n.checked+"%",l+=" and checked like :CHECKED "),n.receiverid&&(r.receiverid="%"+n.receiverid+"%",s+=" and receiverid like :receiverid ",i.receiverid="%"+n.receiverid+"%",l+=" and receiverid like :receiverid "),n.sorter){var u=n.sorter,c=u.field,d=u.order;s=s+" order by "+c+" "+("ascend"==d?"asc":"desc")}else s+=" order by time desc ";n.start&&n.length&&(r.start=parseInt(n.start),r.length=parseInt(n.length),s+=" limit :start, :length "),g.queryFromSql(l,i,function(t){g.queryFromSql(s,r,function(e){a.result={length:t[0].num,data:e},a.status=b.S,o.json(a)},function(e){a.error=e.message,a.status=b.F,o.json(a)})},function(e){a.error=e.message,a.status=b.F,o.json(a)})},initMessagesNum:function(e,t,o){var a={type:"initMessagesNum"},n=e.session.user.aid;g.queryFromSql("select (select count(id) from mailtoaccounts where status='normal' and checked=false and receiverid=:receiverid) as inboxNum,(select count(ms.id) from mails ms,mailtoaccounts ma where ms.mailid=ma.mailid and status='draft' and createid=:createid) as draftNum,(select count(id) from mailtoaccounts where status='spam' and receiverid=:receiverid1) as spamNum;",{receiverid:n,receiverid1:n,createid:n},function(e){a.status=b.S,a.result={inboxNum:e[0].inboxNum,draftNum:e[0].draftNum,spamNum:e[0].spamNum},t.json(a)},function(e){_.responsDBErrorAction(t,a,e)})},updateMessagesStatus:function(e,t,o){var a={type:"updateMessagesStatus"},n=e.body,i=(e.session.user.aid,n.mtaids),r=n.mailids,s=n.params,l=n.type,u=n.receiverid;if(s){var c={},d=[],f=[];if(i)for(var h=0;h<i.length;h++)d.push({mtaid:i[h]});if(r)for(h=0;h<r.length;h++)f.push({mailid:r[h]});u&&d.push({receiverid:u}),0<d.length&&(c.$or=d),s.status&&("trash"==s.status&&"draft"==l||"spam"==s.status&&"draft"==l)?g.delete("MailToAccount",{$or:f},function(e){g.update("Mail",{senderid:"deleted"},{$or:f},function(e){a.status=b.S,a.result={},t.json(a)},function(e){_.responsDBErrorAction(t,a,e)})},function(e){_.responsDBErrorAction(t,a,e)}):s.status&&"trash"==s.status&&"trash"==l?g.delete("MailToAccount",c,function(e){a.status=b.S,a.result={},t.json(a)},function(e){_.responsDBErrorAction(t,a,e)}):g.update("MailToAccount",s,c,function(e){a.status=b.S,a.result={},t.json(a)},function(e){_.responsDBErrorAction(t,a,e)})}else a.status=0,a.error={cause:"Invalid request"},t.json(a)},reqUnreadMailsNum:function(e,t,o){var a={type:"reqUnreadMailsNum"},n=e.session.user.aid;g.query("MailToAccount",{where:{receiverid:n,$and:{checked:!1,$and:{status:"normal"}}}},function(e){a.status=b.S,a.result={unreadMailsNum:e.length},t.json(a)},function(e){_.responsDBErrorAction(t,a,e)})},createMail:function(e,i,t){var r={type:"createMail"},s=e.body,l=e.session.user.aid,u=this,o=[{name:s.mailReceiver},{name:s.mailReceiver}],c=1;if(-1<s.mailReceiver.indexOf(";")){o=s.mailReceiver.split(";");for(var a=0;a<o.length;a++)o[a]={name:o[a]};c=o.length}g.query("Account",{where:{$or:o}},function(e){if(0<e.length&&e.length==c){for(var t=u.generateMailID(),o=[],a=0;a<e.length;a++){var n={mtaid:u.generateMailID(),mailid:t,receiverid:e[a].dataValues.aid,status:s.createFlag,checked:!1};o.push(n)}d.fireEvent("MailCreated",[{modelName:"Mail",records:[{mailid:t,type:"Message",priority:s.mailPriority,heading:s.mailHeading,contents:s.mailContent,senderid:l,receiverNames:s.mailReceiver,createid:l,draft:"draft"==s.createFlag,time:new Date,createTime:new Date}]},{modelName:"MailToAccount",records:o}],!0),r.status=b.S,r.result={},i.json(r)}else r.status=0,r.error={cause:"Can't find this receiver"},i.json(r)},function(e){_.responsDBErrorAction(i,r,e)})},cacheMail:function(e,t){var o=this.usMap[e],a=this.heartbeatCache;if(o)for(var n=0;n<o.length;n++){a[o[n]].push(t)}},replyHeartbeat:function(e){var t=e.id,o=e.user.aid,a=this.heartbeatCache,n=a[t];if(n)return a[t]=[],{newMailsNum:n.length};var i=this.usMap[o];i||(i=[]),i.push(t),this.usMap[o]=i,a[t]=[]},releaseSession:function(e){var t=e.id,o=e.user.aid,a=this.usMap[o];a&&a.splice(a.indexOf(t),1),this.heartbeatCache[t]=null},testSendMail:function(e){e.id;var t=e.user.aid,o=this.generateMailID();d.fireEvent("MailCreated",[{modelName:"Mail",records:[{mailid:o,type:"test",priority:0,heading:"test",contents:"this is a test message,this is a test message,this is a test message,this is a test message",senderid:t,createid:t,time:new Date,createTime:new Date}]},{modelName:"MailToAccount",records:[{mtaid:this.generateMailID(),mailid:o,receiverid:t,status:"normal",checked:!1}]}],!0)},generateMailID:function(){return _.getTimeGUID(new Date,8)}}),General.Mail.Module=he,General.Message={};var me={messageid:{type:o.STRING,allowNull:!1,unique:!0},type:{type:o.ENUM,values:["order","user"]},event:{type:o.ENUM,values:["signin","signout","signup","createOrder","updateOrder","releaseOrder","PriceOrder","confirmOrder","dispatchOrder","redispatchOrder","AcceptOrder","rejectOrder","executeOrder","requireCloseOrder","completeOrder","deleteEmployee","editEmployee","warning","orderDispatchedByHand","unaccepted","autoDispatchingFailed","orderIsSnatchedAway"]},operatorid:{type:o.STRING,allowNull:!1},time:{type:o.DATE,allowNull:!1},orderid:{type:o.STRING},target:o.STRING,description:{type:o.STRING}};a&&a.registerModel("Message","message",me),General.Message.Model=a;var ge=function(){this.bq={},this.pq={}};_.extend(ge,Object,{}),General.Message.MessageDispatcher=ge;var pe=function(){this.bq={},this.pq={}};_.extend(pe,Object,{_createQueue:function(e){return{id:_.getGUID(20),msgs:[],filter:e}},concatMsgs:function(e,t){var o=t;e.filter&&(o=o.filter(e.filter)),0<o.length&&(e.msgs=e.msgs.concat(o))},publish:function(e){var t=this.pq;for(var o in t)for(var a=t[o],n=a.length,i=0;i<n;i++)this.concatMsgs(a[i],e)},sendout:function(e){var t=this.bq;if(e.to){var o=msg.to;(i=bg[o])&&this.concatMsgs(i,e)}else for(var a in t){var n=t[a],i=n.queue;this.concatMsgs(i,e),n.callback&&(n.callback(i.msgs),i.msgs=[])}},subscribe:function(e){if(e){var t=this._createQueue(),o=this.pq[e];o||(o={subscribers:[],msgs:[]},this.pq[e]=o),queues[e]=t}},bindQueue:function(e,t){var o=this._createQueue(e);this.bq[o.id]={queue:o,callback:t}},getBoundMsgsByID:function(e){return this._queues[e]},getPublishedMsgsByTopic:function(e){}}),General.Message.MessageManager=pe;var ve=function(e){_.callSuper(p,this,arguments);var t=General.Message.MessageManager;this.manager=new t,this._clients=[],_.callSuper(t,this,arguments)};_.extend(ve,p,{start:function(e){(e=e||{type:"http",port:1e4,crossDomain:!0,compression:!0,publicPath:"../../../public",onSuccess:function(){console.log("程序已经初始化好,在监听端口:"+1e4)}}).routers={"/msg":this.getMessageQueueRouter()},_.invokeSuper(ve,"start",this,arguments)},keepClientSocket:function(e){this._clients.push(e)},sendout:function(e){this.manager.sendout(e)},bindQueue:function(e,t){this.manager.bindQueue(e,t)},getMessageQueueRouter:function(){var e=require("express").Router();return e.post("/publish",function(e,t,o){}),e.post("/sendout",function(e,t,o){}),e.post("/subscribe",function(e,t,o){}),e.post("/on",function(e,t,o){}),e}}),General.Message.Module=pe,General.Rabbitmq={};var ye={settingid:{type:o.STRING,allowNull:!1,unique:!0},serverName:{type:o.STRING},exchangeKey:{type:o.STRING},type:{type:o.STRING},routingKey:{type:o.STRING},settingFlag:{type:o.BOOLEAN,defaultValue:!0},createTime:{type:o.DATE},updateTime:{type:o.DATE}};a&&a.registerModel("MailSetting","mailsetting",ye),General.Rabbitmq.Model=a;var we=require("amqplib/callback_api");var Se={rabbitMQConnect:function(e,o){we.connect(e,function(e,t){e?o(e):(t.on("close",function(e,t){console.log("关闭连接")}),t.on("error",function(e,t){console.log("异常关闭")}),o(null,t))})},rabbitMQCreateChannel:function(e,o){e.createChannel(function(e,t){e?o(e):o(null,t)})},sendMQMail:function(i,e,r){var s=e.type,l=e.exchangeKey,u=Buffer.from(e.content),c=e.routingKey;i.assertExchange(l,s,{durable:!1},function(e,t){if(e&&r(e),"headers"==s){var o=JSON.parse(c),a={headers:{}};for(var n in o)a.headers[n]=o[n];i.publish(l,"",u,a)}else"fanout"==s?i.publish(l,"",u):i.publish(l,c,u);i.close(),r()})},receiveMQMail:function(i,e,r){var s=e.type,l=e.exchangeKey,u=e.routingKey;i.assertExchange(l,s,{durable:!1},function(e){e?r(e):i.assertQueue("",{exclusive:!0},function(e,t){if(e)r(e);else{var o=t.queue,a=0;if("headers"==s)var n=function(e){e?r(e):i.bindQueue(o,l,"",u)};else n="fanout"==s?function(e){i.bindQueue(o,l,"")}:function(e){e?r(e):a<u.length&&(i.bindQueue(o,l,u[a],{},n),a++)};i.consume(o,function(e){r(null,e)},{noAck:!0},function(e){e?r(e):n(null)})}})})}};General.Rabbitmq.RabbitMQMail=Se;Se=General.Rabbitmq.RabbitMQMail;var be=function(){_.callSuper(be,this,arguments),this._name="rabbitmq",this.focusedEventArray=[{event:"receiveRabbitMQMail",onEvent:"receiveRabbitMQMail"},{event:"_sendRabbitMQMail",onEvent:"_sendRabbitMQMail"}]};_.extend(be,h,{getExports:function(){return["sendRabbitMQMail","startRabbitMQMail","closeRabbitMQMail","getRabbitMQSettings","createRabbitMQMail"]},loadModuleSettings:function(e,t){this.config=e.config,this.rabbitMQConnect()},runningOnPlatform:function(){_.invokeSuper(be,"runningOnPlatform",this,arguments)},preRunningOnPlatform:function(){_.invokeSuper(be,"preRunningOnPlatform",this,arguments)},rabbitMQConnect:function(e,o){var t=e||this.config,a=this;Se.rabbitMQConnect(t,function(e,t){e?(o&&o(e),console.log("连接RabbitMQ失败："+JSON.stringify(e))):o?o(null,t):(a.baseRabbitMQConn=t,d.fireEvent("rabbitMQConnected"))})},rabbitMQCreateChannel:function(o,e){e=e||this.baseRabbitMQConn;Se.rabbitMQCreateChannel(e,function(e,t){o(e,t)})},receiveRabbitMQMail:function(e,o,a,t){var n=this,i={exchangeKey:e.exchangeKey,type:e.type,routingKey:e.routingKey},r=i.exchangeKey;this.rabbitMQCreateChannel(function(e,t){e?console.log("创建RabbitMQ通道失败："+JSON.stringify(e)):(n[r]=t,Se.receiveMQMail(t,i,function(e,t){if(e)console.log("接收RabbitMQ消息失败："+JSON.stringify(e)),delete n[r];else{var o=t.content.toString();console.log("接收RabbitMQ消息："+o),t.content=t.content.toString(),a&&a(t)}})),o&&o(e)},t)},_startInitRabbitMQMail:function(){var a=this;g.query("MailSetting",{},function(e){if(e&&0<e.length)for(var t=0;t<e.length;t++){var o=e[t].dataValues;o.settingFlag&&(o.routingKey=JSON.parse(o.routingKey),a.receiveRabbitMQMail(o))}else{a.createReceiveRabbitMQMail({serverName:"模型库",exchangeKey:"message_modelSystem_model",type:"topic",routingKey:["*.test"]})}},function(e){console.log("查询MailSetting表出错")})},rabbitMQCreateChannel:function(o){var e=this.baseRabbitMQConn;Se.rabbitMQCreateChannel(e,function(e,t){o(e,t)})},getRabbitMQSettings:function(e,o,t){var a={type:"getRabbitMQSettings"},n=e.body,i={},r="select * from mailsettings where 1=1";if(n.sorter){var s=n.sorter,l=s.field,u=s.order;r=r+" order by "+l+" "+("ascend"==u?"asc":"desc")}else r+=" order by createTime desc ";n.start&&n.length&&(i.start=parseInt(n.start),i.length=parseInt(n.length),r+=" limit :start, :length "),g.queryFromSql("select count(1) as num from mailsettings where 1=1",{},function(t){g.queryFromSql(r,i,function(e){a.result={length:t[0].num,data:e},a.status=b.S,o.json(a)},function(e){a.error=e.message,a.status=b.F,o.json(a)})},function(e){a.error=e.message,a.status=b.F,o.json(a)})},sendRabbitMQMail:function(e,t,o){var a={type:"sendRabbitMQMail"},n=e.body;this._sendRabbitMQMail(n,function(e){e?(a.status=b.F,a.error=e):a.status=b.S,t.json(a)})},_sendRabbitMQMail:function(o,a,e){this.rabbitMQCreateChannel(function(e,t){e?a(e):Se.sendMQMail(t,o,function(e){a(e||null)})},e)},createReceiveRabbitMQMail:function(e,t,o){var a={settingid:this.generateMailID(),serverName:e.serverName,exchangeKey:e.exchangeKey,type:e.type,routingKey:JSON.stringify(e.routingKey),settingFlag:!0,createTime:new Date};this.receiveRabbitMQMail(e,function(e){e?t(e):g.insert("MailSetting",a,function(){t()},function(e){t(e)})},o)},createRabbitMQMail:function(e,t,o){var a={type:"createRabbitMQMail"},n=e.body;this.createReceiveRabbitMQMail(n,function(e){e?(a.status=b.F,a.error=e.message):a.status=b.S,t.json(a)})},startRabbitMQMail:function(e,t,o){var a={type:"startRabbitMQMail"},n=e.body;n.routingKey=JSON.parse(n.routingKey);var i=n.exchangeKey,r={settingFlag:!0,updateTime:new Date};this[i]?(a.status=b.S,a.data="exist",t.json(a)):this.receiveRabbitMQMail(n,function(e){e?(a.status=b.F,a.error=e.message,t.json(a)):g.update("MailSetting",r,{exchangeKey:i},function(){a.status=b.S,t.json(a)},function(e){a.status=b.F,a.error=e.message,t.json(a)})})},closeRabbitMQMail:function(e,t,o){var a={type:"closeRabbitMQMail"},n=this,i=e.body.exchangeKey,r=this[i],s={settingFlag:!1,updateTime:new Date};r?r.close(function(e){e?(a.status=b.F,a.error=e.message,t.json(a)):(delete n[i],g.update("MailSetting",s,{exchangeKey:i},function(){a.status=b.S,a.data="once",t.json(a)},function(e){a.status=b.F,a.error=e.message,t.json(a)}))}):(a.status=b.S,a.data="none",t.json(a))},testSendRabbitMQMail:function(e){var t=this.generateMailID();d.fireEvent("MailCreated",[{modelName:"Mail",records:[{mailid:t,type:"test",priority:0,heading:"rabbitmq",contents:e,senderid:"system",createid:"system",time:new Date,createTime:new Date}]},{modelName:"MailToAccount",records:[{mtaid:this.generateMailID(),mailid:t,receiverid:"brock.xu",status:"normal",checked:!1}]}],!0)},generateMailID:function(){return _.getTimeGUID(new Date,8)}}),General.Rabbitmq.Module=be,General.Setting={};var Ae={settingid:{type:o.STRING,allowNull:!1},value:{type:o.BLOB,allowNull:!1}};a&&a.registerModel("Setting","setting",Ae),General.Setting.Model=a;var Ie=function(){_.callSuper(Ie,this,arguments),this._name="setting"};_.extend(Ie,c,{getExports:function(){return["updateSettings","getSettings"]},initSetting:function(o,a){var n={settingid:"modulesSetting",value:JSON.stringify(o.moduleSettings)};g.query("Setting",{where:{settingid:"modulesSetting"}},function(e){var t=e.length;o.reloadSettings&&(t=0),1==t?(e[0]=e[0].dataValues,e[0].value?(o.moduleSettings=JSON.parse(e[0].value),a&&a(o)):g.delete("Setting",{},function(e){g.insert("Setting",n,function(e){a&&a(o)},function(e){console.log("init err: "+e.message)})},function(e){console.log("init err: "+e.message)})):g.delete("Setting",{},function(e){g.insert("Setting",n,function(e){a&&a(o)},function(e){console.log("init err: "+e.message)})},function(e){console.log("init err: "+e.message)})},function(e){console.log("init err: "+e.message)})},updateSettings:function(e,t,o){var a={type:"updateSettings"},n=this,i=e.body,r=i.module,s=i.value,l=n._platform._settings.moduleSettings[r];if(r&&s){var u=JSON.parse(s);for(var c in l)null!=u[c]&&null!=u[c]||(u[c]=l[c]);n._platform._settings.moduleSettings[r]=u;var d={value:JSON.stringify(n._platform._settings.moduleSettings)};g.update("Setting",d,{settingid:"modulesSetting"},function(e){n._platform.runModule(r,"loadModuleSettings",[u]),a.status=b.S,a.result={moduleSettings:d.value},t.json(a)},function(e){n._platform._settings.moduleSettings[r]=l,_.responsDBErrorAction(t,a,e)})}else a.status=b.F,a.error={cause:"Invalid request"}},getSettings:function(e,t,o){var a={type:"getSettings"},n=JSON.stringify(this._platform._settings.moduleSettings);a.status=b.S,a.result={moduleSettings:n},t.json(a)}}),General.Setting.Module=Ie,General.Task={};var ke={taskid:{type:o.STRING,allowNull:!1,unique:!0},type:{type:o.STRING,allowNull:!1},creator:{type:o.STRING,allowNull:!1},target:{type:o.STRING,allowNull:!1},groupid:o.STRING,begintime:o.DATE,expectedtime:o.DATE,endtime:o.DATE,desc:o.STRING.BINARY,state:o.STRING,progress:o.INTEGER},Te={taskid:{type:o.STRING,allowNull:!1,unique:!0},followerid:{type:o.STRING,allowNull:!1}};a&&(a.registerModel("Task","task",ke),a.registerModel("TaskFollower","taskfollower",Te)),General.Task.Model=a;ke=function(){};_.extend(ke,s,{}),General.Task.Task=ke;ke=General.Task.Task;var Me=function(){};_.extend(Me,ke,{}),General.Task.ScheduleTask=Me;var De=function(){this._tc=new l,_.callSuper(De,this,arguments)};_.extend(De,s,{addTask:function(e,t){e.taskid=_.getTimeGUID(new Date,10),g.insert("Task",e,t,t)},checkUnCompletedTask:function(t){g.query("Task",{},function(e){},function(e){t(null,e)})},getUnCompletedOption:function(e){},updateTask:function(e,t,o){e.taskid}}),General.Task.TaskManager=De;var Ne=function(){_.callSuper(Ne,this,arguments),this._name="task"};_.extend(Ne,c,{}),General.Task.Module=Ne;var Ee=function(e){this._name="TaskStack",this._WaitTaskPool=[],this.isRuning=!0,this.init(e)};_.extend(Ee,Object,{init:function(e){var t=e?e.poolType:null,o=e?e.execType:null;this.poolType=t||"stack",this.execType=o||0},push:function(e){e&&this._WaitTaskPool.push(e)},start:function(e){this.isRuning=!0,this.runTaskSchedule(e)},stop:function(){this.isRuning=!1},runTaskSchedule:function(e){var t=this,o=t.execType;0===o?t.execTaskSchedule(t,e):1===o&&setTimeout(function(){t.execTaskSchedule(t),t.isRuning&&setTimeout(arguments.callee,20)},20)},execTaskSchedule:function(e,t){if(!e.isRuning)return null;if(0===e.execType)(a=e._WaitTaskPool.pop())?a.exec(function(){0==e._WaitTaskPool.length&&t&&t(e),e.execTaskSchedule(e)},a.execParams):setTimeout(function(){e.execTaskSchedule(e)},200);else if(1===e.execType){var o=this._WaitTaskPool.length;if(o){var a,n="stack"===this.poolType?o-1:0;(a=this._WaitTaskPool[n]).exec(function(){});var i=0<n?n-1:0;this._WaitTaskPool.splice(i,1)}}}}),General.TaskStack=Ee,General.Uploading={};var Re=require("formidable"),_e=require("os").freemem(),Ge=function(){_.callSuper(Ge,this,arguments),this._name="uploading"};_.extend(Ge,c,{getExports:function(){return["uploading","deleteFolderRecursive","uploadFile"]},loadModuleSettings:function(e,t){this.Dir=e.uploadDir},uploading:function(e,a,t,o){var n={action:"uploading"},i=this,r=e.baseUrl,s=e.originalUrl.split(r+"/")[1];s&&(o=s);var l=new Re.IncomingForm;l.encoding="utf-8",l.uploadDir=this._platform._settings.moduleSettings.uploading.uploadDir;var u=this._platform._settings.moduleSettings.uploading.maxFieldsSize;l.maxFieldsSize=1024*(u||10)*1024,l.keepExtensions=!0;var c=function(e,t,o){e?(n.status=b.F,n.error=e,a.json(n)):(n.status=b.S,n.result={url:t.split("/public/")[1],avatarName:o},n.url=t.split("/public/")[1],a.end(JSON.stringify(n)))};this.fileExists(l.uploadDir,function(){i.uploadfile(l,e,c,o)})},uploadApplication:function(l,u,e){var c={action:"uploadApplication"},o=this,d={},t=l.session.user.aid;d.project="ebp",d.userid=t,g.queryFromSql("select uploadresourceid from uploaduserresources where project=:project and userid=:userid and classification=:classification",{project:"ebp",userid:t,classification:"aaa"},function(e){var t=e[0];d.req=l,t&&t.uploadresourceid&&(d.uploadresourceid=t.uploadresourceid);d.callback=function(e,t){if(e)c.status=b.F,c.error=e,u.json(c);else{for(var o=[],a=[],n=0;n<t.length;n++){var i={},r={};i.pathid=_.getTimeGUID(new Date,6),d.uploadresourceid?i.uploadresourceid=d.uploadresourceid:i.uploadresourceid="";var s=l.headers.origin+D.sep+D.join("module","uploading","redirectURL",i.uploadresourceid+"&"+i.pathid);r.url=s,r.avatarName=t[n].avatarName,r.name=t[n].name,i.dir=t[n].newPath,i.name=t[n].name,i.avatarname=t[n].avatarname,o.push(i),a.push(r)}g.batchInsert("Uploadresourcepath",o,function(){c.status=b.S,c.result=a,u.json(c)},function(e){var t={};t.cause=e,c.status=b.F,c.error=t,u.json(c)})}},o.uploadFile(d)})},uploadFile:function(i){var r,t=this,o=i.req,a=i.callback,e=i.myUseDir?i.myUseDir:this.Dir,n=i.project,s=i.userid,l=i.otherParam,u=i.uploadresourceid,c=i.filetype||"",d=i.newname?i.newname:null,f=new Re.IncomingForm,h=i.notRename;f.encoding="utf-8",f.keepExtensions=!0,f.multiples=!0,f.maxFieldsSize=i.maxfieldssize||734003200,r=n&&s?i.uploaddir?D.join(e,n,s,i.uploaddir):D.join(e,n,s):n&&l?i.uploaddir?D.join(e,n,l,i.uploaddir):D.join(e,n,l):n?i.uploaddir?D.join(e,n,i.uploaddir):D.join(e,n):s?i.uploaddir?D.join(e,s,i.uploaddir):D.join(e,s):i.uploaddir?D.join(e,i.uploaddir):e,f.uploadDir=r;var m=function(){t.fileExists(r,function(){var e={form:f,req:o,uploadDir:r,fileType:c,notRename:h,newname:d,callback:a};l&&(e.otherParam=l),t._upload(e)})};u?t.getUploadfilesetting(u,function(e){if(e.length){var t,o=e[0].maxfieldssize;if(o){var a=o.split("*");if(t=a[0],1<a.length)for(var n=1;n<a.length;n++)t*=parseInt(a[n])}f.maxFieldsSize=t||i.maxfieldssize||5242880,c=e[0].filetype||i.filetype||"",e[0].uploaddir&&(r=D.join(r,e[0].uploaddir)),m()}else m()}):m()},judgeFiletype:function(e,t){var o=e.split(",");if(o.length)for(var a=0;a<o.length;a++)if(!o[a]||o[a]==t)return!0;return!1},getUploadfilesetting:function(e,t){g.queryFromSql("select * from uploadsettings where uploadresourceid=:uploadresourceid",{uploadresourceid:e},function(e){t&&t(e)})},_upload:function(e){var v=e.form,t=e.req,y=e.uploadDir,w=e.fileType,S=e.notRename,b=e.newname,A=e.callback,I=e.otherParam,k=this;v.parse(t,function(e,t,o){if(e){(p={errorcode:"100202"}).cause=T[p.errorcode]+e,A(e)}else{var a=[],n=!0,i=[];for(var r in o){var s=o[r];if(k.judgeFiletype(w,s.type)){var l=s.size;if(l<=v.maxFieldsSize)if(l<_e){var u,c=s.name,d=D.extname(c),f=(u=c.split("."))[u.length-1];d=Date.parse(new Date)+_.getGUID(4)+d;var h="",m="";S?"keyRename"==S&&"file"!=r?"objModel"==r?"obj"==f||"mtl"==f||"bin"==f||"gltf"==f?(m=I+"."+f,h=D.join(y,m)):h=D.join(y,c):(m=r+"."+f,h=D.join(y,m)):h=D.join(y,c):h=b?D.join(y,b):D.join(y,d),M.renameSync(s.path,h);var g={};g.newPath=h,g.name=d,g.avatarname="file"!=r?"objModel"==r?"obj"==f||"mtl"==f||"bin"==f||"gltf"==f?m:c:m:c,a.push(g)}else{var p={errorcode:"100202",cause:"There is not enough memory space for such a large File"};n=!1,i.push(p)}else{p={errorcode:"100200",cause:"File size should be less than 5M"};n=!1,i.push(p)}}else{p={errorcode:"100201",cause:"File format error!"};n=!1,i.push(p)}}n?A(null,a):A(i)}})},redirectURL:function(e,a,t){var o,n=D.basename(e.originalUrl);o="select * from uploadresourcepaths where uploadresourceid='"+(n=n.split("&"))[n.length-2]+"'and pathid='"+n[n.length-1]+"'",g.queryFromSql(o,{},function(e){var t=e[0],o=t.dir;a.download(o,t.avatarname)})},getTypeAndDir:function(e,t,o){var a={};a.saveDir=o?this._platform._settings.moduleSettings.uploading.saveDir+"/"+o:this._platform._settings.moduleSettings.uploading.saveDir,a.fileType=[],t&&t(a)},fileExists:function(e,n){for(var t,i=D.resolve(e).split(D.sep),o=process.cwd(),a=o.split(D.sep),r=a[a.length-1],s=1;s<i.length;s++)i[s]==r&&(t=s+1);var l=o,u=i.length,c=t;l=D.join(l,i[c]);var d=function(t,o,a){o++,M.exists(t,function(e){e||M.mkdirSync(t),o==a?n&&n():d(D.join(t,i[o]),o,a)})};d(l,c,u)},uploadfile:function(s,e,l,u){var c=this;s.parse(e,function(e,t,o){if(e){(r={errorcode:"100202"}).cause=T[r.errorcode]+e,l(e)}else{var a;for(var n in o)o.file=o[n];if(o.file.size<=s.maxFieldsSize){var i=o.file.name;c.getTypeAndDir(l,function(e){var t=(a=e.saveDir)+"/"+i;c.fileExists(a,function(){c.upload(o,t,l)})},u)}else{var r;(r={errorcode:"100200"}).cause=T[r.errorcode],l(r)}}})},upload:function(e,t,o){M.renameSync(e.file.path,t),o(null,t,e.file.name)},uploadBase64:function(e,a,t,o){var n={action:"uploadBase64"},i=this,r=this._platform._settings.moduleSettings.uploading.uploadDir,s=function(e,t,o){e?(n.status=b.F,n.error=e,a.json(n)):(n.status=b.S,n.result={url:t.split("/public/")[1],avatarName:o},a.end(JSON.stringify(n)))};this.fileExists(r,function(){i._setBase64Pic(e,s,o)})},_setBase64Pic:function(e,o,t){var a=e.body,n=a.base64,i=a.fileName,r=n.replace(/^data:image\/\w+;base64,/,""),s=new Buffer(r,"base64"),l=this._platform._settings.moduleSettings.uploading.saveDir+"/"+t+"/";this.fileExists(l,function(){var t=l+i;M.writeFile(t,s,function(e){e?o(e):o(null,t,i)})})},_savePicByBase64:function(e,o){var t=e.base64,a=e.fileName,n=t.replace(/^data:image\/\w+;base64,/,""),i=new Buffer(n,"base64"),r=this._platform._settings.moduleSettings.uploading.uploadDir+"/"+e.path_url+"/";this.fileExists(r,function(){var t=r+a;M.writeFile(t,i,function(e){e?o(e):o(null,t,a)})})},deleteFolderRecursive:function(e,t,o){var a={action:"deleteFolderRecursive"},n=e.body.url;if(n)if(Array.isArray(n))for(var i=0;i<n.length;i++)n[i]=this._platform._settings.moduleSettings.uploading.publicDir+"/"+n[i],this.deleteFolderRecursiveUnit(n[i]);else n=this._platform._settings.moduleSettings.uploading.publicDir+"/"+n,this.deleteFolderRecursiveUnit(n);a.status=b.S,a.url=n,t.end(JSON.stringify(a))},deleteFolderRecursiveUnit:function(a){var n=this;M.existsSync(a)?M.statSync(a).isDirectory()?(M.readdirSync(a).forEach(function(e,t){var o=D.join(a,e);M.statSync(o).isDirectory()?n.deleteFolderRecursiveUnit(o):M.unlinkSync(o)}),M.rmdirSync(a)):M.unlinkSync(a):console.log("给定的路径不存在，请给出正确的路径")}}),General.Uploading.Module=Ge,General.Websocket={};var Fe=require("nodejs-websocket"),qe=function(){_.callSuper(qe,this,arguments),this._name="websocket",this.focusedEventArray=[{event:"receiveSocketMail",onEvent:"receiveSocketMail"},{event:"sendSocketMail",onEvent:"sendSocketMail"}]};_.extend(qe,h,{getExports:function(){return[]},loadModuleSettings:function(e,t){this.config=e.config,this.initSocketService()},runningOnPlatform:function(){_.invokeSuper(qe,"runningOnPlatform",this,arguments)},preRunningOnPlatform:function(){_.invokeSuper(qe,"preRunningOnPlatform",this,arguments)},initSocketService:function(){var e=this.config.protocol?this.config.protocol:"http",t=this,o=this.config.port,a={};if("https"==e){a.secure=!0;var n=this.config.privateKeyPath,i=this.config.certificatePath;a.key=M.readFileSync(n,"utf8"),a.cert=M.readFileSync(i,"utf8")}else a.secure=!1;this.server=Fe.createServer(a,function(e){e.on("text",function(e){t.sendSocketMail(e)}),e.on("close",function(e,t){d.fireEvent("closedSocket"),console.log("Connection closed")}),e.on("error",function(e,t){d.fireEvent("errorSocket")})}),this.server.listen(o)},sendSocketMail:function(t,o){this.server.connections.forEach(function(e){e.sendText(t,function(e){o&&o(e)})})},receiveSocketMail:function(e){var t=this.config.hostname,o=this.config.port,a="";a="https"==(this.config.protocol?this.config.protocol:"http")?"wss://"+t+":"+o+"/chat":"ws://"+t+":"+o+"/chat",e(Fe.connect(a,{rejectUnauthorized:!1}))}}),General.Websocket.Module=qe,General.Wechat={};var Ce={appkey:{type:o.STRING,unique:"key"},openid:{type:o.STRING,unique:"key"},user:o.STRING},Oe={appkey:{type:o.STRING,allowNull:!1,unique:!0},wechatID:o.STRING,appid:{type:o.STRING,allowNull:!1},appsecret:{type:o.STRING,allowNull:!1},wechatToken:{type:o.STRING,allowNull:!1},desc:{type:o.STRING,allowNull:!1},loginurl:o.STRING,projecturl:o.STRING};a&&(a.registerModel("WechatBind","wechatbind",Ce),a.registerModel("WechatRegister","wechatregister",Oe)),General.Wechat.Model=a;var xe=function(){_.callSuper(xe,this,arguments),this._name="wechat"};_.extend(xe,c,{loadModuleSettings:function(e){this.defaultSettings=e},getExports:function(){return["signin","bindWechat"]},signin:function(a,n,e){var i={type:"wechatsignin"},t=a.body,r=(a.session,this),s=t.code,l=t.appkey,o=t.openid,u=function(o,e){var t={appkey:e,openid:o};r._loginWithOpenid(a,n,t,i,function(e,t){t?(i.status=b.F,i.error=t):(e.openid=o,i.status=b.S,i.result=e),n.json(i)})};s?g.query("WechatRegister",{where:{appkey:l}},function(e){if(1==e.length){var a=e[0].dataValues,t={appID:a.appid,appSecret:a.appsecret,code:s,callback:function(e){if(!e||e.errcode)return i.status=b.F,i.error={errorcode:"500008",message:T[500008],cause:"Can not get OpenID by code: "+s},void n.json(i);var t=e.openid;if(a.loginurl){i.status=b.S;var o={openid:t,tokenReply:e};_.isNull(a.projecturl)||(o.projecturl=a.projecturl),_.isNull(a.loginurl)||(o.loginurl=a.loginurl),i.result=o,n.json(i)}else u(t,l)}};this.getOpenid(t)}else i.status=b.F,i.error={errorcode:"500007",message:T[500007]},n.json(i)},function(e){}):u(o,l)},wechatLogin:function(o,a,e){var n={type:"wechatlogin"},t=o.body,i=(o.session,t.code),r=t.appkey,s=this.defaultSettings,l=s.benbangtukey,u=this;if(l==r){var c={appID:t.appID||s.appID,appSecret:t.appSecret||s.appSecret,code:i,callback:function(e){if(!e||e.errcode)return n.status=b.F,n.error={cause:"Can not get OpenID by code: "+i},void a.json(n);var t=e.openid;o.session.weixinUser=t,u.getUserInfoByOpenid(e.access_token,e.openid,function(e){n.result=e,n.status=b.S,a.json(n)})}};this.getOpenid(c)}else n.status=b.Failed,n.error={errorcode:"1232312",cause:"Not a Wechat follower"},a.json(n)},_loginWithOpenid:function(o,a,e,n,i){var r=o.session,t={appkey:e.appkey},s=this._platform;t.openid=e.openid,t.appkey=e.appkey,g.query("WechatBind",{where:t},function(e){if(1==e.length){var t=e[0].dataValues;t.callback=function(e,t){t?(n.status=b.F,n.error=t):(s.runModule("auth","appendToken",[o,e]),s.runModule("auth","appendUserInfo",[r,e]),n.status=b.S,n.result={isValidated:!0,menusettings:e.menusettings},n.token=e.token,n.user=e.aid,a.cookie("account",{account:e.aid,last:new Date},{maxAge:6e4}),delete e.menusettings),a.json(n)},s.runModule("auth","_signin",[t])}else i({next:"bind"})},function(e){i(null,e)})},bindWechat:function(a,n,e){var t=a.body,i=this._platform,r=this,s=a.session,l={type:"bindWechat"},o=(t.appkey,{aid:t.aid,pwd:t.pwd,callback:function(o,e){e?(l.status=b.F,l.error=e,n.json(l)):r._bindWechat(t,function(e,t){t?(l.status=b.F,l.error=t):(i.runModule("auth","appendToken",[a,o]),i.runModule("auth","appendUserInfo",[s,o]),l.status=b.S,l.result={isValidated:!0,menusettings:o.menusettings},l.token=o.token,l.user=o.aid,n.cookie("account",{account:o.aid,last:new Date},{maxAge:6e4}),delete o.menusettings),n.json(l)})}});i.runModule("auth","_signin",[o])},_bindWechat:function(t,o){this._platform;t.user&&t.openid&&t.appkey?g.query("WechatBind",{where:{appkey:t.appkey,openid:t.openid}},function(e){0==e.length?g.insert("WechatBind",t,function(e){o&&o()},function(e){o(null,{errorcode:"300001",message:T[300001],cause:"Binding wechat account :\n"+JSON.stringify(e)})}):o(null,{errorcode:"100030",message:T[100030]})},function(e){o(null,{errorcode:"300001",message:T[300001],cause:"query WechatBind :\n"+JSON.stringify(error)})}):o(null,{errorcode:"000100",message:T["000100"],cause:T["000100"]+" when binding wechat account"})},getOpenid:function(e){var t=e.appID,o=e.appSecret,a=e.code,n=e.callback,i="https://api.weixin.qq.com",r="/sns/oauth2/access_token?appid="+t+"&secret="+o+"&code="+a+"&grant_type=authorization_code";e={host:i,path:r};require("https").request(i+r,function(e){var t="";e.on("data",function(e){t+=e}),e.on("end",function(){var e=JSON.parse(t);n&&n(e)})}).on("error",function(e){console.log("HTTS GET :"+options.host+options.pan+" error: "+JSON.stringify(e))}).end()},getUserInfoByOpenid:function(e,t,a){var o="/sns/userinfo?access_token="+e+"&openid="+t+"&lang=zh_CN";require("https").request("https://api.weixin.qq.com"+o,function(e){var o="";e.on("data",function(e){o+=e}),e.on("end",function(e){var t=JSON.parse(o);a&&a(t)})}).end()}}),General.Wechat.Module=xe,General.WorkFlow={},General.WorkFlow.Unit={},General.WorkFlow.Activities={},General.WorkFlow.Activities.Events={},General.WorkFlow.Activities.Gateways={},General.WorkFlow.Activities.Tasks={};var We={uniqueid:{type:o.STRING,allowNull:!1,unique:!0},flowdataid:{type:o.STRING,allowNull:!1},workflowid:{type:o.STRING,allowNull:!1},workflowversion:{type:o.STRING,allowNull:!1},activityid:{type:o.STRING,allowNull:!1},activitytype:{type:o.STRING,allowNull:!1},finished:{type:o.ENUM,values:["0","1"],defaultValue:"0"},status:{type:o.STRING},starttime:{type:o.DATE,allowNull:!1},updatetime:{type:o.DATE,allowNull:!1},formid:{type:o.STRING},operate:{type:o.ENUM,values:["agree","back","refuse","levelUpdate"],defaultValue:"agree"},operator_userid:{type:o.STRING},operator_roleid:{type:o.STRING},starttotargetactivityid:{type:o.STRING},targetexcuteactivityid:{type:o.STRING}},je={workflowengineid:{type:o.STRING,allowNull:!1,unique:"workflowengineIndex"},workflowversion:{type:o.STRING,allowNull:!1,unique:"workflowengineIndex"},workflowname:{type:o.STRING,allowNull:!1},getformdatamethod:{type:o.STRING,allowNull:!1},updateformdatamethod:{type:o.STRING,allowNull:!1},workflowjson:{type:o.BLOB("medium"),allowNull:!1},createtime:{type:o.DATE,allowNull:!1},load:{type:o.ENUM,values:["0","1"],defaultValue:"1"}},Pe={apiid:{type:o.STRING,allowNull:!1,unique:!0},api:{type:o.STRING,allowNull:!1,unique:"apiIndex"},workflowengineid:{type:o.STRING,allowNull:!1,unique:"apiIndex"},activityid:{type:o.STRING,allowNull:!1,unique:"apiIndex"},value:{type:o.STRING,allowNull:!1}};a&&(a.registerModel("FlowData","flowdata",We),a.registerModel("WorkFlowEngine","workflowengine",je),a.registerModel("WorkFlowEngineAuth","workflowengineauth",Pe)),General.WorkFlow.Model=a;var Le=function(){_.callSuper(Le,this,arguments),this.focusedEventArray=[]};_.extend(Le,Object,{initEventModule:function(){if(this.focusedEventArray)for(var o=this,e=0;e<this.focusedEventArray.length;e++){!function(e){var t=function(){e.driveEvent&&Array.prototype.splice.call(arguments,0,0,e.driveEvent),"function"==typeof e.onEvent?e.onEvent.apply(o,arguments):o[e.onEvent].apply(o,arguments)};t.id=o.workflowid+"_"+o.id+"_"+e.event,d.subscribe(e.event,t)}(this.focusedEventArray[e])}},runningOnWorkflow:function(){this.initEventModule()},disposeModule:function(){if(_.invokeSuper(Le,"disposeModule",this,arguments),this.focusedEventArray)for(var t=this,e=0;e<this.focusedEventArray.length;e++){var o=this.focusedEventArray[e];d.listeners(o.event).forEach(function(e){e.id==t.workflowid+"_"+t.id+"_"+o.event&&d.removeListener(o.event,e)})}}}),General.WorkFlow.Unit.EventEmitter=Le;var Be={validateProsInObject:function(e,t){var o={},a=!0;if(e&&t)if(e&&Array.isArray(e))for(var n=0;n<e.length;n++){var i=e[n],r=t[i.name],s=i.type;r&&typeof r==s?o[i.name]=r:(a=!1,console.log("validateProsInObject：数据中不包含参数："+JSON.stringify(r)+"（type："+s+"）"))}else console.log("validateProsInObject：pros数据格式不正确 (pros:"+JSON.stringify(e)+" ;object:"+JSON.stringify(t)+")"),a=!1;else console.log("validateProsInObject：pros或object数据格式不正确 (pros:"+JSON.stringify(e)+" ;object:"+JSON.stringify(t)+")"),a=!1;return a?o:null},validateOutputData:function(e){var t=e.direct,o=e.callback,a=e.defaultOutputData,n=a.direct,i=a.callback;if(0<t.length&&0<o.length||0<n.length&&0<i.length)console.log(this.id+" output 中不能对相同的method或默认的execute同时给出同步和回调的输出定义！");else{if(!(1<t.length||1<o.length||1<n.length||1<i.length))return!0;console.log(this.id+" output 中不可对method或默认的execute定义相同的同步或者回调的输出定义！")}return!1}};General.WorkFlow.Unit.ValidateUtil=Be;Pe=function(){this._apiWeight={}};_.extend(Pe,Object,{initAuthorizations:function(e,t,o){try{this._platform=e;var a={};for(var n in t)_.copySimpleObject(t[n].getCapabilities(),a);var i=[];for(var r in a){var s=a[r];for(var l in s)for(var u=s[l],c=0;c<u.length;c++){var d={workflowengineid:r,activityid:l};d.api=u[c],i.push(d)}}var f=this;f.loadAuthorizationDefine("WorkFlowEngineAuth",i,function(){f.initAuthorizationsToActivity(t),_.log("load WorkFlowEngineAuth init success"),o&&o()},function(e){var t=e.message?e.message:e.desc;o&&o(new Error(t)),_.log("load WorkFlowEngineAuth init failed:"+t)})}catch(e){o&&o(e),_.log("load WorkFlowEngineAuth init failed:"+e.message)}},initAuthorizationsToActivity:function(e,t){var o=this._apiWeight,a=this._platform._settings.moduleSettings.auth.roles.common;if(t)for(var n in e){if(c=e[n].activities)for(var i in c)for(var r=c[i],s=0;s<r.length;s++)r[s].authorizations=null,delete r[s].authorizations}for(var l in o){var u=o[l];for(var n in e){var c;if(u.workflowengineid==e[n].id)if(c=e[n].activities)for(var i in c)for(r=c[i],s=0;s<r.length;s++){var d=r[s];if(u.activityid==d.id){d.authorizations||(d.authorizations={}),d.localRole||(d.localRole=a);var f={};f[l]=u,_.copySimpleObject(f,d.authorizations)}}}}},updateAuthorizationsToActivity:function(e,t){var o=this._apiWeight[e];for(var a in t)if(o.workflowengineid==t[a].id){var n=t[a].activities;if(n)for(var i in n)for(var r=n[i],s=0;s<r.length;s++){var l=r[s];o.activityid==l.id&&(l.authorizations||(l.authorizations={}),l.authorizations[e]=o)}}},loadAuthorizationDefine:function(s,l,u,c){var d=this;g.query(s,{},function(e){var t=e.length,o=l.length,a=[];if(0<t){for(var n=0;n<o;n++){for(var i=0;i<t&&(e[i].api!=l[n].api||e[i].workflowengineid!=l[n].workflowengineid||e[i].activityid!=l[n].activityid);i++);if(i==t){var r={api:l[n].api,value:1,apiid:_.getTimeGUID(new Date,12),workflowengineid:l[n].workflowengineid,activityid:l[n].activityid};d._apiWeight[r.apiid]=r,a.push(r)}}for(n=0;n<t;n++){r={api:e[n].api,value:parseInt(e[n].value),apiid:e[n].apiid,activityid:e[n].activityid,workflowengineid:e[n].workflowengineid};d._apiWeight[r.apiid]=r}0<a.length?d.insertAuthorizations(s,a,function(){u&&u()},function(e){c&&c(e)}):u&&u()}else{for(n=0;n<o;n++){r={api:l[n].api,value:1,apiid:_.getTimeGUID(new Date,12),activityid:l[n].activityid,workflowengineid:l[n].workflowengineid};d._apiWeight[r.apiid]=r,a.push(r)}d.insertAuthorizations(s,a,function(){u&&u()},function(e){c&&c(e)})}},function(e){c&&c(e),_.wrapDBErrorAction({type:"loadRoleDefine"},e)})},insertAuthorizations:function(e,t,o,a){for(var n=[],i=0;i<t.length;i++){var r={};_.copySimpleObject(t[i],r),r.value=r.value+"",n.push(r)}g.batchInsert(e,n,function(e){o&&o(e)},function(e){a&&a(e)})},unloadAuthorizationByWorkflow:function(t,o,a,n){var i=this;g.delete("WorkFlowEngineAuth",{workflowengineid:o},function(){for(var e in i._apiWeight)i._apiWeight[e].workflowengineid==o&&(i._apiWeight[e]=null,delete i._apiWeight[e]);i.initAuthorizationsToActivity(t),a&&a()},function(e){n&&n(e)})},addMethod2Role:function(e,t,o,a,n,i){var r=this.getRoles(null,null,a.rolekey)[t];return this.updateApiValue(o,e,r.value,"add",n,i)},addMethod2RoleFromRoleId:function(e,t,o,a,n,i){var r=this.getRoles(null,null,a.rolekey),s=r[o],l=r[t];for(var u in this._apiWeight)0!=(this._apiWeight[u].value&s.value)&&this.updateApiValue(u,e,l.value,"add")},removeMethodFromRole:function(e,t,o,a){var n=this.getRoles(null,null,a.rolekey)[t];0!=(this._apiWeight[o].value&n.value)&&this.updateApiValue(o,e,n.value,"remove")},removeAllMethodFromRole:function(e,t,o,a){var n=this._roles[t],i=this._apiWeight;for(var r in i){0!=(i[r].value&n.value)&&this.updateApiValue(r,e,n.value,"remove")}},updateApiValue:function(t,o,e,a,n,i){if(_.isPowerOf2(e)){var r=this._apiWeight[t];_.isNull(r.value)&&(r.value=1),"add"==a?r.value=r.value|e:0!=(r.value&e)&&(r.value=r.value-e);var s=this;g.update("WorkFlowEngineAuth",r,{apiid:r.apiid},function(e){s.updateAuthorizationsToActivity(t,o),n&&n(r)},function(e){_.wrapDBErrorAction({type:"updateApiValue"},e),i&&i(e)})}else i&&i("value is not in PowerOf2")},getAuthorizationMessage:function(e,t,o){var a=this._apiWeight,n=[];if(0<Object.getOwnPropertyNames(a).length){var i=this.getRoles(null,null,o.rolekey),r=i[e],s=i[t];for(var l in a)e&&r?0!=(r.value&a[l].value)&&n.push(a[l]):t&&s?0==(s.value&a[l].value)&&n.push(a[l]):n.push(a[l])}return n},getRoles:function(e,t,o){var a=this._platform.runModule("auth","_getRoleMessage",[e,t,o]),n={};return a.forEach(function(e){n[e.roleid]=e}),n}}),General.WorkFlow.WorkFlowEngineAuth=Pe;Le=General.WorkFlow.Unit.EventEmitter;var Ue=General.WorkFlow.Unit.ValidateUtil,Je=function(e){_.callSuper(Je,this,arguments),this._name="Activity",this._type="Activity",this._config=e,this.initConfig(e),this.workFlowPauseData={},this.workFlowPause=!1,this.workFlowPauseArguments={},d.subscribe(this.workflowid+"_workFlowActivityPause",function(e){e?(this.workFlowPauseData[e]=!0,_.log("Workflow: "+this.workflowid+" Flowdataid: "+e+" has been paused!")):(this.workFlowPause=!0,_.log("Workflow: "+this.workflowid+" has been paused!"))}.bind(this)),d.subscribe(this.workflowid+"_workFlowActivityContinue",function(e){if(e)this.workFlowPauseData[e]&&(delete this.workFlowPauseData[e],(t=this.workFlowPauseArguments[e])&&(this.complete.apply(this,t),_.log("Workflow: "+this.workflowid+" Flowdataid: "+e+" is going on!")));else if(this.workFlowPause)for(var e in this.workFlowPause=!1,this.workFlowPauseData){var t;if(this.workFlowPauseData[e])delete this.workFlowPauseData[e],(t=this.workFlowPauseArguments[e])&&(this.complete.apply(this,t),_.log("Workflow: "+this.workflowid+" Flowdataid: "+e+" is going on!"))}}.bind(this))};_.extend(Je,Le,{getExports:function(){return["startRunning","complete"]},initConfig:function(e){this.workflowid=e.workflowid,this.id=e.id,this.type=e.type,this.name=e.name,this.status=e.status,this.input&&Array.isArray(this.input)&&(e.input?Array.isArray(e.input)&&(e.input=this.input.concat(e.input)):e.input=this.input),this.input=e.input||[],this.output&&Array.isArray(this.output)&&(e.output?Array.isArray(e.output)&&(e.output=this.output.concat(e.output)):e.output=this.output),this.output=e.output||[],this.extendMethods=e.extendMethods||[],this.rules=e.rules||[],this.wait=!1,this.isStart=!1,this.isEnd=!1},setParams:function(e){this.inbound=e.inbound,this.outbound=e.outbound,this.multipleInbound=1<this.inbound.length,this.multipleOutbound=1<this.outbound.length},runningOnWorkflow:function(){this.setupInboundListeners(),_.invokeSuper(Je,"runningOnWorkflow",this,arguments)},setupInboundListeners:function(){if(this.inbound.length||0!=this.input.length){this.focusedEventArray||(this.focusedEventArray=[]);var t=this;if(this.inbound.forEach(function(e){t.focusedEventArray.push({event:t.workflowid+"_"+e.getSequenceFlowId()+"_taken",onEvent:"onInbound"})}),0<this.input.length)for(var e=0;e<this.input.length;e++){var o=this.input[e];if("event"==o.type)for(var a=o.driveEvents,n=0;n<a.length;n++){var i=a[n];this.focusedEventArray.push({event:this.workflowid+"_"+this.id+"_"+i.eventName,onEvent:"onInputEvent",driveEvent:i})}}}},getActivityId:function(){return this.id},onInbound:function(){var e=arguments[0],t={method:"startRunning",params:e||{}};t.workFlowId=e.flowdata.workflowid,t.flowdataid=e.flowdata.flowdataid,t.activityid=this.id,d.fireEvent(this.workflowid+"_executeActivity",t)},onInputEvent:function(e,t){var o=e.params;o?o.push({name:"flowdata",type:"object"}):o=[{name:"flowdata",type:"object"}];var a=Ue.validateProsInObject(o,t);if(!o||a){var n={method:e.handler,params:t||{}};n.workFlowId=t.flowdata.workflowid,n.flowdataid=t.flowdata.flowdataid,n.activityid=this.id,d.fireEvent(this.workflowid+"_executeActivity",n)}else _.log("事件派发参数验证失败，监听无法响应！")},startRunning:function(e){var t=arguments;d.fireEvent("setFlowDataState",t[0].flowdata,{activityid:this.id,status:this.status,activitytype:this._type,targetExcuteActivityid:e.targetExcuteActivityid,startToTargetActivityid:e.startToTargetActivityid},function(e,t,o){if(t)_.log("activity:"+this.id+" startRunning cause a error: "+t.message);else{_.log("activity:"+this.id+" is running!");var a=e[0];a.flowdata=o,Array.prototype.splice.call(e,0,1,a);var n={method:"complete",params:a||{}};n.workFlowId=o.workflowid,n.flowdataid=o.flowdataid,n.activityid=this.id,d.fireEvent(this.workflowid+"_executeActivity",n)}}.bind(this,t))},complete:function(){var e=arguments,n=e[0].flowdata.flowdataid;this.workFlowPause&&n&&!this.workFlowPauseArguments[n]?n&&(this.workFlowPauseData[n]=!0,this.workFlowPauseArguments[n]=e):n&&this.workFlowPauseData[n]?this.workFlowPauseArguments[n]=e:d.fireEvent("updateFlowDataState",e[0].flowdata,{finished:"1",updatetime:new Date},function(t,e,o){if(!e){var a=t[0];_.copySimpleObject(o,a.flowdata),Array.prototype.splice.call(t,0,1,a),Array.prototype.splice.call(t,0,0,function(e){e||(Array.prototype.splice.call(t,0,1),this.gotoNext.apply(this,t),n&&this.workFlowPauseArguments[n]&&delete this.workFlowPauseArguments[n])}.bind(this)),this.isTerminationElement.apply(this,t)}}.bind(this,e))},execute:function(){var e=arguments[0],t=arguments[1],o=t.flowdata,a=this.localRole&&this.localRole.rolekey?this.localRole.rolekey:2;return this.isAuthorized(e,o&&o.user?o.user.rolekey:a)?this.pause?(_.log("activity:"+this.id+" is pause to wait a message!"),{status:"0",error:new Error("activity:"+this.id+" is pause to wait a message!")}):e?this.executeMethod(e,t):{status:"0",error:new Error("execute function "+e+": not found method ")}:{status:"0",error:new Error("execute function "+e+": permission denied! ")}},isAuthorized:function(e,t){var o,a=this.authorizations;for(var n in a){var i=a[n];i.api==e&&(o=i.value)}return!_.isNull(o)&&0!=(t&o)},executeMethod:function(e,t){var o=this.findMethodType(e);if("direct"==o.type)return this.executeMethodDirectly(e,t,o.outputData);this.executeMethodWithCallback(e,t,o.outputData)},findMethodType:function(e){var t=this.getOutputDatabyType(e),o=t.event,a=t.direct,n=t.callback,i={type:"direct",outputData:{event:o,direct:a,callback:n,defaultOutputData:t.defaultOutputData}};return 0<n.length&&(i.type="callback"),i},executeMethodDirectly:function(e,t,o){var a=this[e];if(a){var n,i=o.event,r=o.direct,s=null;if(0<r.length){if(n=r[0].value?r[0].value:a.apply(this,[t]),s=Ue.validateProsInObject(r[0].pros,n),r[0].pros&&!s)return _.log("execute function : "+e+" direct data error! can't match the output direct params!"),{status:"0",error:new Error("execute function : "+e+" direct data error! can't match the output direct params!")}}else"startRunning"!=e&&"complete"!=e&&"signal"!=e||(n=a.apply(this,[t]));s&&(s.flowdata=t.flowdata),n&&(n.flowdata=t.flowdata);var l=o.defaultOutputData.event,u=o.defaultOutputData.direct;if(0<u.length){var c=u[0].value,d=u[0].pros;d&&(c=Ue.validateProsInObject(d,c)),s||(s={}),n||(n={}),c&&(_.copySimpleObject(c,s),_.copySimpleObject(c,n))}i=i.concat(l);var f=r[0]&&r[0].pros?s:n;return f||(f={}),_.copySimpleObject(f,t),0<i.length&&this.fireOutputEvent(i,t),n&&n.flowdata?{status:"1",result:0<r.length&&r[0].pros?s:n}:"startRunning"==e||"complete"==e||"signal"==e?{status:"1",stopFlowState:!0,result:e+" execute success"}:(_.log("run method error: direct method "+e+" hasn't return value"),{status:"0",error:new Error("run method error: direct method "+e+" hasn't return value")})}return _.log("run method error:  doesnt exist method "+e),{status:"0",error:new Error("run method error:  doesnt exist method "+e)}},executeMethodWithCallback:function(r,e,s){var t=this[r];if(t){var l=s.event,u=s.callback,c=e.callback,d=e.flowdata,f=this;if(u[0].value){var o=u[0].value,a=u[0].pros,n=Ue.validateProsInObject(a,o);if(a&&!n)_.log("execute function : "+r+" callback data error! can't match the output callback params!"),c&&c({status:"0",error:new Error("execute function : "+r+" callback data error! can't match the output callback params!")});else{n&&(n.flowdata=d),o&&(o.flowdata=d);var i=s.defaultOutputData.event,h=s.defaultOutputData.callback;if(0<h.length){var m=h[0].value,g=h[0].pros;g&&(m=Ue.validateProsInObject(g,m)),n||(n={}),o||(o={}),m&&(_.copySimpleObject(m,n),_.copySimpleObject(m,o))}0<(l=l.concat(i)).length&&f.fireOutputEvent(l,a?n:o),o&&o.flowdata&&c&&c({status:"1",result:a?n:o})}}else{e.callback=function(e){this.userCallback=c,this.cboption=u[0],this.flowdata=d,this.methodName=r;var t=Ue.validateProsInObject(this.cboption.pros,e);if(this.cboption.pros&&!t)_.log("execute function : "+this.methodName+" callback data error! can't match the output callback params!"),this.userCallback&&this.userCallback({status:"0",error:new Error("execute function : "+this.methodName+" callback data error! can't match the output callback params!")});else{t&&(t.flowdata=this.flowdata),e&&(e.flowdata=this.flowdata);var o=s.defaultOutputData.event,a=s.defaultOutputData.callback;if(0<a.length){var n=a[0].value,i=a[0].pros;i&&(n=Ue.validateProsInObject(i,n)),t||(t={}),e||(e={}),n&&(_.copySimpleObject(n,t),_.copySimpleObject(n,e))}0<(l=l.concat(o)).length&&f.fireOutputEvent(l,this.cboption.pros?t:e),e&&e.flowdata&&this.userCallback&&this.userCallback({status:"1",result:this.cboption.pros?t:e})}},t.apply(this,[e])}}else e.callback&&e.callback({status:"0",error:new Error("run method error:  doesnt exist method "+r)})},fireOutputEvent:function(e,t){for(var o=0;o<e.length;o++){var a=t,n=e[o].params;switch(n&&(a=Ue.validateProsInObject(n,t)),e[o].dispatchType){case"eventBus":n&&!a?_.log("fireOutputEvent(eventBus) : "+JSON.stringify(e[o])+" error! can't match the output event params!"):d.fireEvent(e[o].eventName,a);break;case"messageServer":n&&!a?_.log("fireOutputEvent(messageServer) : "+JSON.stringify(e[o])+" error! can't match the output event params!"):d.fireEvent(this.workflowid+"_workflow_sendMessage",a,e[o].messageParams);break;case"socketServer":n&&!a?_.log("fireOutputEvent(socketServer) : "+JSON.stringify(e[o])+" error! can't match the output event params!"):d.fireEvent(this.workflowid+"_workflow_socketMessage",a,e[o].socketParams);break;case"mix":n&&!a?(_.log("fireOutputEvent(messageServer) : "+JSON.stringify(e[o])+" error! can't match the output event params!"),_.log("fireOutputEvent(eventBus) : "+JSON.stringify(e[o])+" error! can't match the output event params!")):(d.fireEvent(e[o].eventName,a),d.fireEvent(this.workflowid+"_workflow_sendMessage",a,e[o].messageParams))}}},getOutputDatabyType:function(t){var e={event:[],direct:[],callback:[],defaultOutputData:{event:[],direct:[],callback:[]}};if(0<this.output.length){var o=this.output.filter(function(e){return"event"===e.type});if(0<o.length)for(var a=0;a<o.length;a++){for(var n=o[a].events.filter(function(e){return e.method===t}),i=0;i<n.length;i++)e.event.push(n[i]);var r=o[a].events.filter(function(e){return!e.method||""===e.method});for(i=0;i<r.length;i++)e.defaultOutputData.event.push(r[i])}var s=this.output.filter(function(e){return"direct"===e.type});if(0<s.length)for(a=0;a<s.length;a++){var l=s[a].results.filter(function(e){return e.method===t});for(i=0;i<l.length;i++)e.direct.push(l[i]);var u=s[a].results.filter(function(e){return!e.method||""===e.method});for(i=0;i<u.length;i++)e.defaultOutputData.direct.push(u[i])}var c=this.output.filter(function(e){return"callback"===e.type});if(0<c.length)for(a=0;a<c.length;a++){var d=c[a].callbackParams.filter(function(e){return e.method===t});for(i=0;i<d.length;i++)e.callback.push(d[i]);var f=c[a].callbackParams.filter(function(e){return!e.method||""===e.method});for(i=0;i<f.length;i++)e.defaultOutputData.callback.push(f[i])}}return Ue.validateOutputData.call(this,e)?e:{event:[],direct:[],callback:[],defaultOutputData:{event:[],direct:[],callback:[]}}},gotoNext:function(){var e=arguments[0],t=e.flowdata;if(t.targetexcuteactivityid){var o={method:"startRunning",params:e||{}};if(o.workFlowId=e.flowdata.workflowid,o.flowdataid=e.flowdata.flowdataid,o.activityid=e.flowdata.targetexcuteactivityid,!t.starttotargetactivityid)return void d.fireEvent(this.workflowid+"_executeActivity",o);if(this.id==t.starttotargetactivityid)return void d.fireEvent(this.workflowid+"_executeActivity",o)}this.outbound.length&&d.fireEvent(this.workflowid+"_"+this.id+"_taken",arguments[0])},isTerminationElement:function(e){return this.isEnd?(e&&e(!0),Array.prototype.splice.call(arguments,0,1),d.fireEvent(this.workflowid+"_completeWorkflow",e),!0):(e&&e(!1),!1)},releaseActivity:function(){_.invokeSuper(Je,"disposeModule",this,arguments)}}),General.WorkFlow.Activities.Activity=Je;Le=General.WorkFlow.Unit.EventEmitter;var ze=function(e){_.callSuper(ze,this,arguments),this._name="SequenceFlow",this._type="SequenceFlow",this._config=e,this.initConfig(e)};_.extend(ze,Le,{getExports:function(){return[]},initConfig:function(e){this.workflowid=e.workflowid,this.id=e.id,this.type=e.actype,this.name=e.name,this.sourceId=e.from,this.targetId=e.to,this.conditionExpression=e.conditionExpression},setParams:function(e){this.sourceActivity=e.sourceActivity,this.targetActivity=e.targetActivity},runningOnWorkflow:function(){this.setupListeners(),_.invokeSuper(ze,"runningOnWorkflow",this,arguments)},setupListeners:function(){this.sourceActivity&&(this.focusedEventArray=[{event:this.workflowid+"_"+this.sourceActivity.getActivityId()+"_taken",onEvent:"onSourceTaken"}])},getSequenceFlowId:function(){return this.id},onSourceTaken:function(){this.startRunningSequenceFlow.apply(this,arguments)},startRunningSequenceFlow:function(){this.complete.apply(this,arguments)},complete:function(){this.gotoNext.apply(this,arguments)},gotoNext:function(a){if(this.targetActivity){var n=this;this.evaluateCondition(a,function(e){if(e){var t={},o={};_.copySimpleObject(a.flowdata,o),_.copySimpleObject(a,t),t.flowdata=o,d.fireEvent(n.workflowid+"_"+n.id+"_taken",t)}})}},evaluateCondition:function(e,t){var o=this.conditionExpression;if(o)switch(o.type){case"formParams":this.evaluateConditionForFormParams(o,e,t);break;case"method":this.evaluateConditionForMethod(o,e,t);break;default:if(!o.type){t&&t(!0);break}_.log("未知的断言"+o.type),t&&t(!1)}else t&&t(!0)},evaluateConditionForFormParams:function(e,i,t){var o=i.flowdata;d.fireEvent("getFormMethodDataFromFlowDataUniqueId","getFormData",o.uniqueid,function(e,t,o,a){if(o)t&&t(!1),_.log(JSON.stringify(o));else if(a){Object.assign(a,i);var n=a[e.param];if(n)switch(e.assertion){case">":t&&t(n>e.value);break;case">=":t&&t(n>=e.value);break;case"<":t&&t(n<e.value);break;case"<=":t&&t(n<=e.value);break;case"==":t&&t(n==e.value);break;case"!=":t&&t(n!=e.value);break;case"is null":t&&t(null==n||null==n);break;case"is not null":t&&t(!(null==n||null==n));break;default:_.log("未知的断言"),t&&t(!1)}else t&&t(!1)}}.bind(this,e,t))},evaluateConditionForMethod:function(e,t,o){var a=this[e.method];a?a.apply(this,arguments):(_.log("未知的断言方法"),o&&o(!1))},releaseConnection:function(){_.invokeSuper(ze,"disposeModule",this,arguments)}}),General.WorkFlow.Activities.SequenceFlow=ze;Je=General.WorkFlow.Activities.Activity;var Ve=function(e){_.callSuper(Ve,this,arguments),this._name="EndEvent",this._type="EndEvent",this.isEnd=!0};_.extend(Ve,Je,{startRunning:function(){_.invokeSuper(Ve,"startRunning",this,arguments)},runningOnWorkflow:function(){_.invokeSuper(Ve,"runningOnWorkflow",this,arguments)}}),General.WorkFlow.Activities.Events.EndEvent=Ve;Je=General.WorkFlow.Activities.Activity;var Qe=function(e){_.callSuper(Qe,this,arguments),this._name="MessageEvent",this._type="MessageEvent"};_.extend(Qe,Je,{}),General.WorkFlow.Activities.Events.MessageEvent=Qe;Je=General.WorkFlow.Activities.Activity;var He=function(e){_.callSuper(He,this,arguments),this._name="StartEvent",this._type="StartEvent",this.isStart=!0};_.extend(He,Je,{runningOnWorkflow:function(e){this.isStart=!0,this.isStartEvent=!0,_.invokeSuper(He,"runningOnWorkflow",this,arguments)},startRunning:function(){d.fireEvent("start",this),_.invokeSuper(He,"startRunning",this,arguments)}}),General.WorkFlow.Activities.Events.StartEvent=He;Je=General.WorkFlow.Activities.Activity;var Ke=function(e){_.callSuper(Ke,this,arguments),this._name="TimerEvent",this._type="TimerEvent"};_.extend(Ke,Je,{startRunning:function(e,t,e){var o=arguments;d.fireEvent("setFlowDataState",e.flowdata,{activityid:this.id,status:this.status,activitytype:this._type,targetExcuteActivityid:e.targetExcuteActivityid,startToTargetActivityid:e.startToTargetActivityid},function(e,t,n){t||d.fireEvent("getFormMethodDataFromFlowDataUniqueId","getFormData",n.flowdataid,function(e,t,o){if(!t){var a=e[0];a.flowdata=n,this.bindTimerEvent(a,o,function(e){e||this.complete(a)}.bind(this))}}.bind(this,e))}.bind(this,o))},bindTimerEvent:function(e,t,o){var a={eventId:e.flowdata.flowdataid};if(0<this.input.length)for(var n=0;n<this.input.length;n++){var i=this.input[n];if("TimerEvent"==i.type)for(var r=i.driveEvents,s=0;s<r.length;s++){var l=r[s];a.eventName=l.eventName,a.handler=l.handler;e=l.params;for(var u=0;u<e.length;u++){var c=e[u];"formDate"==c.type&&(a.eventTime=t[c.formKey],a.paramsName=c.name,this._bindTimerEvent(a,function(e){o(e)}))}}}},_bindTimerEvent:function(e,t){var o=e.eventId,a=e.eventName,n=e.handler,i=e.eventTime,r=e.paramsName,s=this,l=new Date,u=new Date(i),c=function(e){f.deleteCronJob(o+a+"_"+r,function(){t(e)})};if(u<l)s[n](c);else{var d=_.getCronDate(new Date(i));f.deleteCronJob(o+a+"_"+r,function(){f.startSyn({global:s,uuid:o+a,prop:r,time:d,func:s[n].bind(s,c)})})}},complete:function(){_.invokeSuper(Ke,"complete",this,arguments)},runningOnWorkflow:function(){_.invokeSuper(Ke,"runningOnWorkflow",this,arguments),this.setupTimerEventListeners()},setupTimerEventListeners:function(){d.fireEvent("getFlowDataByActivityid",this.id,function(e,t){if(!e)for(var o=0;o<t.length;o++){var a=t[o];"0"==a.finished&&d.fireEvent("getFormMethodDataFromFlowDataUniqueId","getFormData",a.flowdataid,function(e,t,o){t||this.bindTimerEvent({flowdata:e},o,function(e,t){t||this.complete({flowdata:e})}.bind(this,e))}.bind(this,a))}}.bind(this))}}),General.WorkFlow.Activities.Events.TimerEvent=Ke;Je=General.WorkFlow.Activities.Activity;var Ye=function(e){_.callSuper(Ye,this,arguments),this._name="ExclusiveGateway",this._type="ExclusiveGateway"};_.extend(Ye,Je,{runningOnWorkflow:function(){_.invokeSuper(Ye,"runningOnWorkflow",this,arguments)}}),General.WorkFlow.Activities.Gateways.ExclusiveGateway=Ye;Je=General.WorkFlow.Activities.Activity;var Xe=function(e){_.callSuper(Xe,this,arguments),this._name="InclusiveGateway",this._type="InclusiveGateway",this.isGotonextQueueTimeout=5e3,this.isGotonextQueue=[],this.isGotonextQueueMethodPoint=null};_.extend(Xe,Je,{runningOnWorkflow:function(){_.invokeSuper(Xe,"runningOnWorkflow",this,arguments);var e=this.input.filter(function(e){return"gateway"===e.type}),t=this;e.forEach(function(e){t.isGotonextMethod=e.method?t[e.method]:t.isGateWayGotonext,t.isGotonextQueueMethod()})},isGotonextQueueMethod:function(){this.isGotonextQueueMethodPoint=setInterval(function(){clearInterval(this.isGotonextQueueMethodPoint);var o=this;if(0<this.isGotonextQueue.length){var a=this.isGotonextQueue.splice(0,1);this.isGotonextMethod(a[0].params,a[0].formdata,function(e,t){!e&&t&&_.invokeSuper(Xe,"startRunning",o,[a[0].params]),this.released||o.isGotonextQueueMethod()})}else this.released||o.isGotonextQueueMethod()}.bind(this),this.isGotonextQueueTimeout)},startRunning:function(){var e=arguments;this.isGotonextMethod&&"function"==typeof this.isGotonextMethod?d.fireEvent("getFormMethodDataFromFlowDataUniqueId","getFormData",arguments[0].flowdata.uniqueid,function(e,t,o){this.isGotonextQueue.push({formdata:o,params:e[0]})}.bind(this,e)):_.invokeSuper(Xe,"startRunning",this,e)},releaseActivity:function(){this.released=!0,clearInterval(this.isGotonextQueueMethodPoint),_.invokeSuper(Xe,"releaseActivity",this,arguments)},isGateWayGotonext:function(e,t,s){var l=this,u=e.flowdata,c=[];this.inbound.forEach(function(e){c.push({flag:!1,activityid:e.sourceId})}),g.queryFromSql("select fd.* from flowdata fd where fd.flowdataid=:flowdataid order by fd.updatetime",{flowdataid:u.flowdataid},function(e){if(0<e.length){for(var t=!0,o=0;o<e.length;o++){for(var a=e[o].activityid,n=e[o].finished,i=0;i<c.length;i++)a==c[i].activityid&&"1"==n?c[i].flag=!0:a==c[i].activityid&&"0"==n&&(c[i].flag=!1);a==l.id&&"1"==n&&new Date(e[o].updatetime).getTime()>new Date(u.updatetime).getTime()?t=!1:a==l.id&&"0"==n&&(t=!0)}var r=!0;for(i=0;i<c.length;i++)r=r&&c[i].flag;s(null,r&&t)}else s&&s(null,!1)},function(e){s&&s(e),_.log("判断gateway是否进入下一步失败："+JSON.stringify(e))})}}),General.WorkFlow.Activities.Gateways.InclusiveGateway=Xe;Je=General.WorkFlow.Activities.Activity;var $e=function(e){_.callSuper($e,this,arguments),this._name="ParallelGateway",this._type="ParallelGateway",this.isGotonextQueueTimeout=5e3,this.isGotonextQueue=[],this.isGotonextQueueMethodPoint=null};_.extend($e,Je,{runningOnWorkflow:function(){_.invokeSuper($e,"runningOnWorkflow",this,arguments);var e=this.input.filter(function(e){return"gateway"===e.type}),t=this;e.forEach(function(e){t.isGotonextMethod=e.method?t[e.method]:t.isGateWayGotonext,t.isGotonextQueueMethod()})},isGotonextQueueMethod:function(){this.isGotonextQueueMethodPoint=setInterval(function(){clearInterval(this.isGotonextQueueMethodPoint);var o=this;if(0<this.isGotonextQueue.length){var a=this.isGotonextQueue.splice(0,1);this.isGotonextMethod(a[0].params,a[0].formdata,function(e,t){!e&&t&&_.invokeSuper($e,"startRunning",o,[a[0].params]),this.released||o.isGotonextQueueMethod()})}else this.released||o.isGotonextQueueMethod()}.bind(this),this.isGotonextQueueTimeout)},startRunning:function(){var e=arguments;this.isGotonextMethod&&"function"==typeof this.isGotonextMethod?d.fireEvent("getFormMethodDataFromFlowDataUniqueId","getFormData",arguments[0].flowdata.uniqueid,function(e,t,o){this.isGotonextQueue.push({formdata:o,params:e[0]})}.bind(this,e)):_.invokeSuper($e,"startRunning",this,e)},releaseActivity:function(){this.released=!0,clearInterval(this.isGotonextQueueMethodPoint),_.invokeSuper($e,"releaseActivity",this,arguments)},isGateWayGotonext:function(e,t,s){var l=this,u=e.flowdata,c=[];this.inbound.forEach(function(e){c.push({flag:!1,activityid:e.sourceId})}),g.queryFromSql("select fd.* from flowdata fd where fd.flowdataid=:flowdataid order by fd.updatetime",{flowdataid:u.flowdataid},function(e){if(0<e.length){for(var t=!0,o=0;o<e.length;o++){for(var a=e[o].activityid,n=e[o].finished,i=0;i<c.length;i++)a==c[i].activityid&&"1"==n?c[i].flag=!0:a==c[i].activityid&&"0"==n&&(c[i].flag=!1);a==l.id&&"1"==n&&new Date(e[o].updatetime).getTime()>new Date(u.updatetime).getTime()?t=!1:a==l.id&&"0"==n&&(t=!0)}var r=!0;for(i=0;i<c.length;i++)r=r&&c[i].flag;s(null,r&&t)}else s&&s(null,!1)},function(e){s&&s(e),_.log("判断gateway是否进入下一步失败："+JSON.stringify(e))})}}),General.WorkFlow.Activities.Gateways.ParallelGateway=$e;Je=General.WorkFlow.Activities.Activity;var Ze=function(e){_.callSuper(Ze,this,arguments),this._name="TimerGateway",this._type="TimerGateway",this.parentId=e.parentId};_.extend(Ze,Je,{runningOnWorkflow:function(){_.invokeSuper(Ze,"runningOnWorkflow",this,arguments)},startRunning:function(e){var t=arguments;d.fireEvent("setFlowDataState",e.flowdata,{activityid:this.id,status:this.status,activitytype:this._type,targetExcuteActivityid:e.targetExcuteActivityid,startToTargetActivityid:e.startToTargetActivityid},function(e,t,o){if(!t){_.log("activity:"+this.id+" is running!");var a=e[0];a.flowdata=o,this.bindDelayTimer(a)}}.bind(this,t))},bindDelayTimer:function(e){if(0<this.input.length){for(var t="",o=0;o<this.input.length;o++){var a=this.input[o];if("timerGateway"==a.type){t=a.delayTime;break}}setTimeout(function(e){var t=e.flowdata,o={method:"complete",params:e||{}};o.workFlowId=t.workflowid,o.flowdataid=t.flowdataid,o.activityid=this.id,d.fireEvent(this.workflowid+"_executeActivity",o)}.bind(this,e),parseInt(t))}}}),General.WorkFlow.Activities.Gateways.TimerGateway=Ze;Je=General.WorkFlow.Activities.Activity;var et=function(e){_.callSuper(et,this,arguments),this._name="BaseTask"};_.extend(et,Je,{runningOnWorkflow:function(){_.invokeSuper(et,"runningOnWorkflow",this,arguments)},startRunning:function(){_.invokeSuper(et,"startRunning",this,arguments)},execute:function(){return _.invokeSuper(et,"execute",this,arguments)}}),General.WorkFlow.Activities.Tasks.BaseTask=et;et=General.WorkFlow.Activities.Tasks.BaseTask;var tt=function(e){_.callSuper(tt,this,arguments),this._name="UserTask",this._type="UserTask",this.userConfig=e.userConfig||null,this.focusedEventArray=[]};_.extend(tt,et,{getExports:function(){return _.invokeSuper(tt,"getExports",this,arguments).concat(["signal"])},runningOnWorkflow:function(){this.wait=!0,_.invokeSuper(tt,"runningOnWorkflow",this,arguments)},signal:function(e){this.wait||_.log("error: "+this.id+" is not waiting"),e.flowdata&&this.startRunning(e,!0,e)},startRunning:function(t,e,o){var i=this,r=arguments;i._getUsers(function(n){!i.wait||e?(_.log("activity:"+i.id+" is running!"),i.isHandleToTerminationElement(t,o,function(e){e&&i.complete(t)})):d.fireEvent("setFlowDataState",t.flowdata,{activityid:i.id,status:i.status,activitytype:i._type,targetExcuteActivityid:t.targetExcuteActivityid,startToTargetActivityid:t.startToTargetActivityid},function(e,t){if(!e)if(n.waitFlag){var o="";"users"==n.userType&&(o=" users: "+JSON.stringify(n.users)+" userGroups: "+JSON.stringify(n.userGroups)),_.log("activity:"+i.id+" is waiting for the signals of "+n.userType+"\n"+o),i._notifyUser(n,t),i.setFlowDataUsers(n,t),d.fireEvent(i.workflowid+"_workflow_sendMessage",t)}else{_.log("activity:"+i.id+" is running!");var a=r[0];a.flowdata=t,Array.prototype.splice.call(r,0,1,a),i.complete.apply(this,r)}}.bind(i))})},isHandleToTerminationElement:function(t,o,a){if(o){var n=this;return o.resumeFlag&&!o.targetActivityId?(this.executeRefuseMethod(o,function(e){e||d.fireEvent("updateFlowDataState",t.flowdata,{finished:"1",operate:"refuse",updatetime:new Date},function(e,t,o){t?_.log("更新拒绝flowdata状态失败（"+JSON.stringify(e)+"）："+t.message):(e.flowdata=o,d.fireEvent(n.workflowid+"_finishWorkflow",e))}.bind(this,t)),a&&a(!1)}),!1):o.resumeFlag&&o.targetActivityId?(this.executeBackMethod(o,function(e){e||d.fireEvent("updateFlowDataState",t.flowdata,{finished:"1",operate:"back",updatetime:new Date},function(e,t,o,a){o?_.log("更新退回flowdata状态失败（"+JSON.stringify(e)+"）："+o.message):d.fireEvent("finishFlowDataState",e.flowdata,function(e,t,o){if(o)_.log("更新退回flowdata状态失败（"+JSON.stringify(e)+"）："+o.message);else{e.targetExcuteActivityid=t.targetExcuteActivityid,e.startToTargetaAtivityid=t.startToTargetaAtivityid;var a={method:"startRunning",params:e||{}};a.workFlowId=e.flowdata.workflowid,a.flowdataid=e.flowdata.flowdataid,a.activityid=t.targetActivityId,d.fireEvent(n.workflowid+"_executeActivity",a)}}.bind(this,e,t))}.bind(this,t,o)),a&&a(!1)}),!1):(this.executeAgreeMethod(o,function(e){e?a&&a(!1):a&&a(!0)}),!0)}return a&&a(!0),!0},executeRefuseMethod:function(e,t){t&&t()},executeBackMethod:function(e,t){t&&t()},executeAgreeMethod:function(e,t){t&&t()},_getUsers:function(r){var e=this.userConfig;if(e){var t=e.type.toLocaleLowerCase();if("all"!=t){if("users"==t){var o=e.users||[],a=e.userGroups||[],n=e.getUsersMethod;if(n)this[n]?this[n]({users:o,userGroups:a,callback:function(e,t,o,a,n){a&&(_.log("UserTask ActivityId: "+this.id+" getUsersMethod cause an error: "+a.message),n={users:t,userGroups:o});var i=!0;0==n.users.length&&0==n.userGroups.length&&(i=!1),r&&r({waitFlag:i,userType:e,users:n.users,userGroups:n.userGroups})}.bind(this,t,o,a)}):_.log("UserTask ActivityId: "+this.id+" getUsersMethod cause an error: method "+n+" is undefined");else{var i=!0;0==o.length&&0==a.length&&(i=!1),r&&r({waitFlag:i,userType:t,users:o,userGroups:a})}}}else r&&r({waitFlag:!0,userType:t})}else r&&r({waitFlag:!1})},_notifyUser:function(o,a){d.fireEvent("getFormMethodDataFromFlowDataUniqueId","getFormData",a.uniqueid,function(e,t){e&&(_.log("UserTask ActivityId: "+this.id+" getFormMethodDataFromFlowDataUniqueId cause an error: "+e.message),t={}),this.notifyUser({userData:o,flowdata:a,formdata:t})}.bind(this))},notifyUser:function(e){var t=e.userData,o=e.flowdata,a=e.formdata;_.log("流程实例："+JSON.stringify(o)+" \n关联表单数据："+JSON.stringify(a)+" \n 需要通知："+JSON.stringify(t)+"  进行相应处理!")},setFlowDataUsers:function(e,o){var t=e.users,a=e.userGroups;t&&(t=JSON.stringify(t)),a&&(a=JSON.stringify(a)),d.fireEvent("updateFlowDataState",o,{operator_userid:t,operator_roleid:a},function(e,t){e?_.log("-----------flowdata: "+JSON.stringify(o)+"设置当前流程实例节点的执行操作人失败："+e.message):_.log("-----------flowdata: "+JSON.stringify(o)+"设置当前流程实例节点的执行操作人成功！更新值为："+JSON.stringify(t))})}}),General.WorkFlow.Activities.Tasks.UserTask=tt;tt=General.WorkFlow.Activities.Tasks.UserTask;var ot=function(e){_.callSuper(ot,this,arguments),this._name="ManualTask",this._type="ManualTask",this.manual=e.manual};_.extend(ot,tt,{isHandleToTerminationElement:function(e,t,o){var a=this.manual,n=this,i=arguments,r="agree",s={};if(t&&(t.resumeFlag&&!t.targetActivityId?r="refuse":t.resumeFlag&&t.targetActivityId&&(r="back"),0<a.length))for(var l=0;l<a.length;l++)if(a[l].operate==r){s=a[l];break}if(s.method&&t.updateParam)try{var u=s.method.split("."),c={module:u[0],method:u[1],param:{flowData:e.flowdata,params:s.params,updateParam:t.updateParam}};d.fireEvent("runManual",c,function(e,t){t&&console.log(this.id+" runManual err: "+t.message),_.invokeSuper(ot,"isHandleToTerminationElement",this,e)}.bind(n,i))}catch(e){console.log(n.id+" runManual err: "+e.message),_.invokeSuper(ot,"isHandleToTerminationElement",n,i)}else _.invokeSuper(ot,"isHandleToTerminationElement",n,i)}}),General.WorkFlow.Activities.Tasks.ManualTask=ot;et=General.WorkFlow.Activities.Tasks.BaseTask;var at=function(e){_.callSuper(at,this,arguments),this._name="ServiceTask",this._type="ServiceTask",this.service=e.service};_.extend(at,et,{startRunning:function(){this.executeService(),_.invokeSuper(et,"startRunning",this,arguments)},executeService:function(){}}),General.WorkFlow.Activities.Tasks.ServiceTask=at;et=General.WorkFlow.Activities.Tasks.BaseTask;var nt=require("http"),it=require("iconv-lite"),rt=function(e){this._name="ApiTask",this._type="ApiTask",this.apiConfig=e.apiConfig||null,_.callSuper(rt,this,arguments)};_.extend(rt,et,{getExports:function(){return _.invokeSuper(rt,"getExports",this,arguments).concat(["getDataFromApi"])},startRunning:function(e){var t=arguments,n=this;d.fireEvent("setFlowDataState",e.flowdata,{activityid:this.id,status:this.status,activitytype:this._type,targetExcuteActivityid:e.targetExcuteActivityid,startToTargetActivityid:e.startToTargetActivityid},function(e,t,o){if(!t){_.log("activity:"+this.id+" is running!");var a=e[0];a.flowdata=o,this.getDataFromApi(function(e){a.apiData=e;var t={method:"complete",params:a||{}};t.workFlowId=o.workflowid,t.flowdataid=o.flowdataid,t.activityid=n.id,d.fireEvent(n.workflowid+"_executeActivity",t)})}}.bind(this,t))},getDataFromApi:function(n){var t=this.apiConfig,o=this._initRestProcess(t);try{var a=t.params,i=nt.request(o,function(e){var o=[],a=0;e.on("data",function(e){var t=e;o.push(t),a+=t.length}),e.on("end",function(){var e=Buffer.concat(o,a),t=it.decode(e,"utf-8");n(t)})});i.write(require("querystring").stringify(a)),i.on("error",function(e){console.log("使用ApiTask通过http获取数据出错"+e)}),i.end()}catch(t){console.log("使用ApiTask通过http获取数据出错"+e)}},_initRestProcess:function(e,t){return{hostname:e.host,port:e.port,path:e.path,method:"POST",headers:{accept:"*/*","Content-Type":"application/x-www-form-urlencoded;charset=UTF-8"}}}}),General.WorkFlow.Activities.Tasks.ApiTask=rt;var st={};st.SequenceFlow=General.WorkFlow.Activities.SequenceFlow,st.ExclusiveGateway=General.WorkFlow.Activities.Gateways.ExclusiveGateway,st.ParallelGateway=General.WorkFlow.Activities.Gateways.ParallelGateway,st.TimerGateway=General.WorkFlow.Activities.Gateways.TimerGateway,st.UserTask=General.WorkFlow.Activities.Tasks.UserTask,st.ServiceTask=General.WorkFlow.Activities.Tasks.ServiceTask,st.ManualTask=General.WorkFlow.Activities.Tasks.ManualTask,st.StartEvent=General.WorkFlow.Activities.Events.StartEvent,st.TimerEvent=General.WorkFlow.Activities.Events.TimerEvent,st.MessageEvent=General.WorkFlow.Activities.Events.MessageEvent,st.EndEvent=General.WorkFlow.Activities.Events.EndEvent;var lt={getActivityFromType:function(e){var t=st[e];return t||null},isSequenceFlow:function(e){return!!e&&/SequenceFlow/i.test(e)}};General.WorkFlow.Unit.Mapper=lt;Le=General.WorkFlow.Unit.EventEmitter,lt=General.WorkFlow.Unit.Mapper;var ut=function(t,e,o,a,n){_.callSuper(ut,this,arguments),this._name="workflow",this.workflowContainer=e,this.id=t.id,this.version=t.workflowVersion,this.name=t.name,this.workFlowJson=t||{},this.connections=[],this.activities={},this.startActivities=[];var i=this,r=n;n=function(){this.cb=r,Array.prototype.splice.call(arguments,0,0,i),this.cb&&this.cb.apply(this,arguments)},o||a?this.workflowContainer.insertWorkFlowEngineData({workflowengineid:t.id,workflowversion:t.workflowVersion,workflowname:t.name,getformdatamethod:t.form&&t.form.getFormDataMethod?t.form.getFormDataMethod:"",updateformdatamethod:t.form&&t.form.updateFormDataMethod?t.form.updateFormDataMethod:"",workflowjson:new Buffer(JSON.stringify(t),"utf-8"),load:"1",createtime:new Date},function(e){e?n&&n(e):i.initWorkflow(t,n)}):i.initWorkflow(t,n)};_.extend(ut,Le,{initWorkflow:function(e,t){this.runningOnWorkflow(),this.loadActivities(),this.installActivities(),this.loadChildren(),e.MQServer?this.workflowMQConnect(e.MQServer,t):t&&t(),d.setMaxListeners(this.id+"_workFlowActivityPause"),d.setMaxListeners(this.id+"_workFlowActivityContinue")},getCapabilities:function(){var e=this.activities,t=this.connections,n={};for(var o in e)e[o].forEach(function(e){var t=e.id,o=[],a=e.getExports();a&&(o=a),n[t]=o});t.forEach(function(e){var t=e.id,o=[],a=e.getExports();a&&(o=a),n[t]=o});var a={};return a[this.id]=n,a},workflowMQConnect:function(e,o){var a=this;this.workflowContainer.workflowMQConnect(e,function(e,t){e?(o&&o(e),console.log("初始化消息队列服务器失败："+e.message)):(a.MQConn=t,a.receiveRabbitMQMail(t,o))})},runningOnWorkflow:function(e){this.focusedEventArray=[{event:this.id+"_start",onEvent:"onStart"},{event:this.id+"_end",onEvent:"completeWorkflow"},{event:this.id+"_executeActivity",onEvent:"executeActivity"},{event:this.id+"_completeWorkflow",onEvent:"completeWorkflow"},{event:this.id+"_finishWorkflow",onEvent:"finishWorkflow"},{event:this.id+"_workflow_sendMessage",onEvent:"sendMessage"},{event:this.id+"_workflow_socketMessage",onEvent:"sendSocketMessage"}],_.invokeSuper(ut,"runningOnWorkflow",this,arguments)},loadChildren:function(e){var t=this;if(this.startActivities=[],this.endActivities=[],this.activities)for(var o in this.activities)this.activities[o].forEach(function(e){e.isStart&&t.startActivities.push(e),e.isEnd&&t.endActivities.push(e)})},loadActivities:function(){var e=this.workFlowJson,t=e.Activities,o=e.connections;if(e)if(t&&o&&Array.isArray(t)&&Array.isArray(o)){for(var a=0;a<t.length;a++){var n=t[a];if(n.workflowid=e.id,n.class&&""!==n.class){var i=require(n.class);if(i&&"function"==typeof i){var r=new i(n),s=r._type;this.activities[s]?this.activities[s].push(r):this.activities[s]=[r]}}}for(a=0;a<o.length;a++){var l=o[a],u=l.actype?l.actype:"SequenceFlow";l.workflowid=e.id;var c=lt.getActivityFromType(u);if(l.class&&""!==l.class&&(c=require(l.class)),c&&"function"==typeof c){var d=new c(l);this.connections.push(d)}}}else _.log("workFlowJson has a error format!")},installActivities:function(){var o=this;for(var e in this.activities){this.activities[e].forEach(function(e){if(e){var t=o.getInboundOutboundSequenceFlows(e.id);e.setParams(t),e.runningOnWorkflow(o)}})}this.connections.forEach(function(e){if(e){var t=o.getSourceTargetActivity(e.sourceId,e.targetId);e.setParams(t),e.runningOnWorkflow(o)}})},onStart:function(){_.log(this.name+"("+this.id+") is start! ")},executeEngine:function(o){if(_.log("workflow："+o.workflowid+" is start! flowData is "+JSON.stringify(o)),0===Object.getOwnPropertyNames(this.activities).length)return this.completeWorkflow({flowdata:o});var a=this;this.startActivities.forEach(function(e){var t={method:"startRunning",params:{flowdata:o}};t.workFlowId=o.workflowid,t.flowdataid=o.flowdataid,t.activityid=e.id,d.fireEvent(a.id+"_executeActivity",t)})},executeActivity:function(a){var e=this.getActivityById(a.activityid);if(e){var n=a.params.flowdata;if(""===a.method||_.isNull(a.method)){t={method:"startRunning",params:a.params||{flowdata:n}};n.uniqueid&&(t.method="complete"),t.workFlowId=n.workflowid,t.flowdataid=n.flowdataid,t.activityid=a.activityid,d.fireEvent(n.workflowid+"_executeActivity",t)}else{if("direct"==e.findMethodType(a.method).type){if(r=e.execute(a.method,a.params)){if("1"==r.status&&!r.stopFlowState){var t={method:"startRunning",params:r.result||{}};n.uniqueid&&(t.method="complete"),t.workFlowId=r.result.flowdata.workflowid,t.flowdataid=r.result.flowdata.flowdataid,t.activityid=a.activityid,d.fireEvent(r.result.flowdata.workflowid+"_executeActivity",t)}if(a.params.callback)a.params.callback(r),delete a.params.callback;else{var o="1"==r.status?JSON.stringify(r):JSON.stringify({status:r.status,error:r.error.message});_.log("execute "+a.workFlowId+" "+a.flowdataid+" "+a.activityid+" "+a.method+" : "+o)}}}else{var i=a.params.callback;a.params.callback=function(e){if(this.cb=i,this.flowData=n,this.cb&&e)this.cb(e),delete a.params.callback;else{var t="1"==e.status?JSON.stringify(e):JSON.stringify({status:e.status,error:e.error.message});_.log("execute "+a.workFlowId+" "+a.flowdataid+" "+a.activityid+" "+a.method+" : "+t)}if("1"==e.status&&e.result.flowdata){var o={method:"startRunning",params:e.result||{}};this.flowData.uniqueid&&a.activityid==e.result.flowdata.activityid&&(o.method="complete"),o.workFlowId=e.result.flowdata.workflowid,o.flowdataid=e.result.flowdata.flowdataid,o.activityid=a.activityid,d.fireEvent(e.result.flowdata.workflowid+"_executeActivity",o)}};var r,s={};_.copySimpleObject(a.params,s),(r=e.execute(a.method,s))&&(a.params.callback?(a.params.callback(r),delete a.params.callback):console.log("execute "+a.method+" :"+JSON.stringify(r)))}}}else{var l="executeWorkFlowEngine params error: activityid hasn't get a activity!";_.log(l),a.params.callback({status:"0",error:new Error(l)})}},finishWorkflow:function(t){var o=this;this.finishFlowDataState(t.flowdata,function(e){e?_.log("结束activity失败（"+JSON.stringify(t)+"）："+e.message):o.endActivities.forEach(function(e){return e.startRunning(t)})})},completeWorkflow:function(e){_.log("流程完成")},getInboundOutboundSequenceFlows:function(t){var e=[],o=[],a=this.connections;return{inbound:e=e.concat(a.filter(function(e){return e.targetId===t})),outbound:o=o.concat(a.filter(function(e){return e.sourceId===t}))}},releaseWorkFlow:function(){for(var e in this.activities)this.activities[e].forEach(function(e){return e.releaseActivity()});this.connections.forEach(function(e){return e.releaseConnection()}),this.startActivities.forEach(function(e){return e.releaseActivity()}),this.endActivities.forEach(function(e){return e.releaseActivity()}),this.MQConn&&this.MQConn.close(),_.invokeSuper(ut,"disposeModule",this,arguments)},getActivityById:function(t){for(var e in this.activities){var o=this.activities[e].filter(function(e){return e.id===t});if(0<o.length)return o[0]}return null},getSourceTargetActivity:function(t,o){var e={};for(var a in this.activities){var n=this.activities[a].filter(function(e){return e.id===t}),i=this.activities[a].filter(function(e){return e.id===o});0<n.length&&(e.sourceActivity=n[0]),0<i.length&&(e.targetActivity=i[0])}return e},signal:function(e){var t=e.flowdata;if(t){var o={workFlowId:t.workflowid,flowdataid:t.flowdataid,activityid:t.activityid,method:"signal",params:e||{}};this.executeActivity(o)}else _.log("signal has catch a error params!")},removeFlowData:function(e,t){this.workflowContainer.removeFlowData(e,t)},getFlowDataById:function(e,t){this.workflowContainer.getFlowDataById(e,t)},finishFlowDataState:function(e,t){this.workflowContainer.finishFlowDataState(e,t)},sendMessage:function(e,t){this.workflowContainer.sendMessage(e,t,this.MQConn,{exchangeKey:"workflow_message_server_"+this.id,type:"direct",routingKey:"workflow_message",content:""})},sendSocketMessage:function(e,t){this.workflowContainer.sendSocketMessage(e,t)},receiveRabbitMQMail:function(e,t){this.workflowContainer.receiveRabbitMQMail(e,{serverName:this.id+"工作流引擎消息服务器",exchangeKey:"workflow_message_server_"+this.id,type:"direct",routingKey:["workflow_message","operate"]},t)}}),General.WorkFlow.WorkFlow=ut;var ct=General.WorkFlow.WorkFlow,dt=(Pe=General.WorkFlow.WorkFlowEngineAuth,function(e){_.callSuper(dt,this,arguments),this._name="workflow",this.workflowFile=[],this.workflowEngine={},this.testFormData={id:"test",data:[],event_total_cost:6e4,medicalProcessFlag:"1",event_holding_start_date:"2018-03-14 17:39:00",status:"已创建",eventEngineFlag:!1,item1:!0,item2:!0,getMaterialsFlag:"0"},this.focusedEventArray=[{event:"setFlowDataState",onEvent:"setFlowDataState"},{event:"updateFlowDataState",onEvent:"updateFlowDataState"},{event:"getFormMethodDataFromFlowDataUniqueId",onEvent:"getFormMethodDataFromFlowDataUniqueId"},{event:"getDataFromModuleMethod",onEvent:"_getDataFromModuleMethod"},{event:"getFlowDataByActivityid",onEvent:"getFlowDataByActivityid"},{event:"finishFlowDataState",onEvent:"finishFlowDataState"},{event:"runManual",onEvent:"runManual"},{event:"runService",onEvent:"runService"}],this.WorkFlowEngineAuth=new Pe});_.extend(dt,m,{getExports:function(){return["testWorkFlowEngine","signalToWorkFlowEngine","controlerToWorkFlowEngine","getWorkFlowFormData","hotLoadWorkflow","getWorkFlowAuthorizations","deleteWorkFlowAuthorizationFromRole","addWorkFlowMethod2Role"]},loadModuleSettings:function(e){e.workflowFile&&(this.workflowFile=e.workflowFile)},getWorkFlowAuthorizations:function(e,t,o){var a,n={action:"getWorkFlowAuthorizations"},i=e.body;a="Array"==typeof i?_._handleDatatableSettings(i,["roleid","notIncludeRoleid"]):i;var r=e.session,s=r?r.user:null,l=this.WorkFlowEngineAuth.getAuthorizationMessage(a.roleid,a.notIncludeRoleid,s);n.result={data:l,length:l.length},n.status=b.S,t.json(n)},deleteWorkFlowAuthorizationFromRole:function(e,t,o){var a={action:"deleteWorkFlowAuthorizationFromRole"},n=e.body,i=n.roleid,r=n.authorizationData,s=e.session,l=s?s.user:null;if("admin"==i)a.error={desc:"admin的角色权限不可删除！"},a.status=b.F,t.json(a);else{if(r&&Array.isArray(r))for(var u=0;u<r.length;u++)this.WorkFlowEngineAuth.removeMethodFromRole(this.workflowEngine,i,r[u],l);a.result={data:[],length:0},a.status=b.S,t.json(a)}},addWorkFlowMethod2Role:function(e,t,o){var a={action:"addWorkFlowMethod2Role"},n=e.body,i=n.roleid,r=n.authorizationData,s=e.session,l=s?s.user:null;if(r&&Array.isArray(r))for(var u=0;u<r.length;u++)this.WorkFlowEngineAuth.addMethod2Role(this.workflowEngine,i,r[u],l);a.result={data:[],length:0},a.status=b.S,t.json(a)},runningOnPlatform:function(e){_.invokeSuper(dt,"runningOnPlatform",this,[e]),this.generateWorkFlowEngine()},generateWorkFlowEngine:function(){var c=this;this.getWorkFlowEngineData({},function(e,t){if(e)_.log("初始化workflow engine,生成workflow engine失败："+e.message);else{var o=[];t.forEach(function(e){o.push(e.workflowengineid)});var a=t.filter(function(e){return"1"===e.load}),n=a.length,i=0;if(0<n)for(var r=0;r<n;r++)u=JSON.parse(a[r].workflowjson.toString("utf-8")),new ct(u,c,!1,!1,function(e,t,o){o?console.log("初始化装载流程： "+e+" (版本： "+u.workflowVersion+") 发生错误："+o.message):(console.log("初始化装载流程： "+e+" (版本： "+u.workflowVersion+") 成功"),c.workflowEngine[t.id]=t),++i==n&&c.WorkFlowEngineAuth.initAuthorizations(c._platform,c.workflowEngine,function(e){e?console.log("初始化装载流程权限发生错误："+e.message):console.log("初始化装载流程权限成功")})}.bind(c,u.id));var s=c.workflowFile.length,l=0;if(0<s)for(r=0;r<s;r++){var u=JSON.parse(M.readFileSync(c.workflowFile[r]));-1==o.indexOf(u.id)&&(u.workflowVersion="0001",new ct(u,c,!0,!1,function(e,t,o){o?console.log("初始化装载FILE文件流程： "+e+" 发生错误："+o.message):(console.log("初始化装载FILE文件流程： "+e+" 成功"),c.workflowEngine[t.id]=t),++l==s&&c.WorkFlowEngineAuth.initAuthorizations(c._platform,c.workflowEngine,function(e){e?console.log("初始化装载FILE文件流程权限发生错误："+e.message):console.log("初始化装载FILE文件流程权限成功")})}.bind(this,u.id)))}}})},getWorkFlowEngineData:function(e,o){g.query("WorkFlowEngine",{where:e,order:[["workflowversion","desc"]]},function(e){if(0<e.length)for(var t=0;t<e.length;t++)e[t]=e[t].dataValues;o(null,e)},function(e){o(e)})},hotLoadWorkflow:function(e,r,t){var s={action:"hotLoadWorkflow"},o=e.body,a=o.options,n=o.action,l=this;try{switch(n){case"load":var u=function(e,t,o){var a=(o?"重新":"")+"装载流程： "+t+"发生错误："+e.message;console.log(a),s.status=b.F,s.error=a,r.json(s)},c=a.workFlowJson;if(!c)throw Error("请传入workFlowJson参数！");if("string"==typeof c&&(c=JSON.parse(c)),!c.id)throw Error("workFlowJson 数据结构异常，不存在唯一识别id");console.log("开始加载流程： "+c.id),this.getWorkFlowEngineData({},function(e,t){if(e)u(e,c.id);else{var o=[];t.forEach(function(e){return o.push(e.workflowengineid)});var a=o.indexOf(c.id);if(-1==a)c.workflowVersion="0001",new ct(c,l,!0,!1,function(e,t){t?u(t,c.id):(l.workflowEngine[e.id]=e,l.WorkFlowEngineAuth.initAuthorizations(l._platform,l.workflowEngine,function(e){e?u(e,c.id):(console.log("装载流程： "+c.id+" 成功"),s.status=b.S,s.result="装载流程： "+c.id+" 成功",r.json(s))}))});else{console.log("id为： "+c.id+" 的流程已存在相同id的流程描述，本次将生成新版本本流程");var n=_.PrefixInteger(parseInt(t[a].workflowversion)+1,4);c.workflowVersion=n;var i=function(o){new ct(o,l,!1,!0,function(e,t){t?u(t,o.id,!0):(l.workflowEngine[e.id]=e,l.WorkFlowEngineAuth.initAuthorizations(l._platform,l.workflowEngine,function(e){e?u(e,o.id,!0):(console.log("生成新版本流程： "+o.id+" 成功"),s.status=b.S,s.result="生成新版本流程： "+o.id+" 成功",r.json(s))}))})};l.workflowEngine[c.id]?l._unloadWorkFlowEngine(c.id,function(e,t){e?console.log("卸载流程： "+t+"发生错误："+e.message):(console.log("卸载流程： "+t+" 成功"),i(c))}):i(c)}}});break;case"unload":this._unloadWorkFlowEngine(a.workFlowEngineId,function(e,t){if(e){var o="卸载流程： "+t+"发生错误："+e.message;console.log(o),s.status=b.F,s.error=o,r.json(s)}else console.log("卸载流程： "+t+" 成功"),s.status=b.S,s.result="卸载流程： "+t+" 成功",r.json(s)});break;case"reload":u=function(e,t){var o="重新装载流程： "+t+"发生错误："+e.message;console.log(o),s.status=b.F,s.error=o,r.json(s)};var i=a.workFlowEngineId,d=a.workFlowEngineVersion;if(!i)throw Error("请传入workFlowEngineId参数！");if(!d)throw Error("请传入workFlowEngineVersion参数！");l.getWorkFlowEngineData({workflowengineid:i,workflowversion:d},function(e,t){if(e)u(e,i);else if(0<t.length){console.log("开始使用版本号为："+d+" 的流程重新装载流程： "+i);var o=function(t){l.updateWorkFlowEngineData({workflowengineid:i,workflowversion:d,load:"1"},function(e){e?u(e,i):new ct(t,l,!1,!1,function(e,t){t?u(t,i):(l.workflowEngine[e.id]=e,l.WorkFlowEngineAuth.initAuthorizations(l._platform,l.workflowEngine,function(e){e?u(e,i):(console.log("重新装载流程： "+i+" (版本： "+d+")成功"),s.status=b.S,s.result="重新装载流程： "+i+" (版本： "+d+")成功",r.json(s))}))})})},a=JSON.parse(t[0].workflowjson.toString("utf-8"));l.workflowEngine[a.id]?l._unloadWorkFlowEngine(a.id,function(e,t){e?console.log("卸载流程： "+t+"发生错误："+e.message):(console.log("卸载流程： "+t+" 成功"),o(a))}):o(a)}else u(new Error("不存在流程描述: "+i),i)});break;default:s.status=b.F,s.error="参数异常",r.json(s)}}catch(e){console.log("hotLoadWorkflow catch an error： "+e.message),s.status=b.F,s.error=e.message,r.json(s)}},_unloadWorkFlowEngine:function(t,o){var a=this;if(!t)throw Error("请传入workFlowEngineId参数！");a.workflowEngine[t]?(console.log("开始卸载流程： "+t),this.updateWorkFlowEngineData({workflowengineid:t,load:"0"},function(e){e?o&&o(e,t):(a.workflowEngine[t]&&a.workflowEngine[t].releaseWorkFlow(),a.workflowEngine[t]=null,delete a.workflowEngine[t],a.WorkFlowEngineAuth.unloadAuthorizationByWorkflow(a.workflowEngine,t,function(){o&&o(null,t)},function(e){o&&o(e,t)}))})):o&&o(new Error("不存在流程描述"+t),t)},executeWorkFlowEngine:function(e,t,o){var a={action:"executeWorkFlowEngine"},n=e.body,i=n.workFlowId,r=n.flowDataId,s=n.activityId,l=n.method,u=n.params;try{"string"==typeof u&&""!=u&&(u=JSON.parse(u));var c=e.session,d=c?c.user:null;r&&""!=r||(r=_.getGUID(12)),s&&""!=s||(s=""),l&&""!=l||(l=""),_.log("当前的flowdataid为："+r);var f={workFlowId:i,flowdataid:r,activityid:s,method:l,params:u||{},user:d};f.params.callback=function(e){"1"==e.status?(a.status=b.S,a.result=e):(a.status=b.F,a.error=e.error.message),t.json(a)},this._executeWorkFlowEngine(f)}catch(e){a.status=b.F,a.error=e.message,t.json(a)}},_executeWorkFlowEngine:function(a){var n=this.workflowEngine[a.workFlowId];if(n){var i={flowdataid:a.flowdataid,workflowid:a.workFlowId,workflowversion:n.version,activityid:a.activityid};this.getFlowDataByParams(i,function(e,t){if(!e){if(i.user=a.user,0<t.length){if("0"!=t[0].finished)return console.log("流程："+i.workflowid+" 实例："+i.flowdataid+" 中 acticity:："+i.activityid+"已完成，不可再进行操作!"),void(a.params.callback&&a.params.callback({status:"0",error:new Error("流程："+i.workflowid+" 实例："+i.flowdataid+" 中 acticity:："+i.activityid+"已完成，不可再进行操作!")}));i.uniqueid=t[0].uniqueid,i.targetexcuteactivityid=t[0].targetexcuteactivityid,i.starttotargetactivityid=t[0].starttotargetactivityid}var o="executeWorkFlowEngine cause a error! See logs";if(n)return void(""!==a.activityid?(a.params.flowdata=i,n.executeActivity(a)):(n.executeEngine(i),a.params.callback&&a.params.callback({status:"1"})));o="executeWorkFlowEngine params error: workflowid hasn't get a workflow engine!",_.log(o)}a.params.callback&&a.params.callback({status:"0",error:new Error(o)})})}else _.log("executeWorkFlowEngine params error: workflowid hasn't get a workflow engine!")},getWorkFlowFormData:function(e,t,o){_.log("getWorkFlowFormData: \nparams:"+JSON.stringify(e)),o&&o(null,this.testFormData)},updateFormDataMethod:function(e,t,o){_.log("updateFormDataMethod: \nparams:"+JSON.stringify(e)),this.testFormData.status=t.status,console.log("流程表单数据更新为："+JSON.stringify(this.testFormData)),o&&o(null)},signalToWorkFlowEngine:function(e,t,o){var a={action:"signalToWorkFlowEngine"},n=e.body,i=n.workFlowId,r=n.flowDataId,s=n.activityId,l=n.operate,u=n.targetActivityId,c=n.params,d=n.targetExcuteActivityid,f=n.startToTargetActivityid,h=e.session,m=h?h.user:null;this.signal({workFlowId:i,flowdataid:r,activityid:s,operate:l,targetActivityId:u,startToTargetActivityid:f,targetExcuteActivityid:d,updateParam:c,user:m},function(e){"1"==e.status?(a.status=b.S,a.result=e):(a.status=b.F,a.error=e.error.message),t.json(a)})},controlerToWorkFlowEngine:function(e,t,o){var a={action:"controlerToWorkFlowEngine"},n=e.body,i=n.workFlowId,r=n.flowDataId,s=n.operate,l=e.session;l&&l.user;try{if(!s)throw Error("Empty param: operate !");switch(s){case"pause":d.fireEvent(i+"_workFlowActivityPause",r);break;case"continue":d.fireEvent(i+"_workFlowActivityContinue",r);break;default:throw Error("Wrong param: operate !")}a.status=b.S,t.json(a)}catch(e){a.status=b.F,a.error=e.message,t.json(a)}},signal:function(r,s){var l={},u=this;this.getFlowDataByParams({flowdataid:r.flowdataid,activityid:r.activityid},function(e,t){if(e)s&&s(e);else{var o=t[0];if(o.user=r.user,"0"==o.finished){var a=r.updateParam;switch(r.operate){case"agree":l={flowdata:o,resumeFlag:!1,updateParam:a};break;case"back":if(!r.targetActivityId){var n="流程："+o.workflowid+" 实例："+o.flowdataid+" 中 acticity："+o.activityid+" 退回时发生错误： 未指定退回到的节点Activity！";return s&&s({status:"1",error:new Error(n)}),void console.log(n)}l={flowdata:o,resumeFlag:!0,targetActivityId:r.targetActivityId,startToTargetActivityid:r.startToTargetActivityid?r.startToTargetActivityid:null,targetExcuteActivityid:r.targetExcuteActivityid?r.targetExcuteActivityid:null,updateParam:a};break;case"refuse":l={flowdata:o,resumeFlag:!0,updateParam:a}}var i=u.workflowEngine[r.workFlowId];if(i)s&&(l.callback=s),i.signal(l);else{n="流程："+r.workFlowId+" 未在系统中发现，请联系系统管理员查明原因！";s&&s({status:"1",error:new Error(n)}),console.log(n)}}else{n="流程："+o.workflowid+" 实例："+o.flowdataid+" 中 acticity："+o.activityid+"已完成，不可再进行操作!";s&&s({status:"1",error:new Error(n)}),console.log(n)}}})},workflowMQConnect:function(e,t){var o=this._platform.runModule("rabbitmq","rabbitMQConnect",[e,t]);o&&"0"==o.status&&t&&t(o.error)},sendMessage:function(e,t,o,a){e&&(a.content=JSON.stringify(e)),t&&(t.exchangeKey&&t.type&&t.routingKey?(a.exchangeKey=t.exchangeKey,a.type=t.type,a.routingKey=t.routingKey):_.log("发送消息时，rabbitMQ消息服务器配置信息配置错误："+JSON.stringify(t)));var n=this._platform.runModule("rabbitmq","_sendRabbitMQMail",[a,function(e){e?_.log("----------发送消息失败："+e.message+"----------\n（"+a.content+"）\n"):_.log("----------发送消息成功！----------\n（"+a.content+"）\n")},o]);if(n&&"0"==n.status){var i=n.error;_.log("----------发送消息失败："+i.message+"----------\n（"+a.content+"）\n")}},receiveRabbitMQMail:function(e,t,o){var a=this,n=a._platform.runModule("rabbitmq","receiveRabbitMQMail",[t,function(e){e?(_.log("connection failed: "+e.message),o&&o(e)):(_.log("connection success!"),o&&o())},function(e){if(e)if("workflow_message"==e.fields.routingKey)(t=JSON.parse(e.content)).workflowid&&t.flowdataid&&t.activityid?_.log("流程:"+t.workflowid+" 实例: "+t.flowdataid+" 进入审批节点: "+t.activityid):_.log("接受到默认派发消息服务器的消息："+JSON.stringify(t));else if("operate"==e.fields.routingKey){var t=JSON.parse(e.content.replace("\n",""));a.signal(t,function(e){e?_.log("流程处理失败 ("+JSON.stringify(t)+")："+e.message):_.log("流程处理成功! ("+JSON.stringify(t)+")")})}},e]);n&&"0"==n.status&&o&&o(n.error)},sendSocketMessage:function(t,e){var o={};t&&(o.content=JSON.stringify(t)),e&&e.messageKey&&(o.messageKey=e.messageKey);var a=JSON.stringify(o),n=this._platform.runModule("websocket","sendSocketMail",[a,function(e){e?_.log("----------socket发送消息失败："+e.message+"----------\n（"+t+"）\n"):_.log("----------socket发送消息成功！----------\n（"+t+"）\n")}]);if(n&&"0"==n.status){var i=n.error;_.log("----------发送消息失败："+i.message+"----------\n（"+t+"）\n")}},insertFlowData:function(o,t){Array.isArray(o)||(o=[o]),g.seq.transaction(function(e){var t=[];return t.push(g.batchInsertWithTrans("FlowData",o,e)),g.seq.Promise.all(t)}).then(function(e){t&&t(null)}).catch(function(e){t&&t(e)})},removeFlowData:function(o,t){g.seq.transaction(function(e){var t=[];return t.push(g.deleteWithTrans("FlowData",{uniqueid:o.uniqueid},e)),g.seq.Promise.all(t)}).then(function(e){t&&t(),_.log("flowData移除数据成功"+JSON.stringify(e))}).catch(function(e){t&&t(e),_.log("flowData移除数据失败："+e.message)})},getFlowDataByActivityid:function(e,o){this.getFlowDataByParams({activityid:e},function(e,t){e?o&&o(e):0<t.length?o&&o(null,t):o&&o(new Error("从flowData里面获取数据失败:无数据"))})},getFlowDataById:function(e,o){this.getFlowDataByParams({uniqueid:e},function(e,t){e?o&&o(e):0<t.length?o&&o(null,t[0]):o&&o(new Error("从flowData里面获取数据失败:无数据"))})},getFlowDataByParams:function(e,o){g.query("FlowData",{where:e,order:[["starttime","desc"]]},function(e){if(0<e.length)for(var t=0;t<e.length;t++)e[t]=e[t].dataValues;o&&o(null,e)},function(e){o&&o(e),_.log("从flowData里面获取数据失败："+e.message)})},setFlowDataState:function(t,e,o){_.copySimpleObject({uniqueid:_.getGUID(12),activityid:e.activityid,status:e.status,activitytype:e.activitytype,targetexcuteactivityid:e.targetExcuteActivityid,starttotargetactivityid:e.startToTargetActivityid,updatetime:new Date,starttime:new Date},t),t.finished&&delete t.finished,t.id&&delete t.id;var a=[],n=this;a.push(t),this.insertFlowData(a,function(e){e?(o&&o(e),_.log("flowData设置流程数据状态失败："+e.message)):(o&&(n.getFormMethodDataFromFlowDataUniqueId("updateFormData",t.uniqueid,function(e,t){e||_.log("更新流程表单数据成功")}),o(null,t)),_.log("flowData设置流程数据状态成功"+JSON.stringify(t)))})},updateFlowDataState:function(o,a,t){var n=this;g.seq.transaction(function(e){var t=[];return t.push(g.updateWithTrans("FlowData",a,{uniqueid:o.uniqueid},e)),g.seq.Promise.all(t)}).then(function(e){n.getFlowDataById(o.uniqueid,t),_.log("flowData: "+o.uniqueid+" 更新流程数据状态成功"+JSON.stringify(e))}).catch(function(e){t&&t(e),_.log("flowData: "+o.uniqueid+" 更新流程数据状态失败："+e.message)})},finishFlowDataState:function(o,t){g.seq.transaction(function(e){var t=[];return t.push(g.updateWithTrans("FlowData",{finished:"1",updatetime:new Date,operate:"levelUpdate"},{flowdataid:o.flowdataid,finished:"0"},e)),g.seq.Promise.all(t)}).then(function(e){t&&t(),_.log("flowData: "+o.flowdataid+" 结束流程数据，使流程数据都处于结束状态成功："+JSON.stringify(e))}).catch(function(e){t&&t(e),_.log("flowData: "+o.flowdataid+" 结束流程数据，使流程数据都处于结束状态失败："+e.message)})},insertWorkFlowEngineData:function(o,t){g.seq.transaction(function(e){var t=[];return t.push(g.batchInsertWithTrans("WorkFlowEngine",[o],e)),g.seq.Promise.all(t)}).then(function(e){t&&t(),_.log("WorkFlowEngine插入数据成功"+JSON.stringify(e))}).catch(function(e){t&&t(e),_.log("WorkFlowEngine插入数据失败："+e.message)})},updateWorkFlowEngineData:function(o,t){var a={workflowengineid:o.workflowengineid};o.workflowversion&&(a.workflowversion=o.workflowversion),g.seq.transaction(function(e){var t=[];return t.push(g.updateWithTrans("WorkFlowEngine",o,a,e)),g.seq.Promise.all(t)}).then(function(e){t&&t(),_.log("WorkFlowEngine更新数据成功"+JSON.stringify(e))}).catch(function(e){t&&t(e),_.log("WorkFlowEngine更新数据失败："+e.message)})},getFormMethodDataFromFlowDataUniqueId:function(r,e,s){var l=this;g.queryFromSql("select wfg.getformdatamethod,wfg.updateformdatamethod,fd.* from workflowengines wfg,flowdata fd where fd.workflowid=wfg.workflowengineid and fd.uniqueid=:id",{id:e},function(e){if(0<e.length){var t,o=e[0],a=o.formid;switch(r){case"getFormData":o.getformdatamethod&&(t=o.getformdatamethod.split("."));break;case"updateFormData":o.updateformdatamethod&&(t=o.updateformdatamethod.split("."))}if(t&&Array.isArray(t))if(1<t.length){var n=t[0],i=t[1];l._platform.runModule(n,i,[a,o,function(e,t){e?s&&s(e):s&&s(null,t)}])}else s&&s(new Error("由flowData获取流程表单method数据失败:数据调用异常"));else s&&s(new Error("由flowData获取流程表单method数据失败:数据调用异常"))}else s&&s(new Error("由flowData获取流程表单method数据失败:无数据"))},function(e){s&&s(e),_.log("由flowData获取流程表单method数据失败："+e.message)})},_getDataFromModuleMethod:function(e){var t=e.module,o=e.method,a=e.params||[];if(t&&o&&a){var n=this._platform.runModule(t,o,a);if(n)return n.status&&"0"==n.status&&a.callback&&a.callback(n.error),n}else{var i=" _getDataFromModuleMethod cause an error: module or method is undefined ! ";a.callback&&a.callback(new Error(i)),console.log(i)}},runService:function(e){var t=e.modelName,o=e.methodName,a=e.param;this._platform.runModule(t,o,a)},runManual:function(e,t){var o=e.modelName,a=e.methodName,n=e.param;this._platform.runModule(o,a,[n,t])},createPurchase:function(e){console.log("test")},createManualchase:function(e,o){var t={},a="0",n="0",i=JSON.parse(e.updateParam),r=e.params,s=e.flowData;for(var l in i){-1<r.indexOf(l)&&(t[l]=i[l])}for(var u in t){t[u]?n="1":a="1"}t.entryFlag=n,t.returnFlag=a,this.getFormMethodDataFromFlowDataId("updateFormData",s.flowdataid,function(e,t){o(e||null)},t)},confirmOrder:function(){console.log("确认安装工单")}}),General.WorkFlow.Module=dt,General.Asset={};var ft={categoryid:{type:o.STRING,allowNull:!1,unique:!0},categoryname:{type:o.STRING,allowNull:!1},description:{type:o.TEXT,allowNull:!0},parentid:{type:o.STRING,allowNull:!0},createtime:{type:o.DATE,allowNull:!1},creator:{type:o.STRING,allowNull:!1}},ht={categoryid:{type:o.STRING,allowNull:!1},attributetype:{type:o.STRING,allowNull:!1},attributeid:{type:o.STRING,allowNull:!1},attributename:{type:o.STRING,allowNull:!1},datatype:{type:o.STRING,allowNull:!1,defaultValue:"String"},component:{type:o.STRING,allowNull:!1,defaultValue:"TextField"},avaliablevalues:{type:o.STRING,allowNull:!0},isrequired:{type:o.BOOLEAN,allowNull:!1,defaultValue:!1},defaultvalue:{type:o.STRING,allowNull:!0},isshowlist:{type:o.BOOLEAN,allowNull:!1,defaultValue:!1},isselect:{type:o.BOOLEAN,allowNull:!1,defaultValue:!1},isfun:{type:o.BOOLEAN,allowNull:!1,defaultValue:!1}},mt={modelid:{type:o.STRING,allowNull:!1,unique:!0},modelname:{type:o.STRING,allowNull:!1},categoryid:{type:o.STRING,allowNull:!1},description:{type:o.TEXT,allowNull:!0},createtime:{type:o.DATE,allowNull:!1},creator:{type:o.STRING,allowNull:!1}},gt={assetid:{type:o.STRING,allowNull:!1,unique:!0},assetname:{type:o.STRING,allowNull:!1,unique:!0},modelid:{type:o.STRING,allowNull:!0},description:{type:o.TEXT,allowNull:!0},count:{type:o.DECIMAL,allowNull:!0},status:{type:o.ENUM,allowNull:!1,values:["0","1","2"],defaultValue:"0"},authority:{type:o.ENUM,allowNull:!1,values:["0","1"],defaultValue:"0"},createtime:{type:o.DATE,allowNull:!1},creator:{type:o.STRING,allowNull:!1}},pt={dateTime:{type:o.STRING,allowNull:!0},timetype:{type:o.STRING,allowNull:!0},statype:{type:o.STRING,allowNull:!0},indexImprove:{type:o.DECIMAL,allowNull:!0},o3_1h:{type:o.INTEGER,allowNull:!0},cityname:{type:o.STRING,allowNull:!0},pm10:{type:o.INTEGER,allowNull:!0},so2Improve:{type:o.DECIMAL,allowNull:!0},index:{type:o.STRING,allowNull:!0},co:{type:o.DECIMAL,allowNull:!0},coImprove:{type:o.DECIMAL,allowNull:!0},pm25Improve:{type:o.DECIMAL,allowNull:!0},no2:{type:o.INTEGER,allowNull:!0},citycode:{type:o.STRING,allowNull:!0},pm25:{type:o.INTEGER,allowNull:!0},so2:{type:o.INTEGER,allowNull:!0},pm10Improve:{type:o.STRING,allowNull:!0},o3_1hImprove:{type:o.DECIMAL,allowNull:!0},no2Improve:{type:o.DECIMAL,allowNull:!0},o3_8hImprove:{type:o.DECIMAL,allowNull:!0},o3_8h:{type:o.INTEGER,allowNull:!0}},vt={warehouseid:{type:o.STRING,allowNull:!1},name:{type:o.STRING,allowNull:!1},address:{type:o.STRING,allowNull:!1},description:{type:o.TEXT,allowNull:!0},personincharg:{type:o.STRING,allowNull:!0},createtime:{type:o.DATE,allowNull:!1},creator:{type:o.STRING,allowNull:!1}},yt={shelvesid:{type:o.STRING,allowNull:!1},warehouseid:{type:o.STRING,allowNull:!1},location:{type:o.STRING,allowNull:!1},description:{type:o.TEXT,allowNull:!0},createtime:{type:o.DATE,allowNull:!1},creator:{type:o.STRING,allowNull:!1}},wt={locationid:{type:o.STRING,allowNull:!1},shelvesid:{type:o.STRING,allowNull:!1},warehouseid:{type:o.STRING,allowNull:!1},location:{type:o.STRING,allowNull:!1},description:{type:o.TEXT,allowNull:!0},createtime:{type:o.DATE,allowNull:!1},creator:{type:o.STRING,allowNull:!1}},St={assetmodelid:{type:o.STRING,allowNull:!1},locationid:{type:o.STRING,allowNull:!1},count:{type:o.DECIMAL,allowNull:!1},description:{type:o.TEXT,allowNull:!0},createtime:{type:o.DATE,allowNull:!1},creator:{type:o.STRING,allowNull:!1}};a&&(a.registerModel("ModelCategory","modelcategory",ft),a.registerModel("ModelCategoryAttributeMeta","modelcategoryattributemeta",ht),a.registerModel("Model","model",mt),a.registerModel("Asset","asset",gt),a.registerModel("Warehouse","warehouse",vt),a.registerModel("GoodsShelves","goodsshelves",yt),a.registerModel("GoodsLocation","goodslocation",wt),a.registerModel("AssetModelLocation","assetmodellocation",St),a.registerModel("clt_qxpaiming_history","clt_qxpaiming_history",pt)),General.Asset.Model=a,seqModels=_.loadSingleInstance("sequelizeModel");var bt=seqModels.mysqlAccess,At=require("xlsx"),It=function(e){this._name="AssetMethod",this._table_asset="Asset",this._table_model="Model",this._table_modelcategory="ModelCategory",this._table_attributeMeta="ModelCategoryAttributeMeta",e&&(this.assetDBName=e.assetDBName?e.assetDBName:"assetdb")};_.extend(It,c,{generateAndCreateTable:function(e,t){for(var o=e.tableName,a=e.columns,n="create table "+o+"( id int(11) not null auto_increment primary key, ",i=0;i<a.length;i++){var r=a[i],s=r.name,l=r.dataType,u=r.isNotNull,c=r.defaultValue,d=(r.availablevalues,s);d+="Datetime"===l?" datetime ":"Number"===l?" decimal(20,4) ":"Text"===l?" text ":" varchar(255) ",u&&(d+=" not null ",c&&(d+=" default '"+c+"'")),n+=d+","}n=n.substring(0,n.length-1);var f={tableName:o,operatorSql:n+=");"};this.operatorTable(f,t)},operatorTableColumn:function(e,t){var o=e.tableName,a=e.column,n=e.operatorType,i="alter table "+o+" ";if("drop"===n)i+=" drop column "+a.name;else if("add"===n||"modify"===n){i+=n+" "+a.name+" ";var r=a.dataType,s=a.isNotNull,l=a.defaultValue;i+="Datetime"===r?" datetime ":"Number"===r?" decimal(20,4) ":"Text"===r?" text ":" varchar(255) ",s&&(i+=" not null ",l&&(columnCreateSql+=" default '"+l+"'"))}var u={tableName:o,operatorSql:i+=";"};this.operatorTable(u,t)},dropTable:function(e,t){var o={tableName:e,operatorSql:"drop table "+e+";"};this.operatorTable(o,t)},generateCategoryModelAttributeTableName:function(e){return("mca_"+e+"_model").toLowerCase()},generateCategoryConfigureAttributeTableName:function(e){return("mca_"+e+"_configure").toLowerCase()},translateModelCategoryDataFromInterfaceToDB:function(e){if(e){var t={};return t.categoryid=e.categoryId?e.categoryId:"MC"+_.getGUID(6,23),e.categoryName&&(t.categoryname=e.categoryName),e.description&&(t.description=e.description),e.parentId&&(t.parentid=e.parentId),e.createTime?t.createtime=e.createTime:new Date,e.creator&&(t.creator=e.creator),t}return null},translateCategoryAttribute:function(e){if(e){var t={};return e.categoryId&&(t.categoryid=e.categoryId),e.type+""&&(t.attributetype=e.type+""),e.attributeId&&(t.attributeid=e.attributeId),e.attributeName&&(t.attributename=e.attributeName),e.dataType&&(t.datatype=e.dataType),e.isRequired&&(t.isrequired=e.isRequired),e.component&&(t.component=e.component),e.avaliableValues&&(t.avaliablevalues=e.avaliableValues),e.defaultValue&&(t.defaultvalue=e.defaultValue),e.isShowList&&(t.isshowlist=e.isShowList),e.isSelect&&(t.isselect=e.isSelect),e.isFun&&(t.isfun=e.isFun),t}return null},operatorTable:function(e,a){var n=e.tableName,i=e.operatorSql;bt.isTableExist(n,this.assetDBName,function(e,t,o){e?(console.log("DBError "+e.message),a(!1)):0<t.length?a(!1):bt.query(i,{},function(e,t,o){e?(console.log(n+" error: "+JSON.stringify(e)),a(e,null)):(console.log(n+" is operator successfully!!!"),a(null,!0))})})},addModelCategory:function(e,d){for(var f=this,t=e.attributes,o=f.translateModelCategoryDataFromInterfaceToDB(e),h=o.categoryid,m=[],a=0;a<t.length;a++){var n=t[a];n.categoryId=h;var i=f.translateCategoryAttribute(n);m.push(i)}seqModels.seq.transaction(function(e){return seqModels.insertWithTrans(f._table_modelcategory,o,e).then(function(){return seqModels.batchInsertWithTrans(f._table_attributeMeta,m,e)})}).then(function(e){var t=[],o=[];t.push({name:"modelid",dataType:"String",isNotNull:!0,defaultValue:""}),o.push({name:"assetid",dataType:"String",isNotNull:!0,defaultValue:""});for(var a=0;a<m.length;a++){var n=m[a],i={name:n.attributeid,dataType:n.datatype,isNotNull:n.isrequired,defaultValue:n.defaultvalue,avaliableValues:n.avaliablevalues},r=n.attributetype;"0"===r?t.push(i):"1"===r&&o.push(i)}var s=[];if(0<t.length){var l={tableName:f.generateCategoryModelAttributeTableName(h),columns:t};f.generateAndCreateTable(l,function(e,t){e?e.push(e):function(e){if(0<o.length){var t={tableName:f.generateCategoryConfigureAttributeTableName(h),columns:o};f.generateAndCreateTable(t,e)}}(function(e,t){e?(s.push(e),d&&d(s,null)):d&&d(null,t)})})}else if(0<o){var u=f.generateCategoryConfigureAttributeTableName(h),c={tableName:u,columns:u};f.generateAndCreateTable(c,function(e,t){e?d&&d("create table: "+u+" failed!",null):d&&d(e,t)})}}).catch(function(e){d&&d(e,null),console.log("insert model category error: "+JSON.stringify(e))})},operatorCategoryCustAttr:function(e,t){var o=e.categoryId,a={tableName:"0"==e.type?this.generateCategoryModelAttributeTableName(o):this.generateCategoryConfigureAttributeTableName(o),column:{name:e.attributeId,dataType:e.dataType,isNotNull:e.isRequired,defaultValue:e.defaultValue},operatorType:e.operatorType};this.operatorTableColumn(a,t)},addCategoryCustAttr:function(t,o){var a=this,e=a.translateCategoryAttribute(t);seqModels.insert(a._table_attributeMeta,e,function(e){t.operatorType="add",a.operatorCategoryCustAttr(t,o)},function(e){o&&o(e,null)})},modifyCategoryCustAttr:function(t,o){var a=this,e=a.translateCategoryAttribute(t);seqModels.update(a._table_attributeMeta,e,{attributeid:e.attributeid},function(e){t.operatorType="modify",a.operatorCategoryCustAttr(t,o)},function(e){o&&o(e,null)})},dropCategoryCustAttr:function(t,o){var a=this;seqModels.delete(a._table_attributeMeta,{attributeid:t.attributeId},function(e){t.operatorType="drop",a.operatorCategoryCustAttr(t,o)},function(e){o&&o(e,null)})},getModelCategoryList:function(e,t){var o=null,a=null;e&&(o=e.categoryId,a=e.categoryName);var n="select categoryid categoryId, categoryname categoryName, description description  from modelcategories where 1 = 1 ",i={};o&&(n+=" and categoryid like :CATEGORYID",i.CATEGORYID=o+"%"),a&&(n+=" and categoryname like :CATEGORYNAME",i.CATEGORYNAME=a+"%"),seqModels.queryFromSql(n,i,function(e){t(null,e)},function(e){t(e)})},getModelCategoryDetailByCategoryId:function(o,a){if(o){var e={};e.CATEGORYID=o,seqModels.queryFromSql("select categoryid categoryId, categoryname categoryName, description description,  parentid parentId, status status, createtime createTime, creator creator  from assetcategories where categoryid = :CATEGORYID ",e,function(e){if(0<e.length){var t=e[0];seqModels.queryFromSql("select categoryid categoryId, attributetype type,  attributegroupid attributeGroupId, attributeid attributeId,  attributename attributeName, datatype dataType, isrequired isRequired, component component, avaliablevalues avaliableValues, isshowlist isShowList, isselect isSelect  from modelcategoryattributemetas where categoryid = :CATEGORYID ",{CATEGORYID:o},function(e){t.attributes=e,a&&a(null,t)},function(e){a&&a(e,null)})}else a(null,null)},function(e){a(e)})}else a("categoryId is empty! ",null)},groupModelCategoryAndCustomizedAttributes:function(e){for(var t=e.category,o=e.attribute,a=e.creator,n=e.createTime,i=[],r=0;r<t.length;r++){var s=t[r];s.creator=a,s.createTime=n;var l=s.categoryId;s.attributes=[];for(var u=0;u<o.length;u++){var c=o[u];c.categoryId===l&&s.attributes.push(c)}i.push(s)}return i},importModelCategory:function(e,o){var a=this,t=e.user,n=e.excelPath;if(_.isNull(n)||""===n){o&&o("This excelPath is Empty!",null)}else{var l={};try{l=At.readFile(n)}catch(e){return void console.log("无可导入的资产")}var i=l.SheetNames,u={};if(i.forEach(function(e){var t=[],o=l.Sheets[e],a={},n={};for(var i in o)if("!"!==i[0]){var r=i.substring(0,1),s=parseInt(i.substring(1));n=o[i].v,1===s?o.hasOwnProperty(i)&&(a[r]=n.split("/")[1]):1<s&&(t[s-2]||(t[s-2]={}),t[s-2][a[r]]=n)}0<=e.indexOf("Category")&&(u.category=t),0<=e.indexOf("Attribute")&&(u.attribute=t)}),u){u.creator=t?t.aid:"robin",u.createTime=new Date;var r=a.groupModelCategoryAndCustomizedAttributes(u),s={error:[],success:[]},c=0,d=function(e,t){e?s.error.push(e):(s.success.push(t),++c<r.length?a.addModelCategory(r[c],d):o&&o(null,s))};a.addModelCategory(r[c],d)}}},translateModelDataFromInterfaceToDB:function(e){if(e){var t={};return e.modelId&&(t.modelid=e.modelId),e.modelName&&(t.modelname=e.modelName),e.categoryId&&(t.categoryid=e.categoryId),e.description&&(t.description=e.description),e.unit&&(t.unit=e.unit),e.nameplate&&(t.nameplate=JSON.stringify(e.nameplate)),e.createTime&&(t.createtime=e.createTime),e.creator&&(t.creator=e.creator),t}return null},checkAssetModelExist:function(e,t){var o={MODELID:e};seqModels.queryFromSql("select * from assetmodels where modelid = :MODELID ",o,function(e){t(null,0<e.length)},function(e){t(e,null)})},generateModelId:function(e){return e+"-"+_.getGUID(4,22)},addModel:function(e,i){var t=this;if(e){var o=e.categoryId;e.modelId||(e.modelId=t.generateModelId(o));var r=t.translateModelDataFromInterfaceToDB(e),s=e.attributes,l=t.generateCategoryModelAttributeTableName(o);r?seqModels.seq.transaction(function(e){return seqModels.insertWithTrans(t._table_model,r,e)}).then(function(e){if(s){var t="insert into "+l+" (modelid ",o=" values (:MODELID",a={};for(var n in a.MODELID=r.modelid,s)s.hasOwnProperty(n)&&"modelid"!==n&&(t+=", "+n,o+=", :"+n,a[n]=s[n]);t+=") "+o+")",seqModels.insertFromSql(t,a,function(e){i&&i(null,1)},function(e){i&&i(e,null)})}else i&&i(null,1)}).catch(function(e){i&&i(e,null)}):i&&i("Model is null",null)}},getModelList:function(e,t){var o=null,a=null,n=null;e&&(o=e.modelId,a=e.modelName,n=e.categoryId);var i="select modelid modelId, modelname modelName, categoryid categoryId, description description  from models where 1 = 1 ",r={};n&&(i+=" and categoryid like :CATEGORYID ",r.CATEGORYID=n+"%"),o&&(i+=" and modelid like :MODELID ",r.MODELID=o+"%"),a&&(i+=" and modelname like :MODELNAME ",r.MODELNAME=a+"%"),seqModels.queryFromSql(i,r,function(e){t(null,e)},function(e){t(e)})},getModelDetailByModelId:function(e,o){if(e){var t={};t.MODELID=e,seqModels.queryFromSql("select modelid modelId, modelname modelName, categoryid categoryId, description description,  createtime createTime, creator creator  from models where modelid = :MODELID ",t,function(e){if(0<e.length){var t=e[0];t.nameplate=JSON.parse(t.nameplate),t.createTime=_.formatDate(t.createTime,"yyyy-MM-dd hh:mm:ss"),o(null,t)}else o(null,null)},function(e){o(e)})}else o("modelId is empty! ",null)},updateAssetModel:function(e,t){var o=this,a=o.translateModelDataFromInterfaceToDB(e);a?seqModels.seq.transaction(function(e){return seqModels.updateWithTrans(o._table_model,a,{modelid:a.modelid},e)}).then(function(e){t(null,1)}).catch(function(e){t(e,null)}):t("assetModel is null",null)},groupModelAndCustomizedAttributesValue:function(e){if(e){for(var t=[],o=e.model,a=e.attributes,n=e.creator,i=e.createTime,r=0;r<o.length;r++){var s=o[r],l=s.modelId;s.creator=n,s.createTime=i;for(var u=0;u<a.length;u++){var c=a[u];if(c.modelid===l){s.attributes=c;break}}t.push(s)}return t}return null},importModel:function(e,o){var a=this,t=e.user,n=e.excelPath;new Date;if(_.isNull(n)||""===n){o&&o("This excelPath is Empty!",null)}else{var l={};try{l=At.readFile(n)}catch(e){return void console.log(n+"：该路径无可导入的资产")}var i=l.SheetNames,u={};if(i.forEach(function(e){var t=[],o=l.Sheets[e],a={},n={};for(var i in o)if("!"!==i[0]){var r=i.substring(0,1),s=parseInt(i.substring(1));n=o[i].v,1===s?o.hasOwnProperty(i)&&(a[r]=n.split("/")[1]):1<s&&(t[s-2]||(t[s-2]={}),t[s-2][a[r]]=n)}0<=e.indexOf("ModelInfo")&&(u.model=t),0<=e.indexOf("ModelAttributeInfo")&&(u.attributes=t)}),u){u.creator=t?t.aid:"robin",u.createTime=new Date;var r=a.groupModelAndCustomizedAttributesValue(u),s={error:[],success:[]},c=0,d=function(e,t){e?s.error.push(e):(s.success.push(t),++c<r.length?a.addModel(r[c],d):o&&o(null,s))};a.addModel(r[c],d)}}},translateAssetDataFromInterfaceToDB:function(e){if(e){var t={};e.assetId&&(t.assetid=e.assetId),e.assetName&&(t.assetname=e.assetName),e.modelId&&(t.modelid=e.modelId),e.description&&(t.description=e.description),e.count&&(t.count=e.count),e.status&&(t.status=e.status);var o=e.authority;return o&&("public"===o?t.authority="1":"private"===o&&(t.authority="0")),e.createTime&&(t.createtime=e.createTime),e.creator&&(t.creator=e.creator),t}return null},checkAssetExist:function(e,o){var t={ASSETID:e};seqModels.queryFromSql(" select * from assets where assetid = :ASSETID ",t,function(e){var t=0<e.length;o(null,t)},function(e){o(e,null)})},generateAssetId:function(e){return e+"-"+_.getGUID(8,21)},addAsset:function(l,u){var c=this;if(l){var e=l.modelId;seqModels.query(c._table_model,{where:{modelid:e}},function(e){var r=e[0].dataValues.categoryid,s=l.assetId;s||(s=c.generateAssetId(l.modelId),l.assetId=s);var t=c.translateAssetDataFromInterfaceToDB(l);seqModels.seq.transaction(function(e){return seqModels.insertWithTrans(c._table_asset,t,e)}).then(function(e){var t=l.configure;if(t){var o="insert into "+c.generateCategoryConfigureAttributeTableName(r)+" (assetid ",a=" values (:ASSETID",n={};for(var i in n.ASSETID=s,t)t.hasOwnProperty(i)&&"assetid"!==i&&(o+=", "+i,a+=", :"+i,n[i]=t[i]);o+=") "+a+")",seqModels.insertFromSql(o,n,function(e){u&&u(null,1)},function(e){u&&u(e,null)})}else u&&u(null,1)}).catch(function(e){u&&u(e,null)})},function(e){u&&u(e,null)})}else u("asset is null",null)},batchAddAsset:function(v,y){var w=this;if(v&&0<v.length){var e=v[0].modelId;seqModels.query(w._table_model,{where:{modelid:e}},function(e){var g=e[0].dataValues.categoryid,p=[];seqModels.query(w._table_attributeMeta,{where:{categoryid:g,attributetype:"1"}},function(e){for(var t="insert into "+w.generateCategoryConfigureAttributeTableName(g)+" (assetid ",o=[],a=0;a<e.length;a++){var n=e[a].dataValues.attributeid;t+=", "+n,o.push(n)}t+=") values ";for(var i={},r=0;r<v.length;r++){var s=v[r],l=s.assetId;l||(s.assetId=w.generateAssetId(s.modelId));var u=w.translateAssetDataFromInterfaceToDB(s);p.push(u);var c=s.configure;if(c){var d="ASSETID"+_.getGUID(8,34);t+=" (:"+d,i[d]=l;for(var f=0;f<o.length;f++){if("assetid"!==(n=o[f])){var h=n+_.getGUID(8,32);t+=", :"+h;var m=c[n];i[h]=m||null}}t+="),"}}t=t.substring(0,t.length-1),seqModels.seq.transaction(function(e){return seqModels.batchInsertWithTrans2(w._table_asset,p,e)}).then(function(e){seqModels.insertFromSql(t,i,function(e){y&&y(null,1)},function(e){y&&y(e,null)})}).catch(function(e){y&&y(e,null)})},function(e){y&&y(e,null)})},function(e){y&&y(e,null)})}else y("asset is null",null)},groupAssetListToCategoryGroupIds:function(e){for(var t=[],o=e.length,a=0;a<o;a++){var n=e[a],i=n.categoryId,r=0,s=t.length;for(0===s&&(t.push({categoryId:i,modelIds:[],assetIds:[]}),t[0].assetIds.push(n.assetId),t[0].modelIds.push(n.modelId));r<s;r++)if(i===t[r].categoryId){t[r].assetIds.push(n.assetId),t[r].modelIds.push(n.modelId);break}r===t.length&&t.push({categoryId:i,modelIds:[],assetIds:[]})}return t},groupAssetListToModelGroupIds:function(e){for(var t=[],o=e.length,a=0;a<o;a++){for(var n=e[a],i=n.modelId,r=n.categoryId,s=0;s<t.length;s++)if(i===t[s].modelId){t[s].assetIds.push(n.assetId);break}s===t.length&&t.push({categoryId:r,modelId:i,assetIds:[n.assetId]})}return t},getAssetListWithModelProperty:function(e,p){var v=this,t=null,o=null,a=null,y=null;e&&(t=e.assetId,o=e.assetName,a=e.categoryId,y=e.properties);var n="select a.assetid assetId, a.assetname assetName, m.modelid modelId, m.modelname modelName, m.categoryid categoryId, mc.categoryname categoryName,  a.authority authority, a.status status, a.description description  from assets a, models m, modelcategories mc  where a.modelid = m.modelid and mc.categoryid = m.categoryid",i={};a&&("[object Array]"===Object.prototype.toString.call(a)?(n+=" and mc.categoryid in (:CATEGORYID) ",i.CATEGORYID=a):(n+=" and mc.categoryid like :CATEGORYID ",i.CATEGORYID=a+"%")),t&&(n+=" and assetid like :ASSETID ",i.ASSETID=t+"%"),o&&(n+=" and a.assetname like :ASSETNAME ",i.ASSETNAME=o+"%"),seqModels.queryFromSql(n,i,function(e){var c={assetList:e};if(0<e.length){var d=v.groupAssetListToModelGroupIds(e),f=v.groupAssetListToCategoryGroupIds(e),h=-1,m=[],g=function(e){if(e)for(var t=0;t<e.length;t++)m.push(e[t]);if(++h===f.length)return c.modelList=m,p&&p(null,c),null;var o=f[h],a=o.categoryId,n=o.modelIds,i="select mca.modelid modelId, m.modelname modelName";if(y&&0<y.length)for(var r=0;r<y.length;r++){var s=y[r];i+=" , mca."+s+" "+s}i+=" from models m, "+v.generateCategoryModelAttributeTableName(a)+" mca";for(var l=0;l<d.length;l++)n.push(d[l].modelId);0<n.length&&(i+=" where m.modelid = mca.modelid and mca.modelid in (:MODELIDS)");var u={MODELIDS:n};seqModels.queryFromSql(i,u,function(e){g(e)},function(e){p&&p(e,null)})};g()}else p&&p(null,c)},function(e){p&&p(e)})},getModelAttrValueByAssetAndAttrId:function(e,r){var s=this,t=e.asset,o=t.assetId,a=t.assetName,l=e.attrId,n="select a.assetid assetId, a.assetname assetName, m.modelid modelId, m.modelname modelName, m.categoryid categoryId, mc.categoryname categoryName,  a.authority authority, a.status status, a.description description  from assets a, models m, modelcategories mc  where a.modelid = m.modelid and mc.categoryid = m.categoryid",i={};o&&(n+=" and assetid like :ASSETID ",i.ASSETID=o+"%"),a&&(n+=" and a.assetname like :ASSETNAME ",i.ASSETNAME=a+"%"),seqModels.queryFromSql(n,i,function(e){if(e.length){var t=e[0],o=t.categoryId,a=t.modelId,n="select "+l+" from "+s.generateCategoryModelAttributeTableName(o)+" where modelid = :MODELID",i={MODELID:a};seqModels.queryFromSql(n,i,function(e){var t=null;0<e.length&&(t=e[0]),r&&r(null,t)},function(e){r&&r(e,null)})}else r&&r("no this asset: "+JSON.stringify(assetAndAttrName),null)},function(e){r&&r(e,null)})},getModelAttrByAssetAndAttrName:function(l,u){var c=this,e=l.asset,t=e.assetId,o=e.assetName,n=l.attrName,a="select a.assetid assetId, a.assetname assetName, m.modelid modelId, m.modelname modelName, m.categoryid categoryId, mc.categoryname categoryName,  a.authority authority, a.status status, a.description description  from assets a, models m, modelcategories mc  where a.modelid = m.modelid and mc.categoryid = m.categoryid",i={};t&&(a+=" and assetid like :ASSETID ",i.ASSETID=t+"%"),o&&(a+=" and a.assetname like :ASSETNAME ",i.ASSETNAME=o+"%"),seqModels.queryFromSql(a,i,function(e){if(e.length){var t=e[0],r=t.categoryId,s=t.modelId,o="select * from modelcategoryattributemeta  where attributename = :ATTRIBUTENAME ",a={};a.ATTRIBUTENAME=n,r&&(o+=" and categoryid = :CATEGORYID ",a.CATEGORYID=r),seqModels.queryFromSql(o,a,function(e){if(0<e.length){var t=e[0],o=t.attributeid,a={attrMeta:t},n="select "+o+" from "+c.generateCategoryModelAttributeTableName(r)+" where modelid = :MODELID",i={MODELID:s};seqModels.queryFromSql(n,i,function(e){0<e.length&&(a.attrValue=e[0]),u&&u(null,a)},function(e){u&&u(e,null)})}else u&&u("no this attribute: "+JSON.stringify(l),null)},function(e){u&&u(e,null)})}else u&&u("no this asset: "+JSON.stringify(l),null)},function(e){u&&u(e,null)})},updateAssetAuthority:function(e,t){var o=e.assetId,a=e.assetName,n=e.authority;n&&("public"===n?n="1":"private"===n&&(n="0"));var i={};o&&(i.assetid=o),a&&(i.assetName=a),n&&0!==Object.keys(i).length?seqModels.update(this._table_asset,{authority:n},i,function(e){t&&t(null,1)},function(e){t&&t(e,null)}):t&&t("authority and asset must be designated!",null)},getAssetList:function(e,I){var k=this,t=null,o=null,a=null,n=null,i=!1,r=null;if(e&&(t=e.assetId,o=e.assetName,a=e.categoryId,n=e.categoryName,i=!!e.isDetail&&e.isDetail,r=e.aid),!r)return I&&I("userName is must be designated!",null),null;var s="select a.assetid assetId, a.assetname assetName, m.modelid modelId, m.modelname modelName, m.categoryid categoryId, mc.categoryname categoryName,  a.authority authority, a.status status, a.description description, a.creator creator  from assets a, models m, modelcategories mc  where a.modelid = m.modelid and mc.categoryid = m.categoryid",l={};a&&(s+=" and mc.categoryid like :CATEGORYID ",l.CATEGORYID=a+"%"),n&&(s+=" and mc.categoryname like :CATEGORYNAME ",l.CATEGORYNAME=n+"%"),t&&(s+=" and assetid like :ASSETID ",l.ASSETID=t+"%"),o&&(s+=" and a.assetname like :ASSETNAME ",l.ASSETNAME=o+"%"),seqModels.queryFromSql(s,l,function(y){if(i){var e=y.length;if(0<e){for(var t=0;t<e;t++){var o=y[t];"0"===o.authority?o.creator===r?y[t].authority="private":(y.splice(t,1),e--,t--):y[t].authority="public"}if(0<e){var w=k.groupAssetListToCategoryGroupIds(y),S=-1,b=[],A=function(e){if(e)for(var t=e.modelInfo,o=e.configureInfo,a=0;a<y.length;a++){for(var n=y[a],i=0;i<t.length;i++){var r=t[i];if(r.modelid===n.modelId){n.modelInfo=r;break}}for(var s=0;s<o.length;s++){var l=o[s];if(l.assetid===n.assetId){n.configureInfo=l;break}}b.push(n)}if(++S===w.length)return I&&I(null,b),null;var u=w[S],c=u.categoryId,d=u.assetIds,f=u.modelIds,h="select * from "+k.generateCategoryModelAttributeTableName(c)+" where modelid in (:MODELIDS)",m={MODELIDS:f},g="select * from "+k.generateCategoryConfigureAttributeTableName(c)+" where assetid in (:ASSETIDS)",p={ASSETIDS:d},v={};seqModels.queryFromSql(h,m,function(e){v.modelInfo=e,seqModels.queryFromSql(g,p,function(e){v.configureInfo=e,A(v)},function(e){I&&I(e,null)})},function(e){I&&I(e,null)})};A()}else I&&I(null,y)}else I&&I(null,y)}else I&&I(null,y)},function(e){I&&I(e)})},getAssetDetailByAssetId:function(e,d){var f=this,h=e.aid,m=e.assetId;if(m){var t={};t.ASSETID=m,seqModels.queryFromSql("select a.assetid assetId, a.assetname assetName, m.categoryid categoryId,  a.description description, a.modelid modelId,  a.authority authority, a.status, a.createtime createTime, a.creator creator  from assets a, models m where a.modelid = m.modelid and a.assetid = :ASSETID ",t,function(e){if(0<e.length){var a=e[0];if("0"===a.authority&&a.creator!==h){var t="userName: "+h+" cannot view asset: "+m;return d&&d(t,null),t}a.createTime=_.formatDate(a.createTime,"yyyy-MM-dd hh:mm:ss");var o=a.categoryId,n=a.modelId,i=f.generateCategoryModelAttributeTableName(o),r="select * from "+i+" where modelid = :MODELID",s={MODELID:n},l=f.generateCategoryConfigureAttributeTableName(o),u="select * from "+l+" where assetid = :ASSETID",c={ASSETID:m};bt.isTableExist(i,f.assetDBName,function(e,t,o){e?(console.log("DBError "+e.message),d&&d(e,null)):0<t.length?seqModels.queryFromSql(r,s,function(e){0<e.length&&(a.modelInfo=e[0]),bt.isTableExist(l,f.assetDBName,function(e,t,o){e?(console.log("DBError "+e.message),d&&d(e,null)):0<t.length?seqModels.queryFromSql(u,c,function(e){0<e.length&&(a.configureInfo=e[0],d&&d(null,a))},function(e){d&&d(e,null)}):d&&d(null,a)})},function(e){d&&d(e,null)}):bt.isTableExist(l,f.assetDBName,function(e,t,o){e?(console.log("DBError "+e.message),d&&d(e,null)):0<t.length?seqModels.queryFromSql(u,c,function(e){0<e.length&&(a.configureInfo=e[0],d&&d(null,a))},function(e){d&&d(e,null)}):d&&d(null,a)})})}else d&&d(null,null)},function(e){d&&d(e)})}else d&&d("assetId is empty! ",null)},updateAsset:function(e,i){var r=this,s=e.aid,t=e.asset,l=t.configure,u=r.translateAssetDataFromInterfaceToDB(t),c=u.assetid;if(u){var o={};o.ASSETID=c,seqModels.queryFromSql("select a.assetid assetId, a.assetname assetName, m.categoryid categoryId,  a.description description, a.modelid modelId,  a.authority authority, a.status, a.createtime createTime, a.creator creator  from assets a, models m where a.modelid = m.modelid and a.assetid = :ASSETID ",o,function(e){if(0<e.length){var t=e[0];if(t.creator!==s){var o="userName: "+s+" cannot update asset: "+c;return i&&i(o,null),o}var a=t.categoryId,n=r.generateCategoryConfigureAttributeTableName(a);seqModels.seq.transaction(function(e){return seqModels.updateWithTrans(r._table_asset,u,{assetid:c},e)}).then(function(e){if(l){var t="update "+n+" set ",o={};Object.keys(l).forEach(function(e){"assetid"!==e&&(t+=e+"=:"+e+",",o[e]=l[e])}),t=t.substring(0,t.length-1)+" where assetid=:ASSETID",o.ASSETID=c,seqModels.updateFromSql(t,o,function(e){i&&i(null,1)},function(e){i&&i(e,null)})}else i&&i(null,1)}).catch(function(e){i(e,null)})}else i&&i("asset: "+c+" does not existed!",null)},function(e){i&&i(e,null)})}else i("asset is null! ",null)},deleteAsset:function(e,n){var i=this,r=e.aid,s=e.assetId;if(s){var t={};t.ASSETID=s,seqModels.queryFromSql("select a.assetid assetId, a.assetname assetName, m.categoryid categoryId,  a.description description, a.modelid modelId,  a.authority authority, a.status, a.createtime createTime, a.creator creator  from assets a, models m where a.modelid = m.modelid and a.assetid = :ASSETID ",t,function(e){if(0<e.length){var t=e[0];if(t.creator!==r){var o="userName: "+r+" cannot delete asset: "+s;return n&&n(o,null),o}var a=t.categoryId;seqModels.seq.transaction(function(e){return seqModels.deleteWithTrans(i._table_asset,{assetid:s},e)}).then(function(e){var t="delete from "+i.generateCategoryConfigureAttributeTableName(a)+" where assetid = :ASSETID",o={ASSETID:s};seqModels.deleteFromSql(t,o,function(e){n&&n(null,1)},function(e){n&&n(e,null)})}).catch(function(e){n(e,null)})}else n&&n("asset: "+s+" does not existed!",null)},function(e){n&&n(e,null)})}else n("asset is null! ",null)},groupAssetAndCustomizedConfigure:function(e){if(e){for(var t=[],o=e.assetList,a=e.configureList,n=e.creator,i=e.createTime,r=0;r<o.length;r++){var s=o[r],l=s.assetId;s.creator=n,s.createTime=i;for(var u=0;u<a.length;u++){var c=a[u];if(c.assetid===l){s.configure=c;break}}t.push(s)}return t}return null},importAsset:function(e,t){var o=e.user,a=e.excelPath;if(_.isNull(a)||""===a){t&&t("This excelPath is Empty!",null)}else{var l=At.readFile(a),n=l.SheetNames,u={};if(n.forEach(function(e){var t=[],o=l.Sheets[e],a={},n={};for(var i in o)if("!"!==i[0]){var r=i.substring(0,1),s=parseInt(i.substring(1));n=o[i].v,1===s?o.hasOwnProperty(i)&&(a[r]=n.split("/")[1]):1<s&&(t[s-2]||(t[s-2]={}),t[s-2][a[r]]=n)}0<=e.indexOf("AssetInfo")&&(u.assetList=t),0<=e.indexOf("AssetConfigureInfo")&&(u.configureList=t)}),u){u.creator=o?o.aid:"admin",u.createTime=new Date;var i=this.groupAssetAndCustomizedConfigure(u);this.batchAddAsset(i,t)}}}}),General.Asset.AssetMethod=It;var kt=function(){this._name="WarehouseMethod",this._table_asset="Asset",this._table_model="AssetModel",this._table_modelcategory="AssetCategory",this._table_warehouse="Warehouse",this._table_goodsshelves="GoodsShelves",this._table_goodslocation="GoodsLocation",this._table_assetmodellocation="AssetModelLocation"};_.extend(kt,c,{translateWarehouseDataFromInterfaceToDB:function(e){if(e){var t={};return e.warehouseId&&(t.warehouseid=e.warehouseId),e.name&&(t.name=e.name),e.address&&(t.address=e.address),e.description&&(t.description=e.description),e.personInCharg&&(t.personincharg=e.personInCharg),e.createTime&&(t.createtime=e.createTime),e.creator&&(t.creator=e.creator),t}return null},translateGoodsShelvesDataFromInterfaceToDB:function(e){if(e){var t={};return e.warehouseId&&(t.warehouseid=e.warehouseId),e.shelvesId&&(t.shelvesid=e.shelvesId),e.location&&(t.location=e.location),e.description&&(t.description=e.description),e.createTime&&(t.createtime=e.createTime),e.creator&&(t.creator=e.creator),t}return null},translateGoodsLocationDataFromInterfaceToDB:function(e){if(e){var t={};return e.locationId&&(t.locationid=e.locationId),e.shelvesId&&(t.shelvesid=e.shelvesId),e.warehouseId&&(t.warehouseid=e.warehouseId),e.location&&(t.location=e.location),e.description&&(t.description=e.description),e.createTime&&(t.createtime=e.createTime),e.creator&&(t.creator=e.creator),t}return null},checkWarehouseExist:function(e,t){seqModels.query(this._table_warehouse,{where:{warehouseid:e}},function(e){t(null,0<e.length)},function(e){t(e,null)})},addWarehouse:function(y,w){var S=this;S.checkWarehouseExist(y.warehouseId,function(e,t){if(e)w(e,null);else if(t)w("warehouseId: "+y.warehouseId+" is exist!",null);else{for(var o=y.createTime?y.createTime:new Date,a=y.creator?y.creator:"",n=S.translateWarehouseDataFromInterfaceToDB(y),i=y.warehouseId,r=y.shelves,s=r.length,l=[],u=[],c=0;c<s;c++){var d=r[c],f=S.translateGoodsShelvesDataFromInterfaceToDB(d);if(f){f.warehouseid=i,f.createtime=o,f.creator=a,l.push(f);for(var h=f.shelvesid,m=d.locations,g=m.length,p=0;p<g;p++){var v=S.translateGoodsLocationDataFromInterfaceToDB(m[p]);v&&(v.shelvesid=h,v.warehouseid=i,v.createtime=o,v.creator=a,u.push(v))}}}seqModels.seq.transaction(function(e){return seqModels.insertWithTrans(S._table_warehouse,n,e).then(function(){return seqModels.batchInsertWithTrans(S._table_goodsshelves,l,e).then(function(){return seqModels.batchInsertWithTrans(S._table_goodslocation,u,e)})})}).then(function(e){w(null,1)}).catch(function(e){w(e,null)})}})},getWarehouseList:function(e,t){var o=e?e.warehouseId:null,a=e?e.warehouseName:null,n="select warehouseid warehouseId, name name, description description, address address  from warehouses where 1 = 1 ",i={};o&&(n+=" and warehouseid like :WAREHOUSEID",i.WAREHOUSEID=o+"%"),a&&(n+=" and name like :WAREHOUSENAME",i.WAREHOUSENAME=a+"%"),seqModels.queryFromSql(n,i,function(e){t(null,e)},function(e){t(e)})},groupGoodsLocationOfGoodsShelves:function(e,t){for(var o=[],a=0;a<e.length;a++){for(var n=[],i=e[a],r=i.shelvesId,s=0;s<t.length;s++){var l=t[s];r===l.shelvesId&&n.push(l)}i.locations=n,o.push(i)}return o},getWarehouseDetailByWarehouseId:function(a,n){if(a){var i=this,e={};e.WAREHOUSEID=a,seqModels.queryFromSql("select warehouseid warehouseId, name name, description description, address address,  personincharg personInCharg, createtime createTime, creator creator  from warehouses where warehouseid = :WAREHOUSEID ",e,function(e){if(0<e.length){var o=e[0];o.createTime=_.formatDate(o.createTime,"yyyy-MM-dd hh:mm:ss");var t={};t.WAREHOUSEID=a,seqModels.queryFromSql("select shelvesid shelvesId, warehouseid, warehouseId, location location,  description description, createtime createTime, creator creator  from goodsshelves where warehouseid = :WAREHOUSEID ",t,function(t){var e={};e.WAREHOUSEID=a,seqModels.queryFromSql("select shelvesid shelvesId, locationid, locationId, location location,  description description, createtime createTime, creator creator  from goodslocations where warehouseid = :WAREHOUSEID ",e,function(e){o.shelves=i.groupGoodsLocationOfGoodsShelves(t,e),n(null,o)},function(e){n(e,null)})},function(e){n(e,null)})}else n(null,null)},function(e){n(e)})}else n("warehouseId is empty! ",null)},updateWarehouse:function(e,t){for(var o=this,a=o.translateWarehouseDataFromInterfaceToDB(e),n=e.shelves,i=n.length,r=[],s=[],l=a.warehouseid,u=0;u<i;u++){var c=n[u],d=o.translateGoodsShelvesDataFromInterfaceToDB(c);if(d){d.warehouseid=l,r.push(d);for(var f=d.shelvesid,h=c.locations,m=h.length,g=0;g<m;g++){var p=o.translateGoodsLocationDataFromInterfaceToDB(h[g]);p&&(p.shelvesid=f,p.warehouseid=l,s.push(p))}}}seqModels.seq.transaction(function(e){return seqModels.updateWithTrans(o._table_warehouse,a,{warehouseid:l},e).then(function(){return seqModels.deleteWithTrans(o._table_goodsshelves,{warehouseid:l},e).then(function(){return seqModels.deleteWithTrans(o._table_goodslocation,{warehouseid:l},e).then(function(){return seqModels.batchInsertWithTrans(o._table_goodsshelves,r,e).then(function(){return seqModels.batchInsertWithTrans(o._table_goodslocation,s,e)})})})})}).then(function(e){t(null,1)}).catch(function(e){t(e,null)})},checkGoodsShelvesExist:function(e,t){var o=e.warehouseId,a=e.shelvesId,n=" select * from goodsshelves where 1 =1 ",i={};o&&(n+=" and warehouseid = :WAREHOUSEID ",i.WAREHOUSEID=o),a&&(n+=" and shelvesid = :SHELVESID ",i.SHELVESID=a),seqModels.queryFromSql(n,i,function(e){t(null,0<e.length)},function(e){t(e,null)})},checkGoodsLocationExist:function(e,t){var o=e.warehouseId,a=e.shelvesId,n=e.locationId,i=" select * from goodslocations where 1 =1 ",r={};o&&(i+=" and warehouseid = :WAREHOUSEID ",r.WAREHOUSEID=o),a&&(i+=" and shelvesid = :SHELVESID ",r.SHELVESID=a),n&&(i+=" and locationid = :LOCATIONID ",r.LOCATIONID=n),seqModels.queryFromSql(i,r,function(e){t(null,0<e.length)},function(e){t(e,null)})},getGoodsShelvesList:function(e,t){var o=e.warehouseId,a=e.shelvesId,n="select shelvesid shelvesId, warehouseid warehouseId, location location, description description  from goodsshelves where 1 = 1 ",i={};o&&(n+=" and warehouseid = :WAREHOUSEID",i.WAREHOUSEID=o),a&&(n+=" and shelvesid = :SHELVESID",i.SHELVESID=a),seqModels.queryFromSql(n,i,function(e){t(null,e)},function(e){t(e)})},getGoodsLocationsList:function(e,t){var o=e.warehouseId,a=e.shelvesId,n=e.locationId,i="select locationid locationId, shelvesid shelvesId, warehouseid warehouseId, location location,  description description  from goodslocations where 1 = 1 ",r={};o&&(i+=" and warehouseid = :WAREHOUSEID",r.WAREHOUSEID=o),a&&(i+=" and shelvesid = :SHELVESID",r.SHELVESID=a),n&&(i+=" and locationid = :LOCATIONID",r.LOCATIONID=n),seqModels.queryFromSql(i,r,function(e){t(null,e)},function(e){t(e)})},updateAssetModelCountInGoodsLocation:function(e,o){var a=this,n=e.locationId,i=e.assetModelId,r=e.changeCount,s=e.creator,t={LOCATIONID:n,ASSETMODELID:i};seqModels.queryFromSql("select * from assetmodellocations where locationid = :LOCATIONID and assetmodelid = :ASSETMODELID",t,function(e){if(0<e.length){(t=e[0]).count=t.count+r,seqModels.seq.transaction(function(e){return seqModels.updateWithTrans(a._table_assetmodellocation,t,{locationid:n,assetmodelid:i},e)}).then(function(e){o&&o(null,1)}).catch(function(e){o&&o(e,null)})}else{var t={locationid:n,assetmodelid:i,count:r,createtime:new Date,creator:s};seqModels.seq.transaction(function(e){return seqModels.insertWithTrans(a._table_assetmodellocation,t,e)}).then(function(e){o&&o(null,1)}).catch(function(e){o&&o(e,null)})}},function(e){o&&o(e,null)})}}),General.Asset.WarehouseMethod=kt;D=require("path"),It=General.Asset.AssetMethod,kt=General.Asset.WarehouseMethod;var Tt=function(){_.callSuper(Tt,this,arguments),this._name="asset",this._warehouseMethod=new kt,this.focusedEventArray=[{event:"updateAssetModelCountInGoodsLocation",onEvent:"updateAssetModelCountInGoodsLocation"},{event:"StorageAssetModel",onEvent:"StorageAssetModel"}]};_.extend(Tt,m,{initAssetMethod:function(){var e=this._platform._settings.weserviceSettings.sessionOption.database,t={assetDBName:e=e||"assetdb"};this._assetMethod=new It(t)},runningOnPlatform:function(e){_.invokeSuper(Tt,"runningOnPlatform",this,[e]),this.initAssetMethod();var t={logid:_.getGUID(20),type:"runningOnPlatform",content:JSON.stringify({module:"asset"}),category:"1",operator:null,createtime:new Date,operatorip:"172.0.0.1",result:"SUCCESS"};d.fireEvent("log_addLogging",t),console.log(JSON.stringify(t))},getExports:function(){return["reqAddModelCategory","reqGetModelCategoryList","reqGetModelCategoryDetail","reqCheckAssetModelExist","reqAddModel","reqGetModelList","reqGetModelDetail","reqUpdateAssetModel","reqImportAssetModel","reqCheckAssetExist","reqAddAsset","reqGetAssetList","reqGetAssetDetail","reqUpdateAsset","reqDeleteAsset","reqImportAsset","reqCheckWarehouseExist","reqAddWarehouse","reqGetWarehouseList","reqGetWarehouseDetail","reqUpdateWarehouse","reqCheckGoodsShelvesExist","reqCheckGoodsLocationsExist","reqGetGoodsShelvesList","reqGetGoodsLocationsList"]},reqAddModelCategory:function(e,o,t){var a={action:"reqAddModelCategory"},n=e.session.user,i=e.body.modelCategory;i.createTime=new Date,i.creator=n?n.aid:"robin";return this._assetMethod.addModelCategory(i,function(e,t){e?(a.status=b.F,a.error=e):(a.status=b.S,a.result={data:t}),o.json(a)})},reqGetModelCategoryList:function(e,o,t){var a={action:"reqGetModelCategoryList"},n=e.body.filterInfo;return this._assetMethod.getModelCategoryList(n,function(e,t){e?(a.status=b.F,a.error=e):(a.status=b.S,a.result={data:t}),o.json(a)})},reqGetModelCategoryDetail:function(e,o,t){var a={action:"reqGetModelCategoryDetail"},n=e.body.categoryId;return this._assetMethod.getModelCategoryDetailByCategoryId(n,function(e,t){e?(a.status=b.F,a.error=e):(a.status=b.S,a.result={data:t}),o.json(a)})},reqCheckAssetModelExist:function(e,o,t){var a={action:"reqCheckAssetModelExist"},n=e.body.assetModelId;return this._assetMethod.checkAssetModelExist(n,function(e,t){e?(a.status=b.F,a.error=e):(a.status=b.S,a.result={data:t}),o.json(a)})},reqAddAssetModel:function(e,o,t){var a={action:"reqAddAssetModel"},n=e.session.user,i=e.body.model;i.createTime=new Date,i.creator=n?n.aid:"robin";return this._assetMethod.addModel(i,function(e,t){e?(a.status=b.F,a.error=e):(a.status=b.S,a.result={data:t}),o.json(a)})},reqGetModelList:function(e,o,t){var a={action:"reqGetModelList"},n=e.body.filterInfo;return this._assetMethod.getModelList(n,function(e,t){e?(a.status=b.F,a.error=e):(a.status=b.S,a.result={data:t}),o.json(a)})},reqGetModelDetail:function(e,o,t){var a={action:"reqGetModelDetail"},n=e.body.modelId;return this._assetMethod.getModelDetailByModelId(n,function(e,t){e?(a.status=b.F,a.error=e):(a.status=b.S,a.result={data:t}),o.json(a)})},getAssetDetailByAssetIdAtPlatform:function(e,o){this._assetMethod.getAssetDetailByAssetId(e,function(e,t){e?o(e):o(null,t)})},reqUpdateAssetModel:function(e,o,t){var a={action:"reqUpdateAssetModel"},n=e.body.assetModel;return this._assetMethod.updateAssetModel(n,function(e,t){e?(a.status=b.F,a.error=e):(a.status=b.S,a.result={data:t}),o.json(a)})},reqImportAssetModel:function(e,o,t){var a={action:"reqImportAssetModel"},n=e.body.assetModel;return this._assetMethod.importAssetModel(n,function(e,t){e?(a.status=b.F,a.error=e):(a.status=b.S,a.result={data:t}),o.json(a)})},reqCheckAssetExist:function(e,o,t){var a={action:"reqCheckAssetExist"},n=e.body.assetId;return this._assetMethod.checkAssetExist(n,function(e,t){e?(a.status=b.F,a.error=e):(a.status=b.S,a.result={data:t}),o.json(a)})},reqAddAsset:function(e,o,t){var a={action:"reqAddAsset"},n=e.session.user,i=e.body.asset;i.createTime=new Date,n.aid?i.creator=n.aid:i.creator=n;return this._assetMethod.addAsset(i,function(e,t){e?(a.status=b.F,a.error=e):(a.status=b.S,a.result={data:t}),o.json(a)})},addAssetManeger:function(e){e.createTime=new Date,this._assetMethod.addAsset(e,function(e,t){if(e)throw e})},reqGetAssetList:function(e,o,t){var a={action:"reqGetAssetList"},n=e.body.filterInfo;return this._assetMethod.getAssetList(n,function(e,t){e?(a.status=b.F,a.error=e):(a.status=b.S,a.result={data:t}),o.json(a)})},reqGetAssetDetail:function(e,o,t){var a={action:"reqGetAssetDetail"},n=e.session.user,i=e.body.assetId,r={aid:n.aid,assetId:i};return this._assetMethod.getAssetDetailByAssetId(r,function(e,t){e?(a.status=b.F,a.error=e):(a.status=b.S,a.result={data:t}),o.json(a)})},reqUpdateAsset:function(e,o,t){var a={action:"reqUpdateAsset"},n=e.session.user,i=e.body;n.aid?i.aid=n.aid:i.aid=n;return this._assetMethod.updateAsset(i,function(e,t){e?(a.status=b.F,a.error=e):(a.status=b.S,a.result={data:t}),o.json(a)})},reqDeleteAsset:function(e,o,t){var a={action:"reqDeleteAsset"},n=e.body,i=e.session.user,r=n.assetId,s={aid:i.aid?i.aid:i,assetId:r};return this._assetMethod.deleteAsset(s,function(e,t){e?(a.status=b.F,a.error=e):(a.status=b.S,a.result={data:t}),o.json(a)})},reqImportAsset:function(e,o,t){var a={action:"reqImportAsset"},n=this._platform,i=e.session.user,r={};r.user=i;var s=this,l=[{req:e,maxfieldssize:5242880,filetype:"application/vnd.openxmlformats-officedocument.spreadsheetml.sheet",callback:function(e,t){if(e)a.status=b.F,a.error=e,o.json(a);else{r.excelName=t[0].avatarname,r.excelPath=t[0].newPath;s._assetMethod.importAsset(r,function(e,t){e?(a.status=b.F,a.error=e):(a.status=b.S,a.result=r.excelName),o.json(a)})}}}];n.runModule("uploading","uploadFile",l)},importModelCategory:function(e,t){return this._assetMethod.importModelCategory(e,t)},importModel:function(e,t){return this._assetMethod.importModel(e,t)},importAsset:function(e,t){return this._assetMethod.importAsset(e,t)},getAssetList:function(e,t){return this._assetMethod.getAssetList(e,t)},getAssetDetail:function(e,t){if(!e.aid){var o="aid must be designated!";return t&&t(o,null),{error:o}}return this._assetMethod.getAssetDetailByAssetId(e.assetId,t)},updateAsset:function(e,t){if(!e.aid){var o="aid must be designated!";return t&&t(o,null),{error:o}}return this._assetMethod.updateAsset(e,t)},deleteAsset:function(e,t){if(!e.aid){var o="aid must be designated!";return t&&t(o,null),{error:o}}return this._assetMethod.deleteAsset(e,t)},addModelCategoryCustAttr:function(e,t){return this._assetMethod.addCategoryCustAttr(e,t)},modifyModelCategoryCustAttr:function(e,t){return this._assetMethod.modifyCategoryCustAttr(e,t)},dropModelCategoryCustAttr:function(e,t){return this._assetMethod.dropCategoryCustAttr(e,t)},getAssetListWithModelProperty:function(e,t){return this._assetMethod.getAssetListWithModelProperty(e,t)},getModelAttrValueByAssetAndAttrId:function(e,t){return this._assetMethod.getModelAttrValueByAssetAndAttrId(e,t)},getModelAttrByAssetAndAttrName:function(e,t){return this._assetMethod.getModelAttrByAssetAndAttrName(e,t)},updateAssetAuthority:function(e,t){return this._assetMethod.updateAssetAuthority(e,t)},reqCheckWarehouseExist:function(e,o,t){var a={action:"reqCheckWarehouseExist"},n=e.body.warehouseId;return this._warehouseMethod.checkWarehouseExist(n,function(e,t){e?(a.status=b.F,a.error=e):(a.status=b.S,a.result={data:t}),o.json(a)})},reqAddWarehouse:function(e,o,t){var a={action:"reqAddAsset"},n=e.session.user,i=e.body.warehouse;i&&(i.createTime=new Date,i.creator=n.aid);return this._warehouseMethod.addWarehouse(i,function(e,t){e?(a.status=b.F,a.error=e):(a.status=b.S,a.result={data:t}),o.json(a)})},reqGetWarehouseList:function(e,o,t){var a={action:"reqGetWarehouseList"},n=(e.session.user,e.body.filterInfo);return this._warehouseMethod.getWarehouseList(n,function(e,t){e?(a.status=b.F,a.error=e):(a.status=b.S,a.result={data:t}),o.json(a)})},reqGetWarehouseDetail:function(e,o,t){var a={action:"reqGetWarehouseDetail"},n=(e.session.user,e.body.warehouseId);return this._warehouseMethod.getWarehouseDetailByWarehouseId(n,function(e,t){e?(a.status=b.F,a.error=e):(a.status=b.S,a.result={data:t}),o.json(a)})},reqUpdateWarehouse:function(e,o,t){var a={action:"reqUpdateWarehouse"},n=(e.session.user,e.body.warehouse);return this._warehouseMethod.updateWarehouse(n,function(e,t){e?(a.status=b.F,a.error=e):(a.status=b.S,a.result={data:t}),o.json(a)})},reqCheckGoodsShelvesExist:function(e,o,t){var a={action:"reqCheckGoodsShelvesExist"},n=e.body.goodsShelvesInfo;return this._warehouseMethod.checkGoodsShelvesExist(n,function(e,t){e?(a.status=b.F,a.error=e):(a.status=b.S,a.result={data:t}),o.json(a)})},CheckGoodsLocationExist:function(e,o,t){var a={action:"CheckGoodsLocationExist"},n=e.body.goodsLocationInfo;return this._warehouseMethod.checkGoodsLocationExist(n,function(e,t){e?(a.status=b.F,a.error=e):(a.status=b.S,a.result={data:t}),o.json(a)})},reqGetGoodsShelvesList:function(e,o,t){var a={action:"reqGetGoodsShelvesList"},n=(e.session.user,e.body.filterInfo);return this._warehouseMethod.getGoodsShelvesList(n,function(e,t){e?(a.status=b.F,a.error=e):(a.status=b.S,a.result={data:t}),o.json(a)})},reqGetGoodsLocationsList:function(e,o,t){var a={action:"reqGetGoodsLocationsList"},n=(e.session.user,e.body.filterInfo);return this._warehouseMethod.getGoodsLocationsList(n,function(e,t){e?(a.status=b.F,a.error=e):(a.status=b.S,a.result={data:t}),o.json(a)})},updateAssetModelCountInGoodsLocation:function(e){var o=this,t=e.value,a=e.callback,n=t.locationId,i=t.assetModelId,r=t.changeCount,s=t.creator,l={LOCATIONID:n,ASSETMODELID:i};seqModels.queryFromSql("select * from assetmodellocations where locationid = :LOCATIONID and assetmodelid = :ASSETMODELID",l,function(e){if(0<e.length){(t=e[0]).count=t.count+r,seqModels.seq.transaction(function(e){return seqModels.updateWithTrans(o._warehouseMethod._table_assetmodellocation,t,{locationid:n,assetmodelid:i},e)}).then(function(e){a&&a(null,1)}).catch(function(e){a&&a(e,null)})}else{var t={locationid:n,assetmodelid:i,count:r,createtime:new Date,creator:s};seqModels.seq.transaction(function(e){return seqModels.insertWithTrans(o._warehouseMethod._table_assetmodellocation,t,e)}).then(function(e){a&&a(null,1)}).catch(function(e){a&&a(e,null)})}},function(e){a&&a(e,null)})}}),General.Asset.Module=Tt,General.Acquisition={},General.Acquisition.Acquisition={},General.Acquisition.AcquisitionFactory={},General.Acquisition.XMLAcquisition={},General.Acquisition.Channel={},General.Acquisition.ChannelFactory={},General.Acquisition.AnalogChannel={},General.Acquisition.SoapChannel={},General.Acquisition.RestChannel={},General.Acquisition.RestChannel={},General.Acquisition.Terminal={},General.Acquisition.BusinssObject={},General.Acquisition.CommFactory={},General.Acquisition.Communication={},General.Acquisition.AnalogComm={},General.Acquisition.SoapComm={},General.Acquisition.RestComm={},General.Acquisition.Protocol={},General.Acquisition.ProtocolFactory={},General.Acquisition.AnalogProtocol={},General.Acquisition.SmokeSensorProtocol={},General.Acquisition.RestProtocol={},General.Acquisition.Order={},General.Acquisition.OrderManagement={};var Mt={collecttime:{type:o.DATE,allowNull:!1},terminalid:{type:o.STRING,allowNull:!1},boid:{type:o.TEXT,allowNull:!1},state:{type:o.STRING,allowNull:!1},basebatterylevel:{type:o.TEXT,allowNull:!1},probebatterylevel:{type:o.STRING,allowNull:!1},signalintensity:{type:o.STRING,allowNull:!1},createtime:{type:o.DATE,allowNull:!0}},Dt={collecttime:{type:o.DATE,allowNull:!1},terminalid:{type:o.STRING,allowNull:!1},boid:{type:o.TEXT,allowNull:!1},statustype:{type:o.STRING,allowNull:!1},alarmcontext:{type:o.TEXT,allowNull:!0},createtime:{type:o.DATE,allowNull:!0}};a&&(a.registerModel("AcquisitionRunRecord","acquisitionrunrecord",Mt),a.registerModel("AcquisitionAlarmRecord","acquisitionalarmrecord",Dt)),General.Acquisition.Model=a;var Nt=function(e){this._name="order",this.init(e)};_.extend(Nt,Object,{init:function(e){console.log("order init run!"),this.id=e.id?e.id:_.getTimeGUID(new Date,10),this.bos=this.initBos(e.bos),this.type=e.type,this.onlySendChange=!e.onlySendChange||e.onlySendChange,this.formatDataFunc=e.formatDataFunc,this.lastSendData=null,this.callback=e.callback},initBos:function(e){if(e&&e instanceof Array){for(var t=e.length,o=[],a=0;a<t;a++){for(var n=this.splitBoIdAndDesc(e[a]),i=n.boId,r=0,s=o.length;r<s;r++){var l=o[r];if(l.boId===i){o[r].property.push(l.property);break}}r===s&&o.push({boId:n.boId,property:[n.property]})}return o}return[]},splitBoIdAndDesc:function(e){var t=e.split("_");return t&&2===t.length?{boId:t[0],property:t[1]}:null},addData:function(e){this.lastSendData=e},checkContainBo:function(e){if(e)for(var t=e.length,o=this.bos,a=0;a<t;a++)for(var n=e[a],i=0;i<o.length;i++){var r=o[i].boId;if(n.boId===r)return!0}return!1},getChangeData:function(e){var t=this.lastSendData,o=[];if(t)for(var a=0;a<e.length;a++)for(var n=e[a],i=0;i<t.length;i++){var r=t[i];if(n.boId===r.boId){var s={};Object.keys(r).forEach(function(e){var t=n[e];r[e]!==t&&(s[e]=t)}),"{}"!==JSON.stringify(s)&&(s.boId=n.boId,o.push(s));break}}else o=e;return o},sendData:function(e){var t=this.bos,o={orderId:this.id},a=this.formatDataFunc,n=[],i=null;if(i=this.onlySendChange?this.getChangeData(e):e)for(var r=i.length,s=0;s<t.length;s++)for(var l=t[s],u=l.boId,c=l.property,d=0;d<r;d++){var f=i[d];if(f.boId===u){for(var h={boId:u},m=0;m<c.length;m++){var g=c[m];g&&(h[g]=f[g])}n.push(h);break}}0<n.length&&(o.data=n,a&&(o=a(o)),this.callback(o),this.addData(e))},deleteData:function(e){console.log("order deleteData run!")},emptyData:function(){console.log("order empty Data"),this.lastSendData=null}}),General.Acquisition.Order=Nt;var Et=require("redis"),Rt=Et.createClient(6379,"localhost"),_t=Et.createClient(6379,"localhost"),Gt=function(){this._name="ordermanagement",this._dynamicOrders=[],this._staticOrders=[];var a=this;_t.subscribe("analogNewFormatData"),_t.subscribe("analogLangchaoData"),_t.on("message",function(e,t){var o=JSON.parse(t);a.runOrder(o)})};_.extend(Gt,Object,{registerOrder:function(e){if(console.log("registerOrder run!"),!this.checkAndReplaceOrderExist(e)){var t=e?e.type:0;0===t?this._staticOrders.push(e):1===t&&this._dynamicOrders.push(e)}},dispatchOrderOldData:function(e){var r=this,s=e.type,t=e.bos;Rt.get(t,function(e,t){for(var o=[],a=0;a<t.length;a++){var n=t[a];n=JSON.parse(n),o.push(n)}var i={oldData:null,newData:o};0===s?r.dispatchStaticOrder(i):1===s&&r.dispatchDynamicOrder(i)})},checkAndReplaceOrderExist:function(e){var t=e.id,o=e?e.type:0,a=null;0===o?a=this._staticOrders:1===o&&(a=this._dynamicOrders);for(var n=0;n<a.length;n++)if(t===a[n].id)return a[n]=e,!0;return!1},releaseOrder:function(e){console.log("releaseOrder run!");for(var t=this._dynamicOrders,o=0;o<t.length;o++){t[o].id===e&&(this._dynamicOrders.splice(o,1),o--)}},dispatchStaticOrder:function(e){for(var t=this._staticOrders,o=t.length,a=0;a<o;a++){var n=t[a],i=e.formattedData;n.checkContainBo(i)&&(n.sendData(i),this._staticOrders.splice(a,1),o--,0<a&&a--)}},dispatchDynamicOrder:function(e){for(var t=e.formattedData,o=this._dynamicOrders,a=0;a<o.length;a++){var n=o[a];n.checkContainBo(t)&&n.sendData(t)}},updateBoAlarmDataSnap:function(e){if(e){var t=e.id;t&&(this._boAlarmDataSnap[t]=e)}},runOrder:function(e){this.dispatchDynamicOrder(e),this.dispatchStaticOrder(e)}}),General.Acquisition.OrderManagement=new Gt,General.Acquisition.Protocol={};var Ft=function(e){this._name="Protocol",this.init(e)};_.extend(Ft,Object,{init:function(e){console.log("protocol init run!"),this.id=e.id?e.id:_.getGUID(13,25),this.terminals=e.terminals,this.isSaveToDB=!!e.isSaveToDB&&e.isSaveToDB,this.saveInterval=e.saveInterval,this.defauleSaveInterval="* 5/* * * * *",this.historyTable=e.historyTable,this.saveToDBJob=null,this.isReceiveOrder=!e.isReceiveOrder||e.isReceiveOrder,this.state="0"},bindChannel:function(e){console.log("protocol bindChannel run!"),this.channel=e,this.isSaveToDB&&this.startSaveDataToDB(),this.state="1"},receive:function(e){if(console.log("protocol processData run!"),e){var t=this.parseData(e);t&&this.saveDataToMemory(t)}},parseData:function(e){console.log("protocol parseData run!")},saveDataToMemory:function(e){console.log("protocol saveDataToMemory run!")},saveDataToDB:function(e){console.log("protocol saveDataToDB run!")},startSaveDataToDB:function(){if(console.log("protocol startSaveDataToDB run!"),this.isSaveToDB){var e=this,t=this.saveInterval?this.saveInterval:this.defauleSaveInterval;if(this.saveToDBJob=new v(t,function(){e.saveDataToDB(e)},null,!0,"Asia/Shanghai"),this.saveToDBJob)return!0}return!1},stopSaveDataToDB:function(){var e=this.saveToDBJob;e&&(e.stop(),e=null)},release:function(){this.channel=!1,this.state="0"}}),General.Acquisition.Protocol=Ft,General.Acquisition.SmokeSensorProtocol={};var qt=function(e){this._name="SmokeSensorProtocol",this.init(e),this.pointIntervalTime=2,this.alarmIntervalTime=5};_.extend(qt,Ft,{processData:function(e,t){var i=this,o=i.pointIntervalTime,a=i.alarmIntervalTime,r=e.terminals,s=e.reqObj,l=t.getData,u=t.sendData;this.runDataJob=new v("*/"+o+" * * * * *",function(){for(var e=0;e<r.length;e++){for(var o=r[e],t=o.bos,a=[],n=0;n<t.length;n++)a.push(t[n].id);l({reqObj:s,callFun:"getPoint",args:{arg0:a}},function(e){if(e){var t=i.parseData(e);o.saveDataToMemory(t)}}),u(null)}},null,!0,"Asia/Shanghai"),this.alarmDataJob=new v("*/"+a+" * * * * *",function(){for(var e=0;e<r.length;e++){var o=r[e];l({reqObj:s,callFun:"getAlarm",args:{}},function(e){if(e){var t=i.parseAlarmData(e);o.saveDataToMemory(t)}}),u(null)}},null,!0,"Asia/Shanghai")},parseData:function(e){var t=[];e=JSON.parse(e);for(var o=0;o<e.length;o++){var a=e[o],n={},i=this.splitTerminalAndBOId(a.id);n.id=a.id,n.boId=i.boId,n.terminalId=i.terminalId,n.state=a.state,n.baseBatteryLevel=a.analog1,n.probeBatteryLevel=a.analog2,n.signalIntensity=a.analog3,n.collectTime=_.formatDate(new Date,"yyyy-MM-dd hh:mm"),n.type="runData",t.push(n)}return t},splitTerminalAndBOId:function(e){var t=e.indexOf("_");return{terminalId:e.substring(0,t),boId:e.substring(t+1,e.length)}},parseAlarmData:function(e){var t=[];e=JSON.parse(e);for(var o=0;o<e.length;o++){var a=e[o],n={},i=this.splitTerminalAndBOId(a.id);n.id=a.id,n.boId=i.boId,n.terminalId=i.terminalId,n.statusType=a.statusType,n.alarmContext=a.context,n.collectTime=new Date,n.type="alarmData",t.push(n)}return t}}),General.Acquisition.SmokeSensorProtocol=qt;var Ct=function(e){this._name="restProtocol",this.init(e),this.pointIntervalTime=2e3,this.alarmIntervalTime=5e3;this.startSaveDataToDB()};_.extend(Ct,Ft,{receive:function(e,t){if(e){var o=e.data,a=e.bo,n=a.filterCallback,i=this.parseData(o,n),r=o.reqUrl;this.saveDataToMemory(a,{reqUrl:r,formatedData:i})}},parseData:function(e,t){var o=e.reqParams,a=e.cltData,n=[],i=JSON.parse(a);t&&(i=t(i));for(var r=0;r<i.length;r++){var s=i[r];Object.keys(o).forEach(function(e){s[e]=o[e]}),n.push(s)}return n},saveDataToMemory:function(e,t){e.terminalId;var o="resturl_"+e.id,a=JSON.stringify({isSaved:!1,data:t.formatedData});Rt.set(o,a),Rt.publish("restNewFormatData",a)},parseMemoryToDBFormat:function(e){e.type,e.data},startSaveDataToDB:function(){var e=this;this.saveToDBJob=new v("*/5 * */1 * * *",function(){e.saveDataToDB(e)},null,!0,"Asia/Shanghai")},jsonSort:function(e,o,t){return e.length<2||!o||"object"!=typeof e[0]||("number"==typeof e[0][o]&&e.sort(function(e,t){return e[o]-t[o]}),t&&e.reverse()),e},saveDataToDB:function(e){for(var t=e.terminals,o=0;o<t.length;o++)for(var a=t[o],n=(a.id,a.bos),i=0;i<n.length;i++){var r=n[i],s=r.id,u=r.historyTable;if(u){var c="resturl_"+s;Rt.get(c,function(e,t){var o=JSON.parse(t);if(o&&!o.isSaved){for(var a="insert into "+u+" (",n={},i=o.data,r=0;r<i.length;r++){var s=i[r],l=",(";0===r?(Object.keys(s).forEach(function(e){a+="`"+e+"`,";var t=e+r;n[t]=s[e],l+=":"+t+","}),a=a.substring(0,a.length-1)+") values ",l=l.substring(1,l.length-1)+")"):(Object.keys(s).forEach(function(e){var t=e+r;n[t]=s[e],l+=":"+t+","}),l=l.substring(0,l.length-1)+")"),a+=l}g.insertFromSql(a,n,function(e){o.isSaved=!0,Rt.set(c,JSON.stringify(o)),console.log("SCCESS: insert into "+u+": "+JSON.stringify(o))},function(e){console.log("ERROR: insert into "+u+": "+JSON.stringify(e))})}})}}},stopSaveDataToDB:function(){this.saveToDBJob.stop()}}),General.Acquisition.RestProtocol=Ct,General.Acquisition.AnalogProtocol={};var Ot=function(e){this._name="AnalogProtocol",this.init(e),this.pointIntervalTime=2e3,this.alarmIntervalTime=5e3;this.startSaveDataToDB()};_.extend(Ot,Ft,{receive:function(e){var t=e.type,o=e.collectedData,a=e.terminalId;if(t&&0<o.length){var n=null;"run"===t?n=this.parseData(o):"alarm"===t&&(n=this.parseAlarmData(o)),this.saveDataToMemory(a,{type:t,formatedData:n})}},parseData:function(e){var t=[];e=JSON.parse(e);for(var o=0;o<e.length;o++){var a=e[o],n={};n.id=a.id,n.boId=a.id,n.terminalId=a.terminal,n.state=a.state,n.baseBatteryLevel=a.analog1,n.probeBatteryLevel=a.analog2,n.signalIntensity=a.analog3,n.collectTime=_.formatDate(new Date,"yyyy-MM-dd hh:mm"),n.type="runData",t.push(n)}return t},splitTerminalAndBOId:function(e){var t=e.indexOf("_");return{terminalId:e.substring(0,t),boId:e.substring(t+1,e.length)}},parseAlarmData:function(e){var t=[];e=JSON.parse(e);for(var o=0;o<e.length;o++){var a=e[o],n={};n.id=a.id,n.boId=a.id,n.terminalId=a.terminal,n.statusType=a.statusType,n.alarmContext=a.context,n.type="alarmData",t.push(n)}return[{boId:"alarmData",alarmInfo:t,collectTime:new Date}]},saveDataToMemory:function(e,a){var t=a.type,n="run_"+e;"alarm"===t&&(n="alarm_"+e),Rt.get(n,function(e,t){JSON.parse(t);var o=JSON.stringify(a);Rt.set(n,o);Rt.publish("analogNewFormatData",o)})},startSaveDataToDB:function(){var e=this;this.saveToDBJob=new v("0 */5 * * * *",function(){e.saveDataToDB(e)},null,!0,"Asia/Shanghai")},saveDataToDB:function(s){for(var e=s.terminals,t=0;t<e.length;t++){var o=e[t].id;Rt.get("run_"+o,function(e,t){for(var o=JSON.parse(t),a=[],n=0;n<o.length;n++){var i=o[n],r={collecttime:i.collectTime,terminalid:i.terminalId,boid:i.boId,state:i.state,basebatterylevel:i.baseBatteryLevel,probebatterylevel:i.probeBatteryLevel,signalintensity:i.signalIntensity,createtime:new Date};a.push(r)}g.seq.transaction(function(e){return g.batchInsertWithTrans2("AcquisitionRunRecord",a,e)}).then(function(e){s.runDatasDatas={}}).catch(function(e){console.log("ERROR: insert into AcquisitionRunRecord: "+JSON.stringify(e))})}),Rt.get("alarm_"+o,function(e,t){for(var o=JSON.parse(t),a=[],n=0;n<o.length;n++){var i=o[n],r={collecttime:i.collectTime,terminalid:i.terminalId,boid:i.boId,statustype:i.statusType,alarmcontext:i.alarmContext,createtime:new Date};a.push(r)}g.seq.transaction(function(e){return g.batchInsertWithTrans2("AcquisitionAlarmRecord",a,e)}).then(function(e){s.runDatasDatas={}}).catch(function(e){console.log("ERROR: insert into AcquisitionAlarmRecord: "+JSON.stringify(e))})})}},stopSaveDataToDB:function(){this.saveToDBJob.stop()}}),General.Acquisition.AnalogProtocol=Ot,General.Acquisition.AnalogProtocolLangchao={};var xt=function(e){this._name="AnalogProtocolLangchao",this.init(e)};_.extend(xt,Ft,{receive:function(e){var t=e.type,o=e.collectedData,a=e.terminalId;t&&0<o.length&&this.saveDataToMemory(a,{type:t,formattedData:o})},parseData:function(e){for(var t=[],o=0;o<e.length;o++){var a=e[o];a.boId,a.data;t.push(a)}return t},saveDataToMemory:function(e,t){t.type;var o="Langchao_"+e,a=(JSON.parse(Rt.get(o)),JSON.stringify(t));Rt.set(o,a);Rt.publish("analogLangchaoData",a)}}),General.Acquisition.AnalogProtocolLangchao=xt,General.Acquisition.ProtocolFactory={};var Wt=function(){this._name="channelFactory"};_.extend(Wt,Object,{createProtocol:function(e){if(console.log("protocolFactory createProtocol run!"),e){var t=e.id;return new("SmokeSensor"===t?General.Acquisition.SmokeSensorProtocol:"Analog"===t?General.Acquisition.AnalogProtocol:"Rest"===t?General.Acquisition.RestProtocol:"AnalogLangchao"===t?General.Acquisition.AnalogProtocolLangchao:General.Acquisition.RestProtocol)(e)}return null}}),General.Acquisition.ProtocolFactory=new Wt,General.Acquisition.Communication={};var jt=function(e){this._name="Communication",this.init(e)};_.extend(jt,Object,{init:function(e){this.id=e.id?e.id:_.getGUID(13,24),this.connectState=!1,this.collectCrons=[]},bindChannel:function(e){this.channel=e,this.connectState=this.reConnect()},checkBindChannel:function(){var e=this.channel;return e&&e.protocol},createReceiveCronJob:function(){},startReceive:function(){return this.checkBindChannel()?(this.createReceiveCronJob(),!0):(console.log("ERROR: Communication start receive failed! Because the information of channel binding is illegal"),!1)},reConnect:function(){return!0},preStopCronJob:function(){},afterStopCronJob:function(){},release:function(){this.stopReceive(),this.channel=null},stopReceive:function(){this.preStopCronJob(),this.stopCronJob()&&console.log("There are some cron job stop failed!"),this.afterStopCronJob(),this.connectState=!1},stopCronJob:function(){for(var e=this.collectCrons,t=e.length,o=0;o<t;o++){var a=e[o];a&&a.stop()}return t<=o},receive:function(){},sendData:function(e){},isConnect:function(){return this.connectState}}),General.Acquisition.Communication=jt,General.Acquisition.AnalogComm={};var Pt=function(){this._name="AnalogCommunication",this.connectState=!1,this.alarmContext=["运行状态","火警","故障","底座电池","附属电池","拆卸","确认","输出"]};_.extend(Pt,jt,{setCommState:function(e){this.connectState=e},bindChannel:function(e){this.reConnect()},reConnect:function(){this.release(),this.setCommState(!0)},release:function(){this.isConnect()&&this.setCommState(!1)},randomNum:function(e){var t=(Math.random()*e).toString(),o=t.indexOf(".");return t=t.substring(0,o+3)},analogAndProcessRunData:function(e){for(var t=e.terminals,o=0;o<t.length;o++){var a={terminal:t[o],analogType:"run"},n=e.receive(a);e.channel.protocol.receive(n)}},analogAndProcessAlarmData:function(e){for(var t=e.terminals,o=0;o<t.length;o++){var a={terminal:t[o],analogType:"alarm"},n=e.receive(a);e.channel.protocol.receive(n)}},createReceiveCronJob:function(){var e=this;e.analogAndProcessRunData(e);var t=new v("*/3 * * * * *",function(){e.analogAndProcessRunData(e)},null,!0,"Asia/Shanghai");e.collectCrons.push(t),e.analogAndProcessAlarmData(e);var o=new v("*/5 * * * * *",function(){e.analogAndProcessAlarmData(e)},null,!0,"Asia/Shanghai");e.collectCrons.push(o)},receive:function(e){if(this.isConnect()){var t=e.analogType,o=e.terminal,a=o.id,n=o.bos,i={terminalId:a};if("run"===t){i.type="run";for(var r=[],s=0;s<n.length;s++){var l={id:n[s].id,terminal:a,state:Math.round(Math.random()).toString(),analog1:this.randomNum(11),analog2:this.randomNum(12),analog3:this.randomNum(55),collectTime:_.formatDate(new Date,"yyyy-MM-dd hh:mm")};r.push(l)}i.collectedData=JSON.stringify(r)}else if("alarm"===t){i.type="alarm";var u=n.length,c=[],d=Math.floor(Math.random()*(u/2));for(s=0;s<d;s++)c.push(Math.floor(Math.random()*u));for(var f=[],h=0;h<c.length;h++){var m=n[c[h]],g=Math.ceil(Math.random()*(this.alarmContext.length-1)),p={id:m.id,terminal:a,statusType:g.toString(),context:this.alarmContext[g],collectTime:_.formatDate(new Date,"yyyy-MM-dd hh:mm")};f.push(p)}i.collectedData=JSON.stringify(f)}return i}return console.log("connect is break!"),this.connectState=!1,null},sendData:function(e){},isConnect:function(){return this.connectState}}),General.Acquisition.AnalogComm=Pt;var Lt=require("soap"),Bt=function(){this._name="SoapCommunication"};_.extend(Bt,jt,{setClientCommn:function(e){e?(this.cllient=e,this.connectState=!0):(this.cllient=null,this.connectState=!1)},bindChannel:function(e){this.ip=e.adress,this.port=e.port,this.url=e.url,this.reConnect()},reConnect:function(){var o=this;o.release();var e={overrdeRootElement:{namespace:"xmlns:tns",xmlnsAttributes:[{name:"xmlns:ns",value:"http://"+o.ip+":"+o.port}]}},t=o.url;Lt.createClient(t,e,function(e,t){null!==e?console.log(e):o.setClientCommn(t)})},release:function(){this.isConnect()&&this.cllient.release()},receive:function(e,t){this.isConnect()?this.cllient[e](t,function(e,t){return null!==e&&console.log(e),t}):(console.log("connect is break!"),this.connectState=!1)},sendData:function(e){},isConnect:function(){return this.cllient&&this.connectState}}),General.Acquisition.SoapComm=Bt;var Ut=function(){this._name="RestCommunication",this.connectState=!1,this.cronJobs={}};_.extend(Ut,jt,{setCommState:function(e){this.connectState=e},bindChannel:function(e){this.reConnect()},reConnect:function(){this.release(),this.setCommState(!0)},release:function(){var t=this;t.isConnect()&&(Object.keys(t.cronJobs).forEach(function(e){t.cronJobs[e].stop()}),this.setCommState(!1))},_initRestProcess:function(e){var t=null;return e.username&&e.password&&(t="Basic "+new Buffer(e.username+":"+e.password).toString("base64")),{hostname:e.host,port:e.port,path:e.path,method:e.method,headers:{accept:"*/*","content-type":"application/atom+xml","accept-encoding":"gzip, deflate","accept-language":"en-US,en;q=0.9",authorization:t||null,"user-agent":"nodejs rest client"}}},generateCronExp:function(e){var t=null;return"hour"===e?t="0 0 */1 * * *":"day"===e?t="0 0 0 */1 * *":"month"===e?t="0 0 0 0 */1 *":"year"===e&&(t="0 0 0 0 0 */1"),t},receive:function(e){var o=this,u=e.protocol;if(this.isConnect()){var t=e.terminal,a=t.isInited,n=t.bos,i=n.length;if(a)for(var r=0;r<i;r++){var c=n[r],d=c.reqParams,s=c.cltSet;o.cronJobs[c.id]=new v(s,function(){var s=c.url,i="",l={};Object.keys(d).forEach(function(e){var t=d[e],o=t.type,a=t.value,n=t.notSave;"0"===o?i+="&"+e+"="+a:"1"===o?(a=_.formatDate(new Date,a),i+="&"+e+"="+a):"3"===o?(a=(new Date).getTime(),i+="&"+e+"="+a):"5"===o?i+="&"+e+"="+a.join("%2C"):"98"===o&&(a=_.formatDate(new Date,a)),!n&&(l[e]=a)}),-1===s.indexOf("?")?(i=i.substring(1,i.length),s=s+"?"+i):s+=i;var e=nt.request(s,function(e){e.setEncoding("utf8");var i=[],r=0;e.on("data",function(e){var t=new Buffer(e);i.push(t),r+=t.length}),e.on("end",function(){var e=null;switch(i.length){case 0:e=new Buffer(0);break;case 1:e=i[0];break;default:e=new Buffer(r);for(var t=0,o=0;o<i.length;o++){var a=i[o];a.copy(e,t),t+=a.length}}var n={reqUrl:s,reqParams:l,cltData:e.toString()};u&&u.receive({bo:c,data:n})})});e.on("error",function(e){console.log("problem with request: "+e.message),u&&u.receive(null,JSON.stringify(e))}),e.end()},null,!0,"Asia/Shanghai")}else{r=0;var f=0;o.initCronJobs=new v("*/2 * * * * *",function(){for(r=(r+=20)<n.length-1?r:n.length-1;f<=r;){var s=n[f],l=s.reqParams,e=s.url,t=nt.request(e,function(e){e.setEncoding("utf8");var i=[],r=0;e.on("data",function(e){var t=new Buffer(e);i.push(t),r+=t.length}),e.on("end",function(){var e=null;switch(i.length){case 0:e=new Buffer(0);break;case 1:e=i[0];break;default:e=new Buffer(r);for(var t=0,o=0;o<i.length;o++){var a=i[o];a.copy(e,t),t+=a.length}}var n={reqParams:l,cltData:e.toString()};console.log("collectedData: "+JSON.stringify(n)),""!==n.cltData&&u&&u.receive({bo:s,data:n})})});t.on("error",function(e){console.log("problem with request: "+e.message),u&&u.receive(null,JSON.stringify(e))}),t.end(),f++}r>=n.length-1&&o.initCronJobs.stop()},null,!0,"Asia/Shanghai")}}else{var l="connect is break!";console.log(l),this.connectState=!1,u&&u.receive(null,l)}},sendData:function(e){},isConnect:function(){return this.connectState}}),General.Acquisition.RestComm=Ut,General.Acquisition.AnalogCommLangchao={};var Jt=function(){this._name="AnalogCommunicationLangchao",_.callSuper(Jt,this,arguments),this.initOriginData()};_.extend(Jt,jt,{analogAndProcessData:function(e){for(var t=e.channel,o=t.terminals,a=0;a<o.length;a++){var n=o[a],i={terminal:n,analogType:n.id},r=e.receive(i);t.protocol.receive(r)}},createReceiveCronJob:function(){var e=this;e.analogAndProcessData(e);var t=new v("*/3 * * * * *",function(){e.analogAndProcessData(e)},null,!0,"Asia/Shanghai");e.collectCrons.push(t)},reConnect:function(){return!0},preStopCronJob:function(){},afterStopCronJob:function(){},initOriginData:function(){this.currentHotLine={telephone:7125,aiCity:1593,web:26,email:21},this.travelDevelopment={travelData:{"天下第一泉":{nowScore:1,hot:90,todayTicket:28054,humanTraffic:5382,time:"20180510111500"},"千佛山":{nowScore:2,hot:85,todayTicket:19317,humanTraffic:3568,time:"20180510111500"},"九如山瀑布群":{nowScore:3,hot:80,todayTicket:18363,humanTraffic:3019,time:"20180510111500"},"红叶谷":{nowScore:4,hot:80,todayTicket:10356,humanTraffic:2007,time:"20180510111500"},"金象山乐园":{nowScore:5,hot:85,todayTicket:9846,humanTraffic:2105,time:"20180510111500"},"植物园":{nowScore:6,hot:80,todayTicket:8763,humanTraffic:1875,time:"20180510111500"}},pointData:{"趵突泉":{imp:-.01,waterLevel:27.72},"黑虎泉":{imp:.02,waterLevel:27.69}}},this.roadMonitorStation=[{"趵突泉北路":[{longitude:117.01053142547607,latitude:36.67155131263001},{longitude:117.01053142547607,latitude:36.669176212623576},{longitude:117.01027393341064,latitude:36.667369022206444},{longitude:117.01061725616454,latitude:36.663875000398654}]},{"趵突泉南路":[{longitude:117.01056897640228,latitude:36.663728695532974},{longitude:117.01147556304933,latitude:36.6625109118898},{longitude:117.01169550418854,latitude:36.66205047277205},{longitude:117.01268792152405,latitude:36.65967938286511},{longitude:117.01285421848297,latitude:36.65971380937536},{longitude:117.01376616954802,latitude:36.65865949051471},{longitude:117.01387882232665,latitude:36.65732113026499},{longitude:117.01509118080138,latitude:36.65667991405593},{longitude:117.01582074165343,latitude:36.655401769170346},{longitude:117.01597094535828,latitude:36.655406072724084}]},{"北园大街-北园高架":[{longitude:116.93015098571777,latitude:36.68084447752839},{longitude:116.93633079528807,latitude:36.68170489897689},{longitude:116.94530010223389,latitude:36.682943888954284},{longitude:116.95147991180419,latitude:36.682943888954284},{longitude:116.97130680084227,latitude:36.68332246524438},{longitude:116.97825908660889,latitude:36.68335688117837},{longitude:116.98486804962158,latitude:36.68432052107744},{longitude:116.99349403381346,latitude:36.68432052107744},{longitude:116.99954509735106,latitude:36.68428610557466},{longitude:117.00915813446045,latitude:36.68428610557466},{longitude:117.01177597045898,latitude:36.68428610557466},{longitude:117.02057361602782,latitude:36.68473350590968},{longitude:117.0377826690674,latitude:36.68903529938295},{longitude:117.0466661453247,latitude:36.69323361777366},{longitude:117.05559253692627,latitude:36.70083818456676},{longitude:117.06074237823485,latitude:36.70338434198518},{longitude:117.06932544708253,latitude:36.70761628189128},{longitude:117.07417488098145,latitude:36.709542941557515},{longitude:117.08975315093996,latitude:36.71570104757726},{longitude:117.10837841033936,latitude:36.71807471083366},{longitude:117.13228225708006,latitude:36.719657112258105},{longitude:117.14017868041991,latitude:36.719897909617195},{longitude:117.14850425720215,latitude:36.720345102709906},{longitude:117.16180801391602,latitude:36.72024190453496},{longitude:117.17159271240234,latitude:36.72072349483175}]},{"工业南路":[{longitude:117.06756591796875,latitude:36.66724854133638},{longitude:117.07220077514648,latitude:36.67089730689858},{longitude:117.07451820373534,latitude:36.67186110287849},{longitude:117.07889556884766,latitude:36.67378865862268},{longitude:117.09091186523436,latitude:36.676060358757155},{longitude:117.09837913513184,latitude:36.67743711407294},{longitude:117.10370063781738,latitude:36.678538500586306},{longitude:117.10670471191405,latitude:36.67908918792989},{longitude:116.99954509735106,latitude:36.68428610557466},{longitude:117.11545944213867,latitude:36.680947728610384},{longitude:117.117862701416,latitude:36.68191139869241},{longitude:117.12387084960936,latitude:36.68493999749423},{longitude:117.13013648986816,latitude:36.68783082146575},{longitude:117.13202476501465,latitude:36.688656751213266},{longitude:117.14120864868164,latitude:36.693268029272325},{longitude:117.14232444763182,latitude:36.69368096605504}]},{"花园路":[{longitude:117.04198837280273,latitude:36.68015613343993},{longitude:117.04885482788085,latitude:36.68173931563465},{longitude:117.05203056335448,latitude:36.6823243964603},{longitude:117.05507755279541,latitude:36.682875056701356},{longitude:117.05984115600586,latitude:36.68397636535661},{longitude:117.0666217803955,latitude:36.68493999749423},{longitude:117.07842350006102,latitude:36.688278201180104},{longitude:117.08627700805663,latitude:36.68941384568916},{longitude:117.09074020385742,latitude:36.690067694010764},{longitude:117.09254264831543,latitude:36.69137537397504}]},{"经十路":[{longitude:116.96455836296082,latitude:36.64870945210706},{longitude:116.9688928127289,latitude:36.648657804955},{longitude:116.97281956672668,latitude:36.648390960784305},{longitude:116.9750940799713,latitude:36.64833070552102},{longitude:116.97502970695496,latitude:36.64859754990049},{longitude:116.97858095169067,latitude:36.64855451054701},{longitude:116.98025465011598,latitude:36.648296273920835},{longitude:116.98039412498474,latitude:36.64852007904687},{longitude:116.98167085647583,latitude:36.648296273920835},{longitude:116.98472857475281,latitude:36.64844260811532},{longitude:116.9894814491272,latitude:36.6484340002292}]}],this.taxiRouteDBIndex=0,this.getTaxiRouteRandomData(),this.medicalHygiene={totalBedQty:521192,medicalIns:6521,doctorQty:27262,nurseQty:31569,treatmentNum:5469.1,treatmentNumImp:2.7,inHospital:146.4,inHospitalImp:16.7,avgPayPerson:54.5,expenses:{inspectionCost:19.27,treatmentCost:9.18,registrationCost:9.17,drugCost:45.87,other:16.51}}},getTaxiRouteRandomData:function(){var i=this,r={},s=[];r.type="taxiRoute";g.queryFromSql("select * from clt_ptvlocation_histories where clt_time in  (select * from  (select clt_time from clt_ptvlocation_histories group by clt_time order by floor(rand() * 200)  limit 0,1) ct);",{},function(e){for(var t={boId:"taxiRoute"},o=[],a=0;a<4;a++){var n=e[a];o.push({taxiId:n.vehicleNumber,latitude:n.latitude,longitude:n.longitude,pm10:n.pm10,pm25:n.pm25})}t.data=o,s.push(t),r.collectedData=s,i.taxiRoute=r},function(e){console.log("ERROR: "+JSON.stringify(e))})},randomNum:function(e){var t=(Math.random()*e).toString(),o=t.indexOf(".");return t=t.substring(0,o+3)},randomNumWithRange:function(e,t){var o=t-e,a=Math.random();return e+Math.round(a*o)},randomFloatNumWithRange:function(e,t,o){var a=t-e;return(e+Math.random()*a).toFixed(o)},randomFloatNumWithPN:function(){var e=Math.random(),t=Math.random();return.5<e&&(t=-t),t},receive:function(e){var n=this;if(this.isConnect()){var t=e.analogType,o=e.terminal,a=o.id,i=(o.bos,{terminalId:a}),r=[];if("74CityRanking"===t)r=[{boId:i.type="74CityRanking",data:[{citycode:"370100",sortIndex:11,startTime:"201801"},{citycode:"370100",sortIndex:15,startTime:"201802"},{citycode:"370100",sortIndex:22,startTime:"201803"},{citycode:"370100",sortIndex:13,startTime:"201804"},{citycode:"370100",sortIndex:16,startTime:"201805"},{citycode:"370100",sortIndex:17,startTime:"201806"},{citycode:"370100",sortIndex:8,startTime:"201807"}],dayIndex:"12",monthIndex:"3",yearIndex:"8"}];else if("28CityRanking"===t)r=[{boId:i.type="28CityRanking",data:[{citycode:"370100",sortIndex:11,startTime:"201801"},{citycode:"370100",sortIndex:15,startTime:"201802"},{citycode:"370100",sortIndex:22,startTime:"201803"},{citycode:"370100",sortIndex:13,startTime:"201804"},{citycode:"370100",sortIndex:16,startTime:"201805"},{citycode:"370100",sortIndex:17,startTime:"201806"},{citycode:"370100",sortIndex:8,startTime:"201807"}],dayIndex:"4",monthIndex:"6",yearIndex:"2"}];else if("AQIInfomation"===t)r=[{boId:i.type="AQIInfomation",data:[{AQI:n.randomNumWithRange(10,50),PM25:n.randomNumWithRange(5,40),PM10:n.randomNumWithRange(5,20),CO:Math.random().toFixed(1),NO2:n.randomNumWithRange(5,50),O3:n.randomNumWithRange(50,100),SO2:n.randomNumWithRange(3,15),publishTime:_.formatDate(new Date,"hh:mm"),goodDay:162,monitorDayPercent:"49.2%",continueGoodDay:29,badDay:18,continueBadDay:-16,urbanFogDay:180,urbanFogDayPercent:"49.2%"}]}];else if("QXAirAIQRanking-One"===t)r=[{boId:i.type="QXAirAIQRanking-One",data:[{boId:"历下区",name:"历下区",totalScore:1,totalScoreCompare:0,nowScore:4,betterScore:1},{boId:"长清区",name:"长清区",totalScore:2,totalScoreCompare:3,nowScore:2,betterScore:5},{boId:"市中区",name:"市中区",totalScore:3,totalScoreCompare:0,nowScore:3,betterScore:4},{boId:"高新区",name:"高新区",totalScore:4,totalScoreCompare:-2,nowScore:1,betterScore:6},{boId:"天桥区",name:"天桥区",totalScore:5,totalScoreCompare:-1,nowScore:5,betterScore:2},{boId:"历城区",name:"历城区",totalScore:6,totalScoreCompare:1,nowScore:6,betterScore:3},{boId:"槐荫区",name:"槐荫区",totalScore:7,totalScoreCompare:-1,nowScore:7,betterScore:7}]}];else if("QXAirAIQRanking-Two"===t)r=[{boId:i.type="QXAirAIQRanking-Two",data:[{boId:"商河县",name:"商河县",totalScore:1,totalScoreCompare:0,nowScore:1,betterScore:1},{boId:"章丘区",name:"章丘区",totalScore:2,totalScoreCompare:0,nowScore:2,betterScore:2},{boId:"济阳县",name:"济阳县",totalScore:3,totalScoreCompare:1,nowScore:3,betterScore:4},{boId:"平阴县",name:"平阴县",totalScore:4,totalScoreCompare:-1,nowScore:4,betterScore:3}]}];else if("AEQuality"===t)r=[{boId:i.type="AEQuality",data:[{traffic:n.randomFloatNumWithRange(35,89,1),build:n.randomFloatNumWithRange(35,89,1),life:n.randomFloatNumWithRange(35,89,1)}],cltTime:_.formatDate(new Date,"yyyy-MM-dd hh:mm")}];else if("QXAirPollutionRanking"===t)r=[{boId:i.type="QXAirPollutionRanking",data:[{boId:"商河县-韩庙镇",county:"商河县",town:"韩庙镇",nowScore:1,pm10:n.randomNumWithRange(150,200),pm25:n.randomNumWithRange(50,90)},{boId:"南山区-西营镇",county:"南山区",town:"西营镇",nowScore:2,pm10:n.randomNumWithRange(70,150),pm25:n.randomNumWithRange(30,60)},{boId:"长清区-万德街道办事处",county:"长清区",town:"万德街道办事处",nowScore:3,pm10:n.randomNumWithRange(40,70),pm25:n.randomNumWithRange(20,50)}]}];else if("RoadAirPollutionRanking"===t){i.type="RoadAirPollutionRanking";var s=this.roadMonitorStation,l=[];boData={boId:"RoadAirPollutionRanking"};for(var u=0;u<6;u++){var c=s[u];for(var d in c){for(var f=c[d],h={boId:d+"-地址",road:d,nowScore:u+1,address:"地址"},m=[],g=f.length,p=0,v=0,y=0;y<g;y++){var w=f[y],S=n.randomNumWithRange(10,200),b=n.randomNumWithRange(10,60);p+=S,v+=b;var A=b/100;1<A&&(A=1),m.push({latitude:w.latitude,longitude:w.longitude,pm10:S,pm25:b,value:A})}h.monitorStation=m,h.pm10=p/g,h.pm25=v/g,l.push(h)}}boData.data=l,r.push(boData)}else if("taxiRoute"===t){var I=n.taxiRoute;I&&(i.type=I.type,r=I.collectedData),this.getTaxiRouteRandomData()}else if("RiverWaterQuality"===t){i.type="RiverWaterQuality";var k=(new Date).getHours();r=[{boId:"RiverWaterQuality",data:[{boId:"小清河-开都河",river:"小清河",reach:"开都河",grade:"Ⅱ",status:"正常",CODCr:n.randomFloatNumWithRange(1,5,3),NH3_N:n.randomFloatNumWithRange(0,.25,2),time:k,videoUrl:""},{boId:"小清河-巨野河",river:"小清河",reach:"巨野河",grade:"Ⅲ",status:"警告",CODCr:n.randomFloatNumWithRange(5.4,6.8,3),NH3_N:n.randomFloatNumWithRange(.26,.34,2),time:k,videoUrl:""},{boId:"小清河-辛丰庄",river:"小清河",reach:"辛丰庄",grade:"Ⅴ",status:"异常",CODCr:n.randomFloatNumWithRange(6.9,10,3),NH3_N:n.randomFloatNumWithRange(.35,.6,2),time:k,videoUrl:""},{boId:"小清河-章齐河",river:"小清河",reach:"章齐河",grade:"Ⅱ",status:"正常",CODCr:n.randomFloatNumWithRange(1,5,3),NH3_N:n.randomFloatNumWithRange(0,.25,2),time:k,videoUrl:""},{boId:"小清河-京福路桥",river:"小清河",reach:"京福路桥",grade:"Ⅱ",status:"正常",CODCr:n.randomFloatNumWithRange(1,5,3),NH3_N:n.randomFloatNumWithRange(0,.25,2),time:k,videoUrl:""},{boId:"小清河-洪园闸",river:"小清河",reach:"洪园闸",grade:"Ⅲ",status:"警告",CODCr:n.randomFloatNumWithRange(5.4,6.8,3),NH3_N:n.randomFloatNumWithRange(.26,.34,2),time:k,videoUrl:""},{boId:"小清河-监测站1",river:"小清河",reach:"监测站1",grade:"Ⅱ",status:"正常",CODCr:n.randomFloatNumWithRange(1,5,3),NH3_N:n.randomFloatNumWithRange(0,.25,2),time:k,videoUrl:""},{boId:"小清河-监测站2",river:"小清河",reach:"监测站2",grade:"Ⅱ",status:"正常",CODCr:n.randomFloatNumWithRange(1,5,3),NH3_N:n.randomFloatNumWithRange(0,.25,2),time:k,videoUrl:""},{boId:"小清河-监测站3",river:"小清河",reach:"监测站3",grade:"Ⅱ",status:"正常",CODCr:n.randomFloatNumWithRange(1,5,3),NH3_N:n.randomFloatNumWithRange(0,.25,2),time:k,videoUrl:""}]}]}else if("DrinkingWaterSource"===t){r=[{boId:i.type="DrinkingWaterSource",data:[{boId:"卧龙山水库",waterSource:"卧龙山水库",waterQuality:"Ⅱ",status:"正常",CODCr:n.randomFloatNumWithRange(1,10,3),NH3_N:n.randomFloatNumWithRange(0,1.1,2),PH:n.randomFloatNumWithRange(5,9,2)},{boId:"锦绣川水库",waterSource:"锦绣川水库",waterQuality:"Ⅱ",status:"正常",CODCr:n.randomFloatNumWithRange(1,10,3),NH3_N:n.randomFloatNumWithRange(0,1.1,2),PH:n.randomFloatNumWithRange(5,9,2)},{boId:"玉清湖水库",waterSource:"玉清湖水库",waterQuality:"Ⅱ",status:"正常",CODCr:n.randomFloatNumWithRange(1,10,3),NH3_N:n.randomFloatNumWithRange(0,1.1,2),PH:n.randomFloatNumWithRange(5,9,2)},{boId:"鹊山水库",waterSource:"鹊山水库",waterQuality:"Ⅱ",status:"正常",CODCr:n.randomFloatNumWithRange(1,10,3),NH3_N:n.randomFloatNumWithRange(0,1.1,2),PH:n.randomFloatNumWithRange(5,9,2)}]}]}else if("EnterpriseWasteGas"===t){var T=_.formatDate(new Date,"hh:mm:ss");r=[{boId:i.type="EnterpriseWasteGas",data:[{CODCr:{detectionValue:n.randomFloatNumWithRange(20,200,1),standard:50,cltTime:T},smoke:{detectionValue:n.randomFloatNumWithRange(0,1.1,1),standard:50,cltTime:T}}]}]}else if("EnterpriseWasteWater"===t){T=_.formatDate(new Date,"hh:mm:ss");r=[{boId:i.type="EnterpriseWasteWater",data:[{CODCr:{detectionValue:n.randomFloatNumWithRange(20,200,1),standard:50,cltTime:T},NH3_N:{detectionValue:n.randomFloatNumWithRange(0,1.1,1),standard:50,cltTime:T}}]}]}else if("hotline"===t){i.type="hotline";var M=n.currentHotLine;r=[{boId:"hotline",data:[{telephone:M.telephone+n.randomNumWithRange(1,50),aiCity:M.aiCity+n.randomNumWithRange(1,20),web:M.web+n.randomNumWithRange(1,10),email:M.email+n.randomNumWithRange(1,4)}]}]}else if("Economic"===t)r=[{boId:i.type="Economic",data:[{total:"7201.96亿元",cityRanking:10,innerCityRanking:3,impGDP:"8.0%"}]}];else if("CityDevelopment"===t)r=[{boId:i.type="CityDevelopment",data:[{industrial:{first:{name:"第一产业",value:"317.4",imp:3.8},second:{name:"第二产业",value:"2569.22",imp:8.4},third:{name:"第三产业",value:"4315.34",imp:8.2}},population:{nativePeople:651.369,flushPeopele:84.4881,birthRate:14.61,mortalityRate:6.27,familyQty:65.74,impNative:8.34,maleFemaleRatio:[1e3,917]}}]}];else if("TravelDevelopment"===t){i.type="TravelDevelopment";var D=this.travelDevelopment.travelData,N=this.travelDevelopment.pointData,E=_.formatDate(new Date,"yyyyMMddhhmmss");Object.keys(D).forEach(function(e){var t=D[e];t.todayTicket=t.todayTicket+n.randomNumWithRange(0,5),t.humanTraffic=t.humanTraffic+Math.floor(10*n.randomFloatNumWithPN()),D[e]=t}),Object.keys(N).forEach(function(e){var t=N[e],o=parseFloat(t.waterLevel),a=(o+n.randomFloatNumWithPN()).toFixed(2);t.waterLevel=a,t.imp=Math.round((o-a)/o*1e4)/100+"%",N[e]=t}),r=[{boId:"TravelDevelopment",data:[{travelData:[{name:"天下第一泉",nowScore:1,hot:90,todayTicket:D["天下第一泉"].todayTicket,humanTraffic:D["天下第一泉"].humanTraffic,time:E},{name:"千佛山",nowScore:2,hot:70,todayTicket:D["千佛山"].todayTicket,humanTraffic:D["千佛山"].humanTraffic,time:E},{name:"九如山瀑布群",nowScore:3,hot:45,todayTicket:D["九如山瀑布群"].todayTicket,humanTraffic:D["九如山瀑布群"].humanTraffic,time:E}],pointData:[{pointName:"趵突泉",imp:N["趵突泉"].imp,waterLevel:N["趵突泉"].waterLevel},{pointName:"黑虎泉",imp:N["黑虎泉"].imp,waterLevel:N["黑虎泉"].waterLevel}]}]}]}else if("MedicalHygiene"===t){i.type="MedicalHygiene";var R=this.medicalHygiene;R.treatmentNum=(10*R.treatmentNum+1)/10,R.treatmentNumImp=Math.floor(10*(R.treatmentNumImp+n.randomFloatNumWithPN()))/10,(20<R.treatmentNumImp||R.treatmentNumImp<-20)&&(R.treatmentNumImp=2.7),R.inHospital=(10*R.inHospital+1)/10,R.inHospitalImp=Math.floor(10*(R.inHospitalImp+n.randomFloatNumWithPN()))/10,(30<R.inHospitalImp||R.inHospitalImp<-30)&&(R.inHospitalImp=16.7),r=[{boId:"MedicalHygiene",data:[{totalBedQty:521192,medicalIns:6521,doctorQty:27262,nurseQty:31569,treatmentNum:R.treatmentNum,treatmentNumImp:R.treatmentNumImp,inHospital:R.inHospital,inHospitalImp:R.inHospitalImp,avgPayPerson:54.5,expenses:{inspectionCost:19.27,treatmentCost:9.18,registrationCost:9.17,drugCost:45.87,other:16.51}}]}]}else"CityWater"===t?r=[{boId:i.type="CityWater",data:[{boId:"锦绣川",name:"锦绣川",level:"232.16"},{boId:"小清河",name:"小清河",level:"20.77"},{boId:"钓鱼台",name:"钓鱼台",level:"126.2"},{boId:"卧虎山",name:"卧虎山",level:"123.79"},{boId:"郎猫山",name:"郎猫山",level:"166.98"}]}]:"CulturalEducation"===t&&(r=[{boId:i.type="CulturalEducation",data:[{campus:{schoolNum:43,studentNum:558e3,teacherNum:43e3},high:{schoolNum:151,studentNum:112800,teacherNum:67e3},junior:{schoolNum:176,studentNum:185600,teacherNum:115e3},primary:{schoolNum:1653,studentNum:432300,teacherNum:43e3},nursery:{schoolNum:1517,studentNum:153e3,teacherNum:181500}}]}]);return i.collectedData=r,i}return console.log("connect is break!"),this.connectState=!1,null},sendData:function(e){}}),General.Acquisition.AnalogCommLangchao=Jt;var zt=General.Acquisition.Communication,Vt=General.Acquisition.SoapComm,Qt=General.Acquisition.AnalogComm,Ht=General.Acquisition.AnalogCommLangchao,Kt=General.Acquisition.RestComm,Yt=function(){this._name="CommunicationFactory"};_.extend(Yt,Object,{getCommunication:function(e){if(console.log("CommunicationFactory getCommunication run!"),e){var t=e.commtype;return"soap"===t?new Vt(e):"analog"===t?new Qt(e):"rest"===t?new Kt(e):"analogLangchao"===t?new Ht(e):new zt(e)}return null}}),General.Acquisition.CommFactory=new Yt;General.Acquisition.OrderManagement;var Xt=function(e){this._name="businessobject",this.runDatas={},this.alarmDatas={},this.init(e)};_.extend(Xt,Object,{init:function(t){var o=this;Object.keys(t).forEach(function(e){o[e]=t[e]})}}),General.Acquisition.BusinssObject=Xt,General.Acquisition.Terminal={};var $t=function(e){this._name="terminal",this.runDatas=[],this.alarmDatas=[],this.init(e)};_.extend($t,Object,{init:function(t){var o=this;this.id=t.id,Object.keys(t).forEach(function(e){o[e]=t[e]});var e=t.bos;if(e){var a=e.length;this.bos=[];for(var n=0;n<a;n++){var i=new Xt(e[n]);this.bos.push(i)}}}}),General.Acquisition.Terminal=$t;var Zt=General.Acquisition.CommFactory,eo=function(e){this._name="channel",this.init(e)};_.extend(eo,Object,{init:function(e){console.log("channel init run!"),e&&(this.id=e.id?e.id:_.getGUID(10,26),this.comm=this.initComm(e.commtype),this.terminals=this.initTerminals(e.terminals),this.state="0",this.ip=e.ip,this.port=e.port,this.url=e.url)},initComm:function(e){return Zt.getCommunication({commtype:e})},initTerminals:function(e){var t=[];if(e)for(var o=0;o<e.length;o++){var a=new $t(e[o]);t.push(a)}return t},startWork:function(){console.log("channel startWork run!"),this.buildChannelsCommunication(),this.state="1"},stopWork:function(){console.log("channel stopWork run!"),"1"===this.state?this.comm.stopReceive():console.log("Stop Error: channel: "+this.id+" is not running!")},release:function(){console.log("channel release run!"),"1"===this.state?(this.comm.release(),this.protocol.release()):console.log("ERROR: channel "+this.id+" release failed! channel: "+this.id+" is not running!")},buildChannelsCommunication:function(){console.log("channel buildChannelsCommunication run!"),this.protocol.bindChannel(this),this.comm.bindChannel(this),this.process()},process:function(){console.log("channel process run!"),this.comm.startReceive()},sendData:function(e){console.log("channel sendData run!"),this.comm.sendData(e)},setState:function(e){this.state=e},getState:function(){return this.state}}),General.Acquisition.Channel=eo;var to=function(e){this._name="SoapChannel",this.init(e),this.connectInfo={ip:e.ip,port:e.port,url:e.url}};_.extend(to,eo,{startWork:function(){console.log("channel startWork run!");this.buildChannelsCommunication()},buildChannelsCommunication:function(){console.log("soapChannel buildChannelsCommunication run!");var n=this,e={overrdeRootElement:{namespace:"xmlns:tns",xmlnsAttributes:[{name:"xmlns:ns",value:"http://"+n.connectInfo.ip+":"+n.connectInfo.port}]}},t=n.url;Lt.createClient(t,e,function(e,t){if(null!==e)console.log(e);else{var o={reqObj:n.reqObj=t,terminals:n.terminals},a={getData:n.getData,sendData:n.sendData};n.protocol.processData(o,a)}})},processChannelData:function(e,t){var o=this,a={callFun:"getPoint",args:e},n=t.getData,i=t.sendData;setTimeout(function(){n(a,function(e){var t=o.protocol.parseData(e);console.log("data: "+JSON.stringify(t))}),i(null),setTimeout(arguments.callee,5e3)},5e3);var r={callFun:"getAlarm",args:{}};setTimeout(function(){n(r,function(e){var t=o.protocol.parseAlarmData(e);console.log("data: "+JSON.stringify(t))}),i(null),setTimeout(arguments.callee,2e3)},2e3)},getData:function(e,o){var t=e.reqObj,a=e.callFun,n=e.args;t[a](n,function(e,t){null!==e&&console.log(e),o(t.return)})},sendData:function(e){}}),General.Acquisition.SoapChannel=to;var oo=function(e){this._name="AnalogChannel"};_.extend(oo,eo,{}),General.Acquisition.AnalogChannel=oo;var ao=function(e){this._name="RestChannel",this.init(e)};_.extend(ao,eo,{startWork:function(){console.log("analog channel startWork run!");this.protocol;this.buildChannelsCommunication()},collectData:function(e){for(var t=e.terminals,o=e.protocol,a=0;a<t.length;a++){var n={terminal:t[a],protocol:o};e.comm.receive(n)}},buildChannelsCommunication:function(){console.log("restChannel buildChannelsCommunication run!");this.comm.bindChannel(this),this.process()},process:function(){this.collectData(this)},releaseChannelsCommunication:function(){console.log("restChannel releaseChannelsCommunication run!"),this.comm.release()}}),General.Acquisition.RestChannel=ao;var no=function(e){this._name="AnalogChannelLangchao",this.init(e)};_.extend(no,eo,{startWork:function(){console.log("analog channel startWork run!");this.protocol;this.buildChannelsCommunication()},analogAndProcessData:function(e){for(var t=e.terminals,o=0;o<t.length;o++){var a=t[o],n={terminal:a,analogType:a.id},i=e.comm.receive(n);e.protocol.receive(i)}},buildChannelsCommunication:function(){console.log("AnalogChannelLangchao buildChannelsCommunication run!");this.comm.bindChannel(this),this.process()},process:function(){var e=this;e.analogAndProcessData(e),this.analogRunDataJob=new v("*/3 * * * * *",function(){e.analogAndProcessData(e)},null,!0,"Asia/Shanghai")},releaseChannelsCommunication:function(){console.log("AnalogChannelLangchao releaseChannelsCommunication run!"),this.analogRunDataJob.stop(),this.comm.release()}}),General.Acquisition.AnalogChannelLangchao=no;var io=function(){this._name="channelFactory"};_.extend(io,Object,{createChannel:function(e){if(console.log("channelFactory createChannel run!"),e){var t=e.commtype;return new("soap"===t?General.Acquisition.SoapChannel:"analog"===t?General.Acquisition.AnalogChannel:"rest"===t?General.Acquisition.RestChannel:"analogLangchao"===t?General.Acquisition.AnalogChannelLangchao:General.Acquisition.Channel)(e)}return null}}),General.Acquisition.ChannelFactory=new io;General.Acquisition.ChannelFactory;var ro=General.Acquisition.ProtocolFactory,so=function(e){this._name="acquisition",this.businessObjects={},this.connectChannels={},this.bodesc={},this.terminal=[],this.init(e)};_.extend(so,Object,{init:function(e){console.log("acquisition init run!"),this.id=e.id?e.id:"acq"+_.getGUID(9,25);var t=(this.config=e).channels,o=e.bodescs;this.initConnectChannels(t),this.initBODescs(o),this.initSettings(e.settings)},initSettings:function(e){this.settings=e},initBODescs:function(e){if(e)for(var t=e.length,o=0;o<t;o++){var a=e[o];a&&(this.bodesc[a.id]=a)}},initConnectChannels:function(e){if(console.log("acquisition initConnectChannels run!"),e)for(var t=e.length,o=0;o<t;o++){var a=e[o],n=this.initConnectChannel(a);n&&(n.protocol=ro.createProtocol({id:a.protocol,terminals:n.terminals}),n&&(this.connectChannels[n.id]=n))}},initConnectChannel:function(e){return e?new General.Acquisition.Channel(e):null},getAllChannels:function(){return this.connectChannels},getChannelsByIds:function(e){for(var t=this.connectChannels,o=[],a=0;a<e;a++){var n=t[e[a]];n&&o.push(n)}return o},startCollectData:function(){console.log("acquisition startCollectData run!");var t=this.connectChannels;Object.keys(t).forEach(function(e){t[e].startWork()})},stopCollectData:function(){var t=this.connectChannels;Object.keys(t).forEach(function(e){t[e].stopWork()})}}),General.Acquisition.Acquisition=so;var lo=require("xml2js"),uo=function(e){this._name="XmlAcquisition",this.businessObjects=[],this.connectChannels={},this.bodesc=[],this.terminal=[],this.init(e)};_.extend(uo,so,{init:function(e){var i=this,o=new lo.Parser;M.readFile(e.xmlFilePath,function(e,t){o.parseString(t,function(e,t){var o=t.system,a=(o.setttings,i.translateChannels(o.channels)),n=i.translateBos(o.businessobjects[0].bo);o.bodesc;i.initBOs(n),i.initConnectChannels(a),i.startCollectData()})})},translateBos:function(e){for(var t=[],o=0;o<e.length;o++){var a=e[o];t.push({id:a.id[0],terminalid:a.terminalid[0],type:a.type[0]})}return t},translateChannels:function(e){for(var t=[],o=0;o<e.length;o++){var a=e[o].channel[0];t.push({id:a.$.id,commtype:a.commtype[0],ip:a.ip[0],port:a.port[0],protocol:a.protocol[0],terminals:this.translateTerminals(a.terminals[0].terminal)})}return t},translateTerminals:function(e){for(var t=[],o=0;o<e.length;o++){var a=e[o];t.push({id:a.$.id})}return t},initBOs:function(e){console.log("xmlAcquisition initBOs run!");for(var t=e.length,o=0;o<t;o++){var a=this.initBO(e[o]);this.businessObjects.push(a)}},initBO:function(e){return{id:e.id,terminalId:e.terminalid,type:e.type}}}),General.Acquisition.XMLAcquisition=uo,General.Acquisition.AcquisitionFactory={};var co=function(){this._name="acquisitionFactory"};_.extend(co,Object,{createAcquisition:function(e){return console.log("acquisitionFactory createAcquisition run!"),e?"xml"===e.type?new uo(e):new so(e):null}}),General.Acquisition.AcquisitionFactory=new co;var fo=function(){_.callSuper(fo,this,arguments),this._name="acquisition",this.acquisitionFactory=General.Acquisition.AcquisitionFactory,this.acquisitions=[]};_.extend(fo,m,{runningOnPlatform:function(e){_.invokeSuper(fo,"runningOnPlatform",this,[e]);var t={bos:[],channels:[{id:"channel001",commtype:"analogLangchao",protocol:"AnalogLangchao",terminals:[{id:"74CityRanking"},{id:"28CityRanking"},{id:"AQIInfomation"},{id:"QXAirAIQRanking-One"},{id:"QXAirAIQRanking-Two"},{id:"AEQuality"},{id:"QXAirPollutionRanking"},{id:"RoadAirPollutionRanking"},{id:"taxiRoute"},{id:"RiverWaterQuality"},{id:"DrinkingWaterSource"},{id:"EnterpriseWasteGas"},{id:"EnterpriseWasteWater"},{id:"hotline"},{id:"Economic"},{id:"CityDevelopment"},{id:"TravelDevelopment"},{id:"MedicalHygiene"},{id:"CityWater"},{id:"CulturalEducation"},{id:"Evaluation"}]}],terminals:[]};this.createAcquisition(t).startCollectData();var o=this;setTimeout(function(){o.receiveOrderSubscribe()},5e3);var a={logid:_.getGUID(20),type:"runningOnPlatform",content:JSON.stringify({module:"acquisition"}),category:"1",operator:null,createtime:new Date,operatorip:"172.0.0.1",result:"SUCCESS"};d.fireEvent("log_addLogging",a),console.log(JSON.stringify(a))},getExports:function(){return["reqCreateAcquisition","reqStartCollectData","reqGetBoCollectProperty","subscribeOrderWithFilter","reqGetAllVehicleLocationHistoryData"]},reqCreateAcquisition:function(e,t,o){var a,n,i={action:"reqCreateAcquisition"},r=e.body.acquisitionConfig,s=this.acquisitionFactory.createAcquisition(r);this.acquisitions.push(s),a=null,n=s.id,a?(i.status=b.F,i.error=a):(i.status=b.S,i.result={data:n}),t.json(i)},reqStartCollectData:function(e,o,t){for(var a={action:"reqStartCollectData"},n=e.body.acquisitionId,i=function(e,t){e?(a.status=b.F,a.error=e):(a.status=b.S,a.result={data:t}),o.json(a)},r=null,s=0;s<this.acquisitions.length;s++){var l=this.acquisitions[s];l.id===n&&(r=l)}return r?r.startCollectData(acquisitionInfo,i):i("acquisitionId: "+n+"not existied!",null)},startAnalogCollectDataFromAsset:function(e,u){var c=this,t={aid:e.aid,categoryId:e.categoryId};this._platform.runModule("asset","getAssetList",[t,function(e,t){if(e)console.log("get asset collect failed: "+JSON.stringify(e)),u&&u(e,null);else if(t&&0<t.length){for(var o=[],a=[],n=0;n<t.length;n++){var i=t[n],r=i.modelId;o.push({id:i.assetId,terminalId:r,type:i.modelName});for(var s=0;s<a.length&&a[s].id!==r;s++);s===a.length&&a.push({id:r})}var l={bos:o,channels:[{id:"channel001",commtype:"analog",protocol:"Analog",terminals:a}],terminals:a};c.createAcquisition(l).startCollectData(),u&&u(null,1)}}])},checkAcquisitionExisted:function(e){for(var t=this.acquisitions,o=0;o<t.length;o++){var a=t[o];if(JSON.stringify(a.config)===JSON.stringify(e))return a}return!1},createAcquisition:function(e){var t=this.checkAcquisitionExisted(e);return t||(t=this.acquisitionFactory.createAcquisition(e),this.acquisitions.push(t)),t},startCollectData:function(e){for(var t=null,o=0;o<self.acquisitions.length;o++){var a=self.acquisitions[o];a.id===e&&(t=a)}return!!t&&(t.startCollectData(acquisitionInfo,callback),!0)},generateCategoryId:function(){return["AC01","ACLangchao"]},reqGetBoCollectProperty:function(e,y,t){var w={action:"reqGetBoCollectProperty"},o={},S=["collect_property"];return o.categoryId=this.generateCategoryId(),o.properties=S,this._platform.runModule("asset","getAssetListWithModelProperty",[o,function(e,t){if(e)w.status=b.F,w.error=e,y.json(w);else{var o={};if(t){for(var a={},n=t.assetList,i=0;i<n.length;i++){var r=n[i];a[r.assetId]={type:r.modelName,bid:r.assetName}}o.bos=a;for(var s={},l=t.modelList,u=0;u<l.length;u++){for(var c=l[u],d=[],f=0;f<S.length;f++){var h=c[S[f]];if(h){var m=JSON.parse(h);if(m instanceof Array)for(var g=0;g<m.length;g++){var p=m[g],v={id:p.id,name:p.name};d.push(v)}else v={id:m.id,name:m.name},d.push(v)}}s[c.modelName]=d}o.btypes=s}w.status=b.S,w.result=o,y.json(w)}}])},reqGetAllVehicleLocationHistoryData:function(e,t,o){var a={type:"reqGetAllVehicleLocationHistoryData"},n=e.body.filterInfo,i=n.vehicleNumber,r=n.vehicleId,s="select * from clt_ptvlocation_histories where 1 = 1 ",l={};r&&(s+=" and vehicleId = :VEHICLEID ",l.VEHICLEID=r),i&&(s+=" and vehicleNumber = :VEHICLENUMBER ",l.VEHICLENUMBER=i),g.queryFromSql(s,l,function(e){a.status=b.S,a.result={data:e},t.json(a)},function(e){a.status=b.F,a.error=e,t.json(a)})},getAllVehicleLocationRtData:function(t){g.queryFromSql("select * from clt_ptvlocation_histories where clt_time in  (select * from  (select clt_time from clt_ptvlocation_histories group by clt_time order by floor(rand() * 200)  limit 0,1) ct);",{},function(e){t&&t(null,e)},function(e){console.log("ERROR: "+JSON.stringify(e)),t&&t(e,null)})},getAllVehicleLocationHistoryData:function(e,t){var o=e.vehicleNumber,a=e.vehicleId,n="select * from clt_veliclelocation_histories where 1 = 1 ",i={};a&&(n+=" and vehicleId = :VEHICLEID ",i.VEHICLEID=a),o&&(n+=" and vehicleNumber = :VEHICLENUMBER ",i.VEHICLENUMBER=o),g.queryFromSql(n,i,function(e){t&&t(null,e)},function(e){console.log("ERROR: "+JSON.stringify(e)),t&&t(e,null)})},getAcquisitionDataByBOId:function(e,t,o){},getAcquisitionDataByTerminalId:function(e,t,o){},getHistoryDataByBOId:function(e,t,o){},getHistoryDataByTerminalId:function(e,t,o){},getOrderDataByOrderId:function(e,t,o){},subscribeOrderWithCollectPropertyFilter:function(s,l){var u=this,c=s.property,e=s.bos[0],d="collect_property",t={asset:{assetId:e},attrId:d};u._platform.runModule("asset","getModelAttrValueByAssetAndAttrId",[t,function(e,t){if(e)l&&l(e,null);else{var o=t;if(o){for(var r=null,a=JSON.parse(o[d]),n=0;n<a.length;n++){var i=a[n];if(i.name===c){r=i.id;break}}s.formatDataFunc=function(e){var t=e.data;if(0<t.length){var o=t[0],a=o[r];if(a){var n=o.boId+"_"+c,i={};return i[n]={sn:n,value:a},{results:{data:i}}}}return null},s.bos=[s.bos[0]+"_"+r],u.subscribeOrder(s)}else console.log("propertyId of return is empty!")}}])},getRiverPointDataWithClt:function(e,c){var t={categoryId:e.categoryId,isDetail:!0,aid:e.aid};this._platform.runModule("asset","getAssetList",[t,function(e,t){if(e)c&&c(e,null);else{var o=t.length;if(0<o){for(var u=[],a=[],n=0;n<o;n++){var i=t[n],r={assetId:i.assetId,name:i.assetName,latitude:i.configureInfo.latitude,longitude:i.configureInfo.longitude};u.push(r),a.push(r.name)}var s={id:"getRiverPointDataWithClt",bos:["RiverWaterQuality_data"],type:0,formatDataFunc:function(e){var t=e.data;if(t){var o=t.length;if(0<o){for(var a=0;a<o;a++)for(var n=t[a].data,i=0;i<n.length;i++)for(var r=n[i],s=r.river+"-"+r.reach,l=0;l<u.length;l++)s==u[l].name&&(u[l].NH3_N=r.NH3_N,u[l].CODCr=r.CODCr);return u}}return null},callback:function(e){c&&c(null,e)}},l=new Nt(s);General.Acquisition.OrderManagement.registerOrder(l)}else c(null,t)}}])},getRRoadAirPollutionDataWithClt:function(e,t){var o={id:"getRRoadAirPollutionDataWithClt",bos:["RoadAirPollutionRanking_data"],type:0,callback:function(e){t&&t(null,e)}},a=new Nt(o);General.Acquisition.OrderManagement.registerOrder(a)},subscribeOrder:function(o){var e={id:o.id,bos:o.bos,type:o.type,onlySendChange:o.onlySendChange,formatDataFunc:o.formatDataFunc,callback:function(e){if(e){var t={messageKey:o.id,content:encodeURI(JSON.stringify(e))};o.isSendObj&&(t.content=e),d.fireEvent("sendSocketMail",JSON.stringify(t),function(e){e&&console.log("事件消息发送失败: "+e)})}}},t=new Nt(e);return General.Acquisition.OrderManagement.registerOrder(t)},releaseOrder:function(e){for(var t=e.orderIds,o=0;o<t.length;o++)General.Acquisition.OrderManagement.releaseOrder(t[o]);var a={messageKey:e.id,content:encodeURI(JSON.stringify({code:"success",message:"释放成功！"}))};d.fireEvent("sendSocketMail",JSON.stringify(a),function(e){e&&console.log("事件消息发送失败: "+e)})},receiveOrderSubscribe:function(){var a=this;d.fireEvent("receiveSocketMail",function(e){e.on("text",function(e){var t=JSON.parse(e),o=t.messageKey;o&&"subscribeOrder"===o&&a.subscribeOrder(t.content),o&&"releaseOrder"===o&&a.releaseOrder(t.content)})})}}),General.Acquisition.Module=fo}(),exports.General=General;
